<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Farm Dashboard</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        const LIMIT_WORKER_URL = {{ limit_worker_url | tojson }} || "http://100.102.158.100:8001";
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            overflow: auto;
            min-height: 100vh;
            height: auto;
            margin: 0;
        }

        /* Allow copying/selection of any textual UI content */
        body,
        body * {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }

        /* Floating Window Styles */
        .floating-window {
            position: absolute;
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
            border: 1px solid #475569;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            min-width: 300px;
            min-height: 200px;
            transition: box-shadow 0.2s, transform 0.1s;
        }

        .floating-window.active {
            box-shadow: 0 25px 80px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }

        .floating-window.minimized {
            display: none;
        }

        .floating-window.maximized {
            left: 0 !important;
            top: 80px !important;
            width: 100% !important;
            height: calc(100vh - 130px) !important;
            border-radius: 0;
        }

        .window-titlebar {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            padding: 10px 14px;
            border-radius: 12px 12px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #1e293b;
            user-select: none !important;
        }

        .window-title {
            font-weight: 600;
            font-size: 14px;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: text;
            cursor: text;
        }

        .window-controls {
            display: flex;
            gap: 6px;
        }

        .window-controls button {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .window-controls button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .btn-minimize:hover {
            background: #3b82f6;
        }

        .btn-maximize:hover {
            background: #10b981;
        }

        .btn-refresh:hover {
            background: #f59e0b;
        }

        .btn-close:hover {
            background: #ef4444;
        }

        .window-content {
            flex: 1;
            overflow: auto;
            padding: 12px;
        }

        .live-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            grid-template-rows: auto;
            gap: 12px;
            align-content: start;
            grid-auto-rows: minmax(220px, 1fr);
        }

        .live-preview-header,
        .live-preview-empty {
            grid-column: 1 / -1;
        }

        .live-preview-tile {
            min-height: 220px;
        }

        .live-preview-image {
            object-fit: contain;
        }

        .limit-status-table th,
        .limit-status-table td {
            white-space: nowrap;
        }

        #window-profiles .window-content table th,
        #window-profiles .window-content table td,
        #window-limits .window-content table th,
        #window-limits .window-content table td {
            padding: 0.35rem 0.65rem;
        }

        @media (min-width: 1024px) {
            .live-preview-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }

        /* Resize Handles */
        .resize-handle {
            position: absolute;
            z-index: 10;
        }

        .resize-n {
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            cursor: n-resize;
        }

        .resize-s {
            bottom: 0;
            left: 0;
            right: 0;
            height: 5px;
            cursor: s-resize;
        }

        .resize-e {
            right: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: e-resize;
        }

        .resize-w {
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: w-resize;
        }

        .resize-ne {
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            cursor: ne-resize;
        }

        .resize-nw {
            top: 0;
            left: 0;
            width: 10px;
            height: 10px;
            cursor: nw-resize;
        }

        .resize-se {
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            cursor: se-resize;
        }

        .resize-sw {
            bottom: 0;
            left: 0;
            width: 10px;
            height: 10px;
            cursor: sw-resize;
        }

        /* Taskbar */
        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            border-top: 1px solid #334155;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 8px;
            z-index: 9999;
        }

        .taskbar-item {
            padding: 8px 16px;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .taskbar-item:hover {
            background: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }

        /* Top Stats Bar */
        .stats-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-bottom: 1px solid #475569;
            padding: 8px 16px;
            z-index: 9998;
        }

        /* Mobile specific stats bar overrides */
        @media (max-width: 768px) {
            .stats-bar {
                position: relative !important;
                /* Allow scrolling */
                z-index: 10;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #111827;
        }

        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        .log-box {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
        }

        /* ============================================
           MOBILE RESPONSIVE STYLES
           ============================================ */

        /* Mobile Accordion Mode */
        .mobile-accordion-header {
            display: none;
        }

        /* Touch-friendly buttons */
        @media (max-width: 768px) {
            .window-controls button {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }

            /* Fullscreen maximization on mobile */
            .floating-window.maximized {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                border-radius: 0 !important;
                z-index: 20000 !important;
                /* Ensure it covers everything */
                margin: 0 !important;
            }

            .floating-window {
                min-width: 100%;
                min-height: 150px;
                border-radius: 8px;
            }

            .window-titlebar {
                padding: 10px 12px;
                border-radius: 8px 8px 0 0;
            }

            .window-content {
                padding: 10px;
            }

            /* Hide resize handles on mobile */
            .resize-handle {
                display: none !important;
            }

            /* Taskbar adjustments */
            .taskbar {
                height: 44px;
                padding: 0 8px;
            }

            .taskbar-item {
                padding: 6px 10px;
                font-size: 11px;
            }

            /* Stats bar compact mode */
            .stats-bar {
                padding: 6px 10px;
            }

            /* Hide less important buttons on mobile */
            #resetLayoutBtn,
            #layoutLockBtn {
                display: none !important;
            }

            /* Mobile accordion mode for floating windows */
            .floating-window.mobile-collapsed {
                height: 44px !important;
                min-height: 44px !important;
                overflow: hidden;
            }

            .floating-window.mobile-collapsed .window-content {
                display: none;
            }

            .floating-window.mobile-collapsed .resize-handle {
                display: none;
            }

            /* Make titlebar tappable for accordion */
            .window-titlebar {
                cursor: pointer;
            }

            /* Mobile accordion indicator */
            .mobile-accordion-indicator {
                margin-left: auto;
                margin-right: 8px;
                transition: transform 0.3s ease;
            }

            .mobile-collapsed .mobile-accordion-indicator {
                transform: rotate(-90deg);
            }
        }

        /* Very small screens (phones) */
        @media (max-width: 480px) {
            .stats-bar {
                padding: 4px 8px;
            }

            .stats-bar h1 {
                font-size: 1.1rem !important;
            }

            .stats-bar p.text-xs {
                display: none;
            }

            /* Compact stats grid */
            .stats-bar .flex-1 {
                min-width: calc(50% - 6px) !important;
                padding: 6px !important;
            }

            .stats-bar .flex-1 p.text-2xl {
                font-size: 1.25rem !important;
            }

            .stats-bar .flex-1 p.text-xs {
                font-size: 0.65rem !important;
            }

            /* Hide less important stats on very small screens */
            /* Grid layout for stats on very small screens */
            .stats-bar .flex.flex-wrap.md\:flex-nowrap.gap-3.mt-3 {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .stats-bar .flex-1 {
                min-width: 0 !important;
                margin: 0 !important;
            }

            /* Make sure the main status box spans full width */
            .stats-bar .flex-\[1\.5\] {
                grid-column: 1 / -1;
            }

            /* Compact buttons */
            #startBtn,
            #stopBtn {
                padding: 6px 12px !important;
                font-size: 0.75rem !important;
            }

            .window-title {
                font-size: 12px;
            }

            /* Mobile table adjustments */
            table th,
            table td {
                padding: 6px 8px !important;
                font-size: 0.75rem !important;
            }

            /* Allow horizontal scroll for table, unhide workers */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }

            /* Compact log box */
            .log-box {
                font-size: 0.7rem;
            }
        }

        /* Small screens (large phones / small tablets) */
        @media (max-width: 640px) {

            /* Header buttons wrap */
            .stats-bar .flex.items-center.space-x-4 {
                flex-wrap: wrap;
                gap: 6px;
            }

            .stats-bar .flex.items-center.space-x-4>* {
                margin: 0 !important;
            }

            /* Two-column stats instead of row */
            .stats-bar .gap-3 {
                gap: 6px !important;
            }

            /* Live preview sidebar hidden */
            /* Live preview sidebar becomes top horizontal tabs */
            #window-preview .window-content {
                flex-direction: column;
            }

            #window-preview .window-content>div:first-child {
                display: flex !important;
                width: 100% !important;
                min-width: 0 !important;
                height: 40px;
                min-height: 40px;
                flex-direction: row !important;
                /* Force row direction */
                overflow-x: auto;
                overflow-y: hidden;
                border-bottom: 1px solid #334155;
                margin-bottom: 8px;
                order: -1;
                /* Ensure it is at the top */
            }

            #livePreviewTabs {
                flex-direction: row !important;
                padding-right: 0 !important;
                gap: 8px !important;
                align-items: center;
            }

            /* Adjust refreshing button positioning if needed */
            #window-preview .window-content>div:first-child .flex.items-center.justify-between {
                margin-bottom: 0;
                margin-right: 8px;
            }

            /* Full width preview grid */
            #livePreviewGrid {
                width: 100% !important;
            }

            .live-preview-grid {
                grid-template-columns: 1fr !important;
            }
        }

        /* Medium screens (tablets) */
        @media (max-width: 768px) and (min-width: 481px) {
            .stats-bar .flex-1 {
                min-width: calc(33% - 8px) !important;
            }
        }

        /* Mobile-specific panel animations */
        @media (max-width: 768px) {
            .floating-window {
                transition: height 0.3s ease, box-shadow 0.2s;
            }
        }

        /* Prevent horizontal scroll on mobile */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
                overflow-y: auto;
                /* Ensure vertical scroll works */
            }

            #windowsContainer {
                overflow-x: hidden;
                width: 100%;
                /* Padding top handled by JS or CSS */
                padding-top: 10px !important;
                /* Small gap after static header */
            }
        }

        /* ============================================
           HORIZONTAL TAB NAVIGATION STYLES
           ============================================ */

        .nav-tabs {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid #334155;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9997;
        }

        .nav-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 24px;
            color: #64748b;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: #94a3b8;
            background: rgba(100, 116, 139, 0.1);
        }

        .nav-tab.active {
            background: #3b82f6;
            color: #ffffff;
        }

        .nav-tab.active:hover {
            background: #2563eb;
        }

        .nav-tab-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 6px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .nav-tab:not(.active) .nav-tab-number {
            background: rgba(100, 116, 139, 0.2);
            color: #64748b;
        }

        .nav-tab.active .nav-tab-number {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }

        .nav-tab-label {
            font-size: 14px;
        }

        /* Adjust main content for top nav bar */
        #windowsContainer {
            padding-top: 220px !important;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .nav-tabs {
                padding: 8px 12px;
                gap: 4px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .nav-tab {
                padding: 8px 14px;
                font-size: 13px;
            }

            .nav-tab-number {
                min-width: 20px;
                height: 20px;
                font-size: 11px;
            }
        }
    </style>
</head>

<body>

    <!-- Top Stats Bar (Fixed) -->
    <div class="stats-bar">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="flex justify-between items-center pb-3 border-b border-gray-700">
                <div>
                    <h1 class="text-2xl font-bold text-white tracking-tight">Gemini OCR Farm üöú</h1>
                    <p class="text-gray-400 text-xs mt-1">Status farmy i kontrola zada≈Ñ</p>
                </div>
                <div class="flex items-center gap-2 flex-wrap justify-end">
                    <button onclick="resetLayoutHard()" id="resetLayoutBtn"
                        class="px-2 py-1 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded transition flex items-center space-x-1"
                        title="Resetuj uk≈Çad okienek">
                        <span>üîÑ</span>
                        <span class="hidden sm:inline">Reset</span>
                    </button>
                    <button onclick="restartApp()" id="restartAppBtn"
                        class="px-2 py-1 text-xs bg-orange-700 hover:bg-orange-600 text-white rounded transition flex items-center space-x-1"
                        title="Restartuj aplikacjƒô webowƒÖ">
                        <span>üîÉ</span>
                        <span class="hidden sm:inline">Restart</span>
                    </button>
                    <button onclick="windowManager.toggleLogsWindow()" id="toggleLogsBtn"
                        class="px-2 py-1 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded transition flex items-center space-x-1"
                        title="Poka≈º/Ukryj Logi">
                        <span>üìú</span>
                        <span class="hidden sm:inline">Logi</span>
                    </button>
                    <button onclick="windowManager.toggleLayoutLock()" id="layoutLockBtn"
                        class="px-2 py-1 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded transition flex items-center space-x-1"
                        title="Prze≈ÇƒÖcz tryb uk≈Çadu (Auto / Swobodny)">
                        <span>üîí</span>
                        <span class="hidden sm:inline">Uk≈Çad: Auto</span>
                    </button>

                    <div id="connectionStatus"
                        class="flex items-center space-x-1 text-green-500 font-medium text-xs px-2 py-1 bg-gray-800 rounded border border-gray-700">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                        <span>Online</span>
                    </div>
                </div>
            </div>

            <!-- Main Stats Grid -->
            <!-- Main Stats Grid -->
            <div class="flex flex-wrap md:flex-nowrap gap-3 mt-3">
                <div class="bg-slate-800/50 rounded-lg p-3 border-l-4 border-blue-500 flex-1 min-w-[120px]">
                    <p class="text-gray-400 text-xs uppercase font-bold">Stron dzi≈õ</p>
                    <p class="text-2xl font-bold text-white mt-1" id="dbTodayCount">-</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 border-l-4 border-cyan-500 flex-1 min-w-[120px]">
                    <p class="text-gray-400 text-xs uppercase font-bold">Stron w sesji</p>
                    <p class="text-2xl font-bold text-white mt-1" id="sessionDoneCount">-</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 border-l-4 border-red-500 flex-1 min-w-[140px]">
                    <p class="text-gray-400 text-xs uppercase font-bold">Odrzucone nie-Pro</p>
                    <p class="text-2xl font-bold text-white mt-1" id="nonProRejectedCount">-</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 border-l-4 border-emerald-500 flex-1 min-w-[140px]">
                    <p class="text-gray-400 text-xs uppercase font-bold">Pro pozosta≈Ço (est)</p>
                    <p class="text-sm font-semibold text-white mt-2" id="proRemainingEst">-</p>
                    <p class="text-[10px] text-gray-500 mt-1">A: limit | B: infer | C: tempo</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 border-l-4 border-purple-500 flex-1 min-w-[120px]">
                    <p class="text-gray-400 text-xs uppercase font-bold">Aktywne Workery</p>
                    <p class="text-2xl font-bold text-white mt-1" id="activeWorkers">-</p>
                </div>
                <div
                    class="bg-slate-800/50 rounded-lg p-3 border-l-4 border-emerald-500 flex-[1.5] flex flex-col gap-2 min-w-[250px]">
                    <div>
                        <p class="text-gray-400 text-xs uppercase font-bold">Status Zadania</p>
                        <p class="text-base font-bold text-white mt-1" id="jobStatus">Checking...</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="startBtn" onclick="startJob()"
                            class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-1 px-4 rounded shadow transition text-sm flex items-center gap-2">
                            <span>‚ñ∂</span> START
                        </button>
                        <button id="stopBtn" onclick="stopJob()"
                            class="hidden bg-red-600 hover:bg-red-500 text-white font-bold py-1 px-4 rounded shadow transition text-sm flex items-center gap-2">
                            <span>‚èπ</span> STOP
                        </button>
                    </div>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 border-l-4 border-orange-500 flex-1 min-w-[100px]">
                    <p class="text-gray-400 text-xs uppercase font-bold">Batch ID</p>
                    <p class="text-xs font-bold text-white mt-2 truncate" id="currentBatchId">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Horizontal Tab Navigation -->
    <nav id="navTabs" class="nav-tabs">
        <a href="/" class="nav-tab" data-page="farm">
            <span class="nav-tab-number">01</span>
            <span class="nav-tab-label">Farma OCR</span>
        </a>
        <a href="/postprocess" class="nav-tab active" data-page="postprocess">
            <span class="nav-tab-number">02</span>
            <span class="nav-tab-label">Strukturyzacja</span>
        </a>
    </nav>

    <!-- Windows Container -->
    <div id="windowsContainer" style="position: relative; width: 100%; min-height: 100vh; padding-top: 180px;">

        <!-- Window: Profiles Table -->
        <div class="floating-window" id="window-profiles" data-window-id="profiles" style="display: none !important;">
            <div class="window-titlebar">
                <span class="window-title">üìä Status farmy OCR</span>
                <div class="window-controls">
                    <button class="btn-minimize" onclick="windowManager.minimizeWindow('profiles')">‚ûñ</button>
                    <button class="btn-refresh" onclick="refreshPanelWindow('profiles')">üîÑ</button>
                    <button class="btn-maximize" onclick="windowManager.toggleMaximize('profiles')">‚¨ú</button>
                    <button class="btn-close" onclick="windowManager.closeWindow('profiles')">‚ùå</button>
                </div>
            </div>
            <div class="window-content flex flex-col p-0">
                <!-- Toolbar for sorting/filtering -->
                <div class="bg-gray-800 p-2 border-b border-gray-700 flex gap-2 text-xs flex-wrap">
                    <input type="text" id="profileFilter" placeholder="Filtr profilu..."
                        class="bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white focus:outline-none focus:border-blue-500 w-32">
                    <select id="sortBy"
                        class="bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white focus:outline-none focus:border-blue-500">
                        <option value="name">Wg Nazwy</option>
                        <option value="active">Wg Aktywno≈õci</option>
                        <option value="progress">Wg Postƒôpu</option>
                    </select>
                    <button onclick="syncProfiles()" id="syncProfilesBtn"
                        class="ml-auto bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded transition flex items-center gap-1">
                        <span>üì•</span> Sync
                    </button>
                </div>

                <div class="overflow-x-auto flex-1">
                    <table class="w-full text-left text-xs text-gray-300">
                        <thead class="bg-gray-700 text-gray-200 uppercase text-[10px] sticky top-0 z-10">
                            <tr>
                                <th class="px-3 py-2">Profil</th>
                                <th class="px-3 py-2 text-center">Wrk</th>
                                <th class="px-3 py-2 text-center">Strony</th>
                                <th class="px-3 py-2 text-center">Status</th>
                                <th class="px-3 py-2 text-center">Reset</th>
                                <th class="px-3 py-2 text-right">Est.</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700" id="profilesTableBody">
                            <tr>
                                <td colspan="6" class="p-4 text-center">≈Åadowanie...</td>
                            </tr>
                        </tbody>
                        <tfoot
                            class="bg-gray-800 text-gray-200 font-bold sticky bottom-0 border-t border-gray-600 text-[11px] z-10">
                            <tr>
                                <td class="px-3 py-2">SUMA</td>
                                <td class="px-3 py-2 text-blue-400 text-center" id="tableTotalWorkers">-</td>
                                <td class="px-3 py-2 text-green-400 text-center" id="tableTotalDone">-</td>
                                <td class="px-3 py-2"></td>
                                <td class="px-3 py-2"></td>
                                <td class="px-3 py-2 text-[10px] text-gray-300 text-right" id="tableTotalProEst">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Progress Info Section -->
                <div id="progressInfoSection" class="hidden border-t border-gray-700 bg-gray-800/80 p-2 text-[11px]">
                    <div class="grid grid-cols-2 ml-1 gap-x-4 gap-y-1">
                        <div class="col-span-2 flex items-center gap-2">
                            <span class="text-gray-400">üìÅ</span>
                            <span id="sourceFolder" class="text-blue-300 font-mono break-all">-</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400">üìä</span>
                            <div>
                                <span id="processedCount" class="text-green-400 font-bold">0</span>
                                <span class="text-gray-500">/</span>
                                <span id="totalFilesCount" class="text-white">0</span>
                                <span class="text-gray-500 text-[10px]">(<span id="progressPercent">0</span>%)</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400">‚è±Ô∏è Tryb:</span>
                            <span id="avgRateSession" class="text-emerald-400 font-bold">-</span>
                        </div>
                        <div class="col-span-2 hidden" id="gapsInfoContainer">
                            <span class="text-gray-400">‚ö†Ô∏è Luki:</span>
                            <span id="gapsInfo" class="text-yellow-400 ml-1 font-mono">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="resize-handle resize-n"></div>
            <div class="resize-handle resize-s"></div>
            <div class="resize-handle resize-e"></div>
            <div class="resize-handle resize-w"></div>
            <div class="resize-handle resize-ne"></div>
            <div class="resize-handle resize-nw"></div>
            <div class="resize-handle resize-se"></div>
            <div class="resize-handle resize-sw"></div>
        </div>

        <!-- Window: Worker Logs -->
        <div class="floating-window" id="window-logs" data-window-id="logs" style="display: none;">
            <div class="window-titlebar">
                <span class="window-title">üìù Logi Worker√≥w</span>
                <div class="window-controls">
                    <button class="btn-minimize" onclick="windowManager.minimizeWindow('logs')">‚ûñ</button>
                    <button class="btn-refresh" onclick="refreshPanelWindow('logs')">üîÑ</button>
                    <button class="btn-maximize" onclick="windowManager.toggleMaximize('logs')">‚¨ú</button>
                    <button class="btn-close" onclick="windowManager.toggleLogsWindow()">‚ùå</button>
                </div>
            </div>
            <div class="window-content p-0 flex flex-col">
                <div
                    class="bg-gray-900 border-b border-gray-700 p-1 flex justify-between items-center text-[10px] text-gray-400">
                    <span class="ml-2">Ostatnie logi (max 50 linii)</span>
                    <label class="flex items-center gap-2 mr-2 cursor-pointer">
                        <input type="checkbox" id="suppressLogs" onchange="toggleSuppressLogs(this.checked)"
                            class="rounded bg-gray-700">
                        Wstrzymaj od≈õwie≈ºanie
                    </label>
                </div>
                <div class="log-box flex-1 overflow-auto bg-[#0d1117] text-gray-300 p-2 text-xs font-mono whitespace-pre-wrap"
                    id="logBox">
                    ≈Åadowanie log√≥w...
                </div>
            </div>
            <div class="resize-handle resize-n"></div>
            <div class="resize-handle resize-s"></div>
            <div class="resize-handle resize-e"></div>
            <div class="resize-handle resize-w"></div>
            <div class="resize-handle resize-ne"></div>
            <div class="resize-handle resize-nw"></div>
            <div class="resize-handle resize-se"></div>
            <div class="resize-handle resize-sw"></div>
        </div>


        <!-- Window: Live Preview -->
        <div class="floating-window" id="window-preview" data-window-id="preview" style="display: none !important;">
            <div class="window-titlebar">
                <span class="window-title">üñºÔ∏è PodglƒÖd Live</span>
                <div class="window-controls">
                    <button class="btn-minimize" onclick="windowManager.minimizeWindow('preview')">‚ûñ</button>
                    <button class="btn-refresh" onclick="refreshPanelWindow('preview')">üîÑ</button>
                    <button class="btn-maximize" onclick="windowManager.toggleMaximize('preview')">‚¨ú</button>
                    <button class="btn-close" onclick="windowManager.closeWindow('preview')">‚ùå</button>
                </div>
            </div>
            <div class="window-content flex flex-col">
                <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                    <div class="flex space-x-2 overflow-x-auto pb-1" id="livePreviewTabs">
                        <!-- Tabs injected via JS -->
                        <button
                            class="px-3 py-1 text-xs rounded bg-blue-600 text-white font-medium whitespace-nowrap">Wszystkie</button>
                    </div>
                    <span class="text-[10px] text-gray-500 hidden sm:inline">Kliknij obraz, by powiƒôkszyƒá</span>
                </div>
                <div class="flex-1 overflow-y-auto min-h-0">
                    <div id="livePreviewGrid" class="live-preview-grid">
                        <div class="col-span-full text-center text-gray-500 py-10" id="previewLoading">
                            ≈Åadowanie podglƒÖdu...
                        </div>
                    </div>
                </div>
            </div>
            <div class="resize-handle resize-n"></div>
            <div class="resize-handle resize-s"></div>
            <div class="resize-handle resize-e"></div>
            <div class="resize-handle resize-w"></div>
            <div class="resize-handle resize-ne"></div>
            <div class="resize-handle resize-nw"></div>
            <div class="resize-handle resize-se"></div>
            <div class="resize-handle resize-sw"></div>
        </div>


        <!-- Window: Limit Monitor -->
        <div class="floating-window" id="window-limits" data-window-id="limits" style="display: none !important;">
            <div class="window-titlebar">
                <span class="window-title">üõë Monitor Limit√≥w</span>
                <div class="window-controls">
                    <button class="btn-minimize" onclick="windowManager.minimizeWindow('limits')">‚ûñ</button>
                    <button class="btn-refresh" onclick="refreshPanelWindow('limits')">üîÑ</button>
                    <button class="btn-maximize" onclick="windowManager.toggleMaximize('limits')">‚¨ú</button>
                    <button class="btn-close" onclick="windowManager.closeWindow('limits')">‚ùå</button>
                </div>
            </div>
            <div class="window-content flex flex-col gap-4">
                <!-- Control Strip -->
                <div class="flex flex-wrap items-center gap-3 p-2 bg-gray-800/50 rounded border border-gray-700">
                    <button id="limitRunBtn" onclick="runLimitCheck()"
                        class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-1.5 px-3 text-xs rounded shadow transition flex items-center gap-2">
                        <span>‚ö°</span> Sprawd≈∫ teraz
                    </button>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-gray-400 uppercase tracking-wider">Ostatni bieg</span>
                        <div class="flex items-center gap-2">
                            <span id="limitLastRun" class="text-sm font-bold text-white">-</span>
                            <span class="text-[10px] text-gray-500">(<span id="limitLastAge">-</span>)</span>
                        </div>
                    </div>
                    <div class="flex flex-col border-l border-gray-600 pl-3">
                        <span class="text-[10px] text-gray-400 uppercase tracking-wider">Status</span>
                        <span id="limitRunStatus" class="text-xs text-gray-300">Gotowy</span>
                    </div>
                    <div class="ml-auto flex items-center gap-2">
                        <label class="flex items-center gap-1 text-[10px] text-gray-400 cursor-pointer"
                            title="Pomi≈Ñ pe≈Çne sprawdzenie tre≈õci, tylko nag≈Ç√≥wki">
                            <input type="checkbox" id="limitQuickMode" class="rounded bg-gray-700 border-gray-600">
                            Szybki
                        </label>
                        <select id="limitCheckHost"
                            class="bg-gray-900 text-gray-300 text-[10px] border border-gray-700 rounded px-1 py-0.5">
                            <option value="local">Lokalnie (100.127.229.84)</option>
                            <option value="remote">Zdalnie (100.102.158.100)</option>
                        </select>
                    </div>
                </div>

                <!-- Progress Bar (Normal Hidden) -->
                <div id="limitCheckProgress"
                    class="hidden bg-blue-900/30 border border-blue-500/30 rounded p-2 flex items-center gap-3">
                    <div class="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <div class="flex flex-col flex-1">
                        <div class="flex justify-between text-[10px] text-blue-200">
                            <span id="limitCheckModeLabel">Sprawdzam...</span>
                            <span id="limitCheckCurrentProfile">-</span>
                        </div>
                        <div class="text-xs font-mono text-white mt-1" id="limitCheckProgressText">
                            Inicjalizacja...
                        </div>
                    </div>
                    <span id="limitCheckMode"
                        class="text-[9px] px-1.5 py-0.5 rounded bg-blue-600 text-white">SUBPROCESS</span>
                </div>

                <!-- Status Table -->
                <div class="flex-1 overflow-auto border border-gray-700 rounded bg-gray-900/50 min-h-[150px]">
                    <table class="w-full text-left text-xs text-gray-300 limit-status-table">
                        <thead class="bg-gray-800 text-gray-400 uppercase text-[10px] sticky top-0">
                            <tr>
                                <th class="px-3 py-2">Profil</th>
                                <th class="px-3 py-2">Licznik</th>
                                <th class="px-3 py-2">Status</th>
                                <th class="px-3 py-2">Ost. Sprawdz.</th>
                                <th class="px-3 py-2">Czas</th>
                                <th class="px-3 py-2">Pauza Do</th>
                                <th class="px-3 py-2">≈πr√≥d≈Ço</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-800" id="limitStatusTableBody">
                            <tr>
                                <td colspan="7" class="p-4 text-center text-gray-500">Brak danych</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Bottom Panels -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-[11px] h-32">
                    <div class="bg-gray-800/30 rounded border border-gray-700 p-2 overflow-hidden flex flex-col">
                        <div class="flex justify-between items-center mb-1 border-b border-gray-700 pb-1">
                            <span class="font-bold text-gray-400">Historia Sprawdze≈Ñ</span>
                            <span class="text-[10px] text-gray-600">Sesja: <span id="limitSessionRuns"
                                    class="text-gray-300">0</span></span>
                        </div>
                        <div id="limitRecentRuns" class="flex-1 overflow-y-auto space-y-1">
                            <span class="text-gray-500">Brak historii</span>
                        </div>
                    </div>
                    <div class="bg-gray-800/30 rounded border border-gray-700 p-2 overflow-hidden flex flex-col">
                        <div class="flex justify-between items-center mb-1 border-b border-gray-700 pb-1">
                            <span class="font-bold text-gray-400">Wyb√≥r Profili</span>
                            <div class="flex gap-1">
                                <button onclick="selectLimitProfiles('all')"
                                    class="px-1.5 py-0.5 bg-gray-700 hover:bg-gray-600 rounded text-[9px]">All</button>
                                <button onclick="selectLimitProfiles('active')"
                                    class="px-1.5 py-0.5 bg-gray-700 hover:bg-gray-600 rounded text-[9px]">Active</button>
                                <button onclick="selectLimitProfiles('paused')"
                                    class="px-1.5 py-0.5 bg-gray-700 hover:bg-gray-600 rounded text-[9px]">Paused</button>
                                <button onclick="selectLimitProfiles('none')"
                                    class="px-1.5 py-0.5 bg-gray-700 hover:bg-gray-600 rounded text-[9px]">None</button>
                            </div>
                        </div>
                        <div id="limitProfileList" class="flex-1 overflow-y-auto space-y-0.5">
                            <!-- Checkboxes injected js -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="resize-handle resize-n"></div>
            <div class="resize-handle resize-s"></div>
            <div class="resize-handle resize-e"></div>
            <div class="resize-handle resize-w"></div>
            <div class="resize-handle resize-ne"></div>
            <div class="resize-handle resize-nw"></div>
            <div class="resize-handle resize-se"></div>
            <div class="resize-handle resize-sw"></div>
        </div>


        <!-- Window: Control Panel -->
        <div class="floating-window" id="window-control" data-window-id="control" style="display: none !important;">
            <div class="window-titlebar">
                <span class="window-title">üéõÔ∏è Panel Sterowania</span>
                <div class="window-controls">
                    <button class="btn-minimize" onclick="windowManager.minimizeWindow('control')">‚ûñ</button>
                    <button class="btn-maximize" onclick="windowManager.toggleMaximize('control')">‚¨ú</button>
                    <button class="btn-close" onclick="windowManager.closeWindow('control')">‚ùå</button>
                </div>
            </div>
            <div class="window-content flex flex-col p-4 gap-4">

                <div class="flex border-b border-gray-700 space-x-4 mb-2">
                    <button class="px-3 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-400"
                        onclick="switchControlTab('basic', this)">Podstawowe</button>
                    <button
                        class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-300"
                        onclick="switchControlTab('performance', this)">Wydajno≈õƒá</button>
                    <button
                        class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-300"
                        onclick="switchControlTab('database', this)">Baza Danych</button>
                    <button
                        class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-300"
                        onclick="switchControlTab('preprocess', this)">Preprocessing</button>
                    <button
                        class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-300"
                        onclick="switchControlTab('advanced', this)">Zaawansowane</button>
                </div>

                <form id="controlForm" class="flex-1 overflow-y-auto space-y-6 pr-2">

                    <!-- BASIC TAB -->
                    <div data-tab="basic" class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 uppercase mb-1">≈πr√≥d≈Ço
                                (Folder)</label>
                            <div class="flex gap-2">
                                <input type="text" name="source_path"
                                    placeholder="/home/tomaasz/ocr-stare-dokumenty/data/raw"
                                    class="flex-1 bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none placeholder-gray-600">
                            </div>
                            <p class="text-[10px] text-gray-500 mt-1">≈öcie≈ºka absolutna do folderu z obrazami
                                (rekurencyjnie)</p>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-400 uppercase mb-1">Profile do
                                uruchomienia</label>
                            <!-- Simple selection UI for basic tab -->
                            <input type="text" name="profiles" placeholder="np. profile1, profile2 (puste = wszystkie)"
                                class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none">
                            <div class="mt-2 flex flex-wrap gap-2 text-[10px]" id="quickProfileHashtags">
                                <!-- injected js -->
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-400 uppercase mb-1">Liczba
                                    Worker√≥w</label>
                                <input type="number" name="workers" value="{{ default_workers | default(2) }}" min="1"
                                    max="16"
                                    class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-400 uppercase mb-1">Batch ID
                                    (opcjonalne)</label>
                                <input type="text" name="batch_id" placeholder="auto-generated"
                                    class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none">
                            </div>
                        </div>

                        <!-- Toggle Headed/Engine -->
                        <div class="flex gap-6 pt-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="headed"
                                    class="w-4 h-4 rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-offset-gray-900">
                                <span class="text-sm text-gray-300">Tryb Headed (poka≈º przeglƒÖdarkƒô)</span>
                            </label>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-400 uppercase mb-1">Silnik OCR</label>
                            <select name="engine"
                                class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none">
                                <option value="auto">Auto (Gemini 2.0 -> 1.5 Pro -> 1.5 Flash)</option>
                                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp (Najszybszy)</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                            </select>
                        </div>
                    </div>

                    <!-- PERFORMANCE TAB -->
                    <div data-tab="performance" class="hidden space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 uppercase mb-1">Skan√≥w na Workera
                                (krok)</label>
                            <input type="number" name="scans_per_worker"
                                value="{{ default_scans_per_worker | default(2) }}" min="1" max="50"
                                class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none">
                            <p class="text-[10px] text-gray-500 mt-1">Ile stron worker przetwarza zanim zrestartuje
                                proces przeglƒÖdarki (anty-wyciek pamiƒôci)</p>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 uppercase mb-1">Timeout zbierania
                                wynik√≥w (s)</label>
                            <input type="number" name="collect_timeout_sec" value="400"
                                class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none">
                        </div>
                    </div>

                    <!-- DATABASE TAB -->
                    <div data-tab="database" class="hidden space-y-4">
                        <label class="flex items-center gap-2 cursor-pointer mb-2">
                            <input type="checkbox" name="pg_enabled" checked
                                class="w-4 h-4 rounded bg-gray-700 border-gray-600 text-blue-500">
                            <span class="text-sm font-bold text-white">Zapisuj do PostgreSQL</span>
                        </label>
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 uppercase mb-1">DSN
                                Po≈ÇƒÖczenia</label>
                            <input type="text" name="pg_dsn"
                                value="postgresql://tomaasz:123Karinka!%40%23@127.0.0.1:5432/ocr"
                                class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm text-white font-mono text-xs focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 uppercase mb-1">Tabela</label>
                            <input type="text" name="pg_table" value="public.ocr_raw_texts"
                                class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none">
                        </div>
                    </div>

                    <!-- PREPROCESS TAB -->
                    <div data-tab="preprocess" class="hidden space-y-6">
                        <div class="bg-blue-900/20 p-3 rounded border border-blue-800/30 text-xs text-blue-200">
                            Te ustawienia kontrolujƒÖ `preproc.py`. U≈ºywaj ostro≈ºnie.
                        </div>

                        <!-- General -->
                        <div class="space-y-3 border-b border-gray-700 pb-4">
                            <h3 class="text-xs font-bold text-gray-400 uppercase">Og√≥lne</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-[10px] text-gray-500 mb-1">Max Dimension (px)</label>
                                    <input type="number" name="preproc_max_dimension" value="2500" class="input-tiny">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-500 mb-1">Median Kernel</label>
                                    <input type="number" name="preproc_median_kernel" value="3" class="input-tiny">
                                </div>
                            </div>
                        </div>

                        <!-- Denoise & Enhance -->
                        <div class="space-y-3 border-b border-gray-700 pb-4">
                            <h3 class="text-xs font-bold text-gray-400 uppercase">Odsumianie i Kontrast</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-[10px] text-gray-500 mb-1">Denoise Strength</label>
                                    <input type="number" name="preproc_denoise_strength" value="8" class="input-tiny">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-500 mb-1">CLAHE Clip Limit</label>
                                    <input type="number" name="preproc_clahe_clip_limit" value="2.0" step="0.1"
                                        class="input-tiny">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-500 mb-1">Unsharp Amount</label>
                                    <input type="number" name="preproc_unsharp_amount" value="1.2" step="0.1"
                                        class="input-tiny">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-500 mb-1">Local Contrast Amount</label>
                                    <input type="number" name="preproc_local_contrast_amount" value="0.35" step="0.05"
                                        class="input-tiny">
                                </div>
                            </div>
                        </div>

                        <!-- Binarization -->
                        <div class="space-y-3">
                            <h3 class="text-xs font-bold text-gray-400 uppercase">Binaryzacja (Sauvola)</h3>
                            <div class="flex items-center gap-2 mb-2">
                                <input type="checkbox" name="preproc_enable_adaptive_binarization"
                                    class="rounded bg-gray-700">
                                <span class="text-xs text-gray-300">W≈ÇƒÖcz Adaptive Binarization</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="block text-[10px] text-gray-500 mb-1">Window</label>
                                    <input type="number" name="preproc_sauvola_window" value="31" class="input-tiny">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-500 mb-1">k</label>
                                    <input type="number" name="preproc_sauvola_k" value="0.2" step="0.05"
                                        class="input-tiny">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-500 mb-1">R</label>
                                    <input type="number" name="preproc_sauvola_r" value="128" class="input-tiny">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ADVANCED TAB -->
                    <div data-tab="advanced" class="hidden space-y-4">
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="continue_mode" checked
                                    class="w-4 h-4 rounded bg-gray-700 border-gray-600 text-blue-500">
                                <span class="text-sm text-gray-300">Tryb Kontynuacji (pomi≈Ñ przetworzone)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="pro_only" checked
                                    class="w-4 h-4 rounded bg-gray-700 border-gray-600 text-blue-500">
                                <span class="text-sm text-gray-300">Tylko model Pro (Pomi≈Ñ Flash/inne)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="clean_temp_images" checked
                                    class="w-4 h-4 rounded bg-gray-700 border-gray-600 text-blue-500">
                                <span class="text-sm text-gray-300">Czy≈õƒá tymczasowe obrazy (oszczƒôdno≈õƒá dysku)</span>
                            </label>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 uppercase mb-1">Browser ID
                                (Persistent)</label>
                            <input type="text" name="browser_id" placeholder="Opcjonalne ID sesji przeglƒÖdarki"
                                class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none">
                        </div>
                    </div>
                </form>

                <div class="pt-4 border-t border-gray-700 flex justify-end gap-3 sticky bottom-0 bg-[#0f172a] pb-2">
                    <button type="button" onclick="loadControlDefaults()"
                        class="px-4 py-2 text-sm text-gray-400 hover:text-white transition">Przywr√≥ƒá domy≈õlne</button>
                    <button type="button" onclick="saveControlSettings()"
                        class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded shadow transition">
                        Zapisz Ustawienia
                    </button>
                </div>
            </div>
            <div class="resize-handle resize-n"></div>
            <div class="resize-handle resize-s"></div>
            <div class="resize-handle resize-e"></div>
            <div class="resize-handle resize-w"></div>
            <div class="resize-handle resize-ne"></div>
            <div class="resize-handle resize-nw"></div>
            <div class="resize-handle resize-se"></div>
            <div class="resize-handle resize-sw"></div>
        </div>


    </div>

    <!-- Taskbar -->
    <div class="taskbar" id="taskbar">
        <div class="taskbar-item" onclick="windowManager.toggleLogsWindow()" title="Poka≈º/Ukryj logi">
            <span>üìù</span> Logi
        </div>
    </div>

    <!-- Window: Post-processing -->
    <div class="floating-window" id="window-postproc" data-window-id="postproc">
        <div class="window-titlebar">
            <span class="window-title">üèóÔ∏è Strukturyzacja danych</span>
            <div class="window-controls">
                <button class="btn-minimize" onclick="windowManager.minimizeWindow('postproc')">‚ûñ</button>
                <button class="btn-refresh" onclick="refreshPanelWindow('postproc')">üîÑ</button>
                <button class="btn-maximize" onclick="windowManager.toggleMaximize('postproc')">‚¨ú</button>
                <button class="btn-close" onclick="windowManager.closeWindow('postproc')">‚ùå</button>
            </div>
        </div>
        <div class="window-content space-y-3">
            <div class="flex items-center justify-between">
                <span class="text-xs text-gray-400">Status: <span id="postProcStatus"
                        class="font-bold text-gray-400">IDLE</span></span>
                <button id="btnPostProcToggle" onclick="togglePostProc()"
                    class="bg-green-700 hover:bg-green-600 text-white text-xs py-1 px-2 rounded border border-green-600 transition font-bold">
                    ‚ñ∂ Start Processing
                </button>
            </div>
            <div class="text-[11px] text-gray-400 leading-snug">
                Proces postprocess bierze surowe OCR z DB i tworzy ustrukturyzowane rekordy
                (tabele documents/entries). Status odswieza sie co ~2s.
                <span id="postProcDetails" class="block text-gray-500 mt-1"></span>
            </div>
            <div class="bg-gray-900/50 border border-gray-700 rounded px-2 py-1 text-[11px] text-gray-300">
                <div class="text-gray-500">Ostatni log:</div>
                <div id="postProcLastLog" class="truncate">brak</div>
            </div>
            <!-- DSN input removed (using main panel DSN) -->
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">API Key (OpenRouter)</label>
                <input type="password" id="postProcApiKey"
                    class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-sm focus:border-blue-500 outline-none"
                    placeholder="sk-or-...">
                <div class="text-[10px] text-gray-500 mt-1">Opcjonalne. Zostaw puste aby u≈ºywaƒá przeglƒÖdarki (darmowe).
                </div>
            </div>
            <div class="pt-2 border-t border-gray-700">
                <div class="text-xs text-gray-500 uppercase tracking-wide mb-2">Statystyki</div>
                <div class="flex justify-between text-sm text-gray-300">
                    <span>Nowe do przetworzenia: <span id="postProcCountNew" class="font-bold">0</span></span>
                    <span>Przetworzone: <span id="postProcCountDone" class="font-bold">0</span></span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                    <div id="postProcBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <div class="pt-2 border-t border-gray-700">
                <div class="text-xs text-gray-500 uppercase tracking-wide mb-2">Narzƒôdzia</div>
                <button onclick="runPostProcMigration()"
                    class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-bold py-1.5 px-4 rounded shadow transition text-sm flex items-center justify-center gap-2">
                    <span>üöÄ</span> Utw√≥rz tabele (normalizacja DB)
                </button>
                <div class="text-[10px] text-gray-400 mt-1 text-center">
                    Tworzy tabele 'documents' i 'entries' zamiast kolumn JSON.
                </div>
            </div>
        </div>
        <div class="resize-handle resize-n"></div>
        <div class="resize-handle resize-s"></div>
        <div class="resize-handle resize-e"></div>
        <div class="resize-handle resize-w"></div>
        <div class="resize-handle resize-ne"></div>
        <div class="resize-handle resize-nw"></div>
        <div class="resize-handle resize-se"></div>
        <div class="resize-handle resize-sw"></div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imagePreviewModal"
        class="fixed inset-0 bg-black/90 hidden z-[10001] flex items-center justify-center p-4 cursor-pointer"
        onclick="closeImageModal()">
        <img id="imagePreviewTarget" src=""
            class="max-w-[95vw] max-h-[95vh] rounded shadow-2xl border border-gray-700 object-contain"
            onclick="event.stopPropagation()">
        <button
            class="absolute top-4 right-4 text-white hover:text-red-400 text-3xl font-bold p-2 bg-black/50 rounded-full w-10 h-10 flex items-center justify-center outline-none"
            onclick="closeImageModal()">
            &times;
        </button>
    </div>

    <!-- File Browser Modal (Draggable/Resizable) -->
    <div id="fileBrowserOverlay" class="fixed inset-0 bg-black/50 hidden z-[9998]" onclick="handleOverlayClick(event)">
    </div>
    <div id="fileBrowserModal" class="floating-window hidden"
        style="z-index: 9999; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 90vw; max-width: 1400px; height: 550px;">
        <div class="window-titlebar" id="fileBrowserTitlebar" ondblclick="maximizeBrowser()">
            <span class="window-title">üìÇ Wybierz folder</span>
            <div class="window-controls">
                <button class="btn-minimize" onclick="minimizeBrowser()" title="Minimalizuj">‚ûñ</button>
                <button class="btn-refresh" onclick="refreshBrowser()" title="Od≈õwie≈º">üîÑ</button>
                <button class="btn-maximize" onclick="maximizeBrowser()" title="Maksymalizuj">üóñ</button>
                <button class="btn-close" onclick="closeBrowser()" title="Zamknij">‚ùå</button>
            </div>
        </div>
        <div class="window-content" style="display: flex; flex-direction: row; height: calc(100% - 32px); gap: 12px;">
            <!-- Favorites Sidebar -->
            <div class="flex flex-col" style="width: 270px; min-width: 270px;">
                <div class="text-xs text-gray-400 mb-2 flex items-center justify-between">
                    <span>‚≠ê Ulubione</span>
                    <button onclick="addCurrentToFavorites()" class="text-yellow-500 hover:text-yellow-400 text-sm"
                        title="Dodaj aktualny folder">‚ûï</button>
                </div>
                <div id="favoritesList"
                    class="flex-1 overflow-y-auto space-y-1 border border-gray-700 rounded bg-gray-900/50 p-2">
                    <!-- Favorites will be added here -->
                </div>
            </div>
            <!-- Main Browser Area -->
            <div class="flex-1 flex flex-col min-w-0">
                <div class="mb-2 flex items-center bg-gray-900 p-2 rounded gap-2">
                    <button onclick="browserGoUp()"
                        class="text-gray-400 hover:text-white px-2 py-1 rounded bg-gray-800 hover:bg-gray-700 text-xs text-center min-w-[30px]"
                        title="W g√≥rƒô">
                        ‚¨ÜÔ∏è
                    </button>
                    <span class="text-gray-500">Path:</span>
                    <input type="text" id="browserCurrentPath"
                        class="bg-transparent flex-1 outline-none text-sm font-mono text-blue-400" readonly>
                </div>

                <div class="overflow-y-auto flex-1 border border-gray-700 rounded bg-gray-900/50 p-2 space-y-1"
                    id="fileList">
                    <!-- Items -->
                </div>

                <div class="mt-4 flex justify-end space-x-3">
                    <button onclick="closeBrowser()"
                        class="px-4 py-2 text-sm text-gray-300 hover:text-white">Anuluj</button>
                    <button onclick="selectCurrentFolder()"
                        class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-medium">Wybierz
                        ten
                        folder</button>
                </div>
            </div>
        </div>
        <div class="resize-handle resize-n"></div>
        <div class="resize-handle resize-s"></div>
        <div class="resize-handle resize-e"></div>
        <div class="resize-handle resize-w"></div>
        <div class="resize-handle resize-ne"></div>
        <div class="resize-handle resize-nw"></div>
        <div class="resize-handle resize-se"></div>
        <div class="resize-handle resize-sw"></div>
    </div>

    <!-- Stop Confirmation Modal -->
    <div id="stopModal"
        class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-[10050] backdrop-blur-sm">
        <div
            class="bg-gray-900 border border-red-500/30 p-6 rounded-lg shadow-2xl max-w-sm w-full mx-4 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-600 to-orange-600"></div>

            <h3 class="text-xl font-bold text-white mb-2 flex items-center">
                <span class="mr-2">‚ö†Ô∏è</span> Zatrzymaƒá zadanie?
            </h3>
            <p class="text-gray-400 text-sm mb-6">
                Czy na pewno chcesz przerwaƒá dzia≈Çanie farmy? Wszystkie aktywne workery zostanƒÖ natychmiast
                zamkniƒôte.
            </p>

            <div class="flex justify-end space-x-3">
                <button onclick="closeStopModal()"
                    class="px-4 py-2 text-sm text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors">
                    Anuluj
                </button>
                <button onclick="confirmStop()"
                    class="px-4 py-2 text-sm bg-red-600 hover:bg-red-700 text-white rounded font-medium shadow-lg shadow-red-900/20 transition-all transform hover:scale-105">
                    Zatrzymaj
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Window Manager ---
        const windowManager = {
            windows: {},
            zIndexCounter: 100,
            dragging: null,
            resizing: null,
            locked: true,

            getTopBoundary() {
                return -window.innerHeight;
            },
            constrainToViewport(win) {
                if (!this.locked) {
                    this.updateContainerSize();
                    return;
                }
                const maxLeft = Math.max(0, window.innerWidth - 200);
                const left = Math.min(Math.max(win.el.offsetLeft, 0), maxLeft);
                win.el.style.left = left + 'px';
            },

            updateContainerSize() {
                let maxX = 0;
                let maxY = 0;

                Object.values(this.windows).forEach(win => {
                    const rect = win.el.getBoundingClientRect();
                    // We use offsetLeft/Top because getBoundingClientRect is relative to viewport
                    // but since we scroll body, we care about absolute positions relative to document
                    const right = win.el.offsetLeft + win.el.offsetWidth;
                    const bottom = win.el.offsetTop + win.el.offsetHeight;

                    if (right > maxX) maxX = right;
                    if (bottom > maxY) maxY = bottom;
                });

                // Ensure minimums
                const winW = window.innerWidth;
                const winH = window.innerHeight;

                const newW = Math.max(winW, maxX + 50);
                const newH = Math.max(winH, maxY + 100); // +100 for taskbar/padding

                const container = document.getElementById('windowsContainer');
                if (container) {
                    container.style.minWidth = newW + 'px';
                    container.style.minHeight = newH + 'px';
                }
            },

            init() {
                const windowEls = document.querySelectorAll('.floating-window');
                windowEls.forEach(el => {
                    const id = el.dataset.windowId;
                    if (!id) {
                        return;
                    }
                    this.windows[id] = {
                        el: el,
                        state: 'normal',
                        savedPosition: null
                    };

                    // Set up event listeners
                    const titlebar = el.querySelector('.window-titlebar');
                    const titleText = el.querySelector('.window-title');
                    if (titleText) {
                        titleText.addEventListener('mousedown', (event) => event.stopPropagation());
                    }
                    titlebar.addEventListener('mousedown', (e) => this.startDrag(id, e));

                    // Resize handles
                    const resizeHandles = el.querySelectorAll('.resize-handle');
                    resizeHandles.forEach(handle => {
                        handle.addEventListener('mousedown', (e) => {
                            e.stopPropagation();
                            this.startResize(id, handle.classList[1], e);
                        });
                    });

                    // Bring to front on click
                    el.addEventListener('mousedown', () => this.bringToFront(id));
                });

                // Global mouse handlers
                document.addEventListener('mousemove', (e) => this.onMouseMove(e));
                document.addEventListener('mouseup', (e) => this.onMouseUp(e));

                this.loadPositions();

                // Init lock state
                const lockedState = localStorage.getItem('layoutLocked');
                this.locked = lockedState === null ? true : (lockedState === 'true');
                this.updateLockButton();
            },

            startDrag(id, e) {
                if (e.target.closest('.window-controls')) return;
                const win = this.windows[id];
                if (win.state === 'maximized') return;

                this.dragging = {
                    id: id,
                    startX: e.clientX,
                    startY: e.clientY,
                    startLeft: win.el.offsetLeft,
                    startTop: win.el.offsetTop
                };
                this.bringToFront(id);
            },

            startResize(id, direction, e) {
                const win = this.windows[id];
                if (win.state === 'maximized') return;

                this.resizing = {
                    id: id,
                    direction: direction,
                    startX: e.clientX,
                    startY: e.clientY,
                    startLeft: win.el.offsetLeft,
                    startTop: win.el.offsetTop,
                    startWidth: win.el.offsetWidth,
                    startHeight: win.el.offsetHeight
                };
                this.bringToFront(id);
            },

            onMouseMove(e) {
                const gridSize = 1;

                if (this.dragging) {
                    const dx = e.clientX - this.dragging.startX;
                    const dy = e.clientY - this.dragging.startY;
                    const win = this.windows[this.dragging.id];

                    let newLeft = this.dragging.startLeft + dx;
                    let newTop = this.dragging.startTop + dy;

                    // Snap position
                    newLeft = Math.round(newLeft / gridSize) * gridSize;
                    newTop = Math.round(newTop / gridSize) * gridSize;

                    // Boundary checking only if locked
                    if (this.locked) {
                        newLeft = Math.max(0, Math.min(newLeft, window.innerWidth - 200));
                        newTop = Math.min(newTop, window.innerHeight - 100);
                    } else {
                        // Expand container if needed
                        this.updateContainerSize();
                    }

                    win.el.style.left = newLeft + 'px';
                    win.el.style.top = newTop + 'px';
                }

                if (this.resizing) {
                    const dx = e.clientX - this.resizing.startX;
                    const dy = e.clientY - this.resizing.startY;
                    const win = this.windows[this.resizing.id];
                    const dir = this.resizing.direction;

                    const snap = (v) => Math.round(v / gridSize) * gridSize;

                    let newWidth = this.resizing.startWidth;
                    let newHeight = this.resizing.startHeight;
                    let newLeft = this.resizing.startLeft;
                    let newTop = this.resizing.startTop;

                    if (dir.includes('e')) {
                        newWidth = snap(this.resizing.startWidth + dx);
                    }
                    if (dir.includes('w')) {
                        const rightEdge = this.resizing.startLeft + this.resizing.startWidth;
                        newLeft = snap(this.resizing.startLeft + dx);
                        newWidth = rightEdge - newLeft;
                    }
                    if (dir.includes('s')) {
                        newHeight = snap(this.resizing.startHeight + dy);
                    }
                    if (dir.includes('n')) {
                        const bottomEdge = this.resizing.startTop + this.resizing.startHeight;
                        newTop = snap(this.resizing.startTop + dy);
                        newHeight = bottomEdge - newTop;
                    }

                    // Min size constraints
                    newWidth = Math.max(300, newWidth);
                    newHeight = Math.max(200, newHeight);

                    win.el.style.width = newWidth + 'px';
                    win.el.style.height = newHeight + 'px';
                    if (dir.includes('w')) win.el.style.left = newLeft + 'px';
                    if (dir.includes('n')) win.el.style.top = newTop + 'px';
                }
            },

            onMouseUp(e) {
                if (this.dragging || this.resizing) {
                    this.savePositions();
                    if (!this.locked) {
                        this.updateContainerSize();
                    }
                }
                this.dragging = null;
                this.resizing = null;
            },

            bringToFront(id) {
                const win = this.windows[id];
                win.el.style.zIndex = ++this.zIndexCounter;

                // Update active state
                document.querySelectorAll('.floating-window').forEach(el => el.classList.remove('active'));
                win.el.classList.add('active');
            },

            minimizeWindow(id) {
                const win = this.windows[id];
                win.state = 'minimized';
                win.el.classList.add('minimized');
                this.addToTaskbar(id);
                this.savePositions();
                this.calculateResponsivePositions();
            },

            toggleMaximize(id) {
                const win = this.windows[id];
                if (win.state === 'maximized') {
                    win.state = 'normal';
                    win.el.classList.remove('maximized');
                    if (win.savedPosition) {
                        win.el.style.left = win.savedPosition.left;
                        win.el.style.top = win.savedPosition.top;
                        win.el.style.width = win.savedPosition.width;
                        win.el.style.height = win.savedPosition.height;
                    }
                } else {
                    win.savedPosition = {
                        left: win.el.style.left,
                        top: win.el.style.top,
                        width: win.el.style.width,
                        height: win.el.style.height
                    };
                    win.state = 'maximized';
                    win.el.classList.add('maximized');
                }
                this.savePositions();
            },

            closeWindow(id) {
                const win = this.windows[id];
                win.el.style.display = 'none';
                this.removeFromTaskbar(id);
                if (id === 'logs') {
                    logsSuppressed = true;
                    logsForceVisible = false;
                    // saveLogsPreferences(); // defined elsewhere or commented out to avoid error
                }
                this.savePositions();
                this.calculateResponsivePositions();
            },

            restoreWindow(id) {
                const win = this.windows[id];
                win.el.style.display = 'flex';
                win.el.classList.remove('minimized');
                win.state = 'normal';
                this.bringToFront(id);
                this.removeFromTaskbar(id);
                this.savePositions();
                this.calculateResponsivePositions();
            },

            addToTaskbar(id) {
                // Skiping 'logs' because we have a permanent button for it
                if (id === 'logs') return;

                const win = this.windows[id];
                const taskbar = document.getElementById('taskbar');
                const existing = taskbar.querySelector(`[data-taskbar-id="${id}"]`);
                if (existing) return;

                const item = document.createElement('div');
                item.className = 'taskbar-item';
                item.dataset.taskbarId = id;
                item.textContent = win.el.querySelector('.window-title').textContent;
                item.onclick = () => this.restoreWindow(id);
                taskbar.appendChild(item);
            },

            removeFromTaskbar(id) {
                const taskbar = document.getElementById('taskbar');
                const item = taskbar.querySelector(`[data-taskbar-id="${id}"]`);
                if (item) item.remove();
            },

            savePositions() {
                const positions = {};
                Object.keys(this.windows).forEach(id => {
                    const win = this.windows[id];
                    positions[id] = {
                        left: win.el.style.left,
                        top: win.el.style.top,
                        width: win.el.style.width,
                        height: win.el.style.height,
                        state: win.state,
                        display: win.el.style.display
                    };
                });
                localStorage.setItem('windowPositions', JSON.stringify(positions));
            },

            loadPositions() {
                // Check lock state first
                const lockedState = localStorage.getItem('layoutLocked');
                // Default to true (locked) if not set
                const isLocked = lockedState === null ? true : (lockedState === 'true');

                // If locked, we want fresh responsive layout adapted to current screen, 
                // ignoring potentially stale saved coordinates.
                if (isLocked) {
                    this.ensureAllVisible();
                    this.calculateResponsivePositions();
                    return;
                }

                const saved = localStorage.getItem('windowPositions');
                if (saved) {
                    const positions = JSON.parse(saved);
                    Object.keys(positions).forEach(id => {
                        // Security: Prevent Prototype Pollution by validating keys
                        // Reject dangerous property names that could pollute Object.prototype
                        if (id === '__proto__' || id === 'constructor' || id === 'prototype') {
                            return;
                        }

                        if (this.windows[id]) {
                            const pos = positions[id];
                            const win = this.windows[id];
                            if (pos.left) win.el.style.left = pos.left;
                            if (pos.top) win.el.style.top = pos.top;
                            if (pos.width) win.el.style.width = pos.width;
                            if (pos.height) win.el.style.height = pos.height;
                            if (pos.display) win.el.style.display = pos.display;
                            if (pos.state === 'minimized') {
                                win.state = 'minimized';
                                win.el.classList.add('minimized');
                                this.addToTaskbar(id);
                            } else if (pos.state === 'maximized') {
                                this.toggleMaximize(id);
                            }
                            this.constrainToViewport(win);
                        }
                    });
                    Object.values(this.windows).forEach(win => {
                        if (win.el.dataset.autoHidden === 'true') {
                            win.el.style.display = 'none';
                            win.el.classList.remove('minimized', 'maximized');
                            win.state = 'normal';
                            this.removeFromTaskbar(win.el.dataset.windowId);
                        }
                    });
                    const visibleCount = Object.values(this.windows)
                        .filter(w => w.el.style.display !== 'none').length;
                    if (visibleCount < 3) {
                        this.forceResetLayout();
                    }
                } else {
                    // Set default positions
                    this.setDefaultPositions();
                }
            },

            setDefaultPositions() {
                this.calculateResponsivePositions();
            },

            calculateResponsivePositions() {
                const vw = window.innerWidth;
                const vh = window.innerHeight;
                const padding = 15;
                const statsBar = document.querySelector('.stats-bar');
                const navTabs = document.querySelector('.nav-tabs'); // NEW
                const taskbarEl = document.querySelector('.taskbar');
                const taskbarHeight = taskbarEl ? taskbarEl.offsetHeight : 40;

                // Dynamic header calculation
                let headerTotalHeight = 0;
                if (statsBar) {
                    headerTotalHeight += statsBar.offsetHeight;
                    if (navTabs) {
                        navTabs.style.top = statsBar.offsetHeight + 'px';
                        headerTotalHeight += navTabs.offsetHeight;
                    }
                    headerTotalHeight += padding;
                } else {
                    headerTotalHeight = 180;
                }
                const headerHeight = headerTotalHeight;
                const container = document.getElementById('windowsContainer');

                if (container) {
                    container.style.paddingTop = headerHeight + 'px';
                }

                const availableHeight = Math.max(320, vh - headerHeight - taskbarHeight - padding);
                const isMobile = vw < 768;

                // Default / Auto positions
                // Default / Auto positions - PROCESOWANIE ONLY
                const positions = {
                    'postproc': {
                        left: padding,
                        top: headerHeight,
                        width: availableWidth,
                        height: availableHeight
                    },
                    // Hide others off-screen or rely on display:none
                    'profiles': { left: 0, top: 0, width: 0, height: 0, display: 'none' },
                    'logs': { left: 0, top: 0, width: 0, height: 0, display: 'none' },
                    'control': { left: 0, top: 0, width: 0, height: 0, display: 'none' },
                    'limits': { left: 0, top: 0, width: 0, height: 0, display: 'none' },
                    'preview': { left: 0, top: 0, width: 0, height: 0, display: 'none' }
                };


                Object.keys(positions).forEach(id => {
                    const win = this.windows[id];
                    if (win) {
                        const pos = positions[id];
                        // Apply calculated positions
                        win.el.style.left = pos.left + 'px';
                        win.el.style.top = pos.top + 'px';
                        win.el.style.width = pos.width + 'px';

                        if (pos.height === 'auto') {
                            win.el.style.height = 'auto';
                        } else {
                            win.el.style.height = pos.height + 'px';
                        }

                        this.constrainToViewport(win);
                    }
                });

                this.updateContainerSize();
                this.savePositions();
            },

            toggleLogsWindow() {
                const win = this.windows['logs'];
                if (!win) return;

                const isVisible = win.el.style.display !== 'none' && !win.el.classList.contains('minimized');

                if (isVisible) {
                    // Hide
                    win.el.style.display = 'none';
                    logsSuppressed = true;
                    logsForceVisible = false;
                    this.savePositions();
                } else {
                    // Show
                    win.el.style.display = 'flex';
                    win.el.classList.remove('minimized');
                    win.state = 'normal';
                    logsSuppressed = false;
                    logsForceVisible = true;
                    this.bringToFront('logs');
                    this.constrainToViewport(win);
                    this.savePositions();
                    // Auto-scroll to bottom when opening
                    const logBox = document.getElementById('logBox');
                    if (logBox) logBox.scrollTop = logBox.scrollHeight;
                }
            },

            toggleLayoutLock() {
                this.locked = !this.locked;
                localStorage.setItem('layoutLocked', this.locked);
                this.updateLockButton();
                if (this.locked) {
                    this.handleResize();
                }
            },

            updateLockButton() {
                const btn = document.getElementById('layoutLockBtn');
                if (!btn) return;
                const icon = btn.querySelector('span:nth-child(1)');
                const text = btn.querySelector('span:nth-child(2)');

                if (this.locked) {
                    icon.textContent = 'üîí';
                    text.textContent = 'Uk≈Çad: Auto';
                    btn.classList.add('bg-gray-700', 'text-gray-300');
                    btn.classList.remove('bg-green-600', 'text-white');
                } else {
                    icon.textContent = 'üîì';
                    text.textContent = 'Uk≈Çad: Swobodny';
                    btn.classList.remove('bg-gray-700', 'text-gray-300');
                    btn.classList.add('bg-green-600', 'text-white');
                }
            },

            ensureAllVisible() {
                Object.values(this.windows).forEach(win => {
                    if (win.el.dataset.autoHidden === 'true') {
                        win.el.style.display = 'none';
                        win.el.classList.remove('minimized', 'maximized');
                        win.state = 'normal';
                        this.removeFromTaskbar(win.el.dataset.windowId);
                        return;
                    }
                    win.el.style.display = 'flex';
                    win.el.classList.remove('minimized', 'maximized');
                    win.state = 'normal';
                    this.removeFromTaskbar(win.el.dataset.windowId);
                });
            },

            forceResetLayout() {
                localStorage.removeItem('windowPositions');
                this.locked = true;
                localStorage.setItem('layoutLocked', 'true');
                this.updateLockButton();
                this.ensureAllVisible();
                this.calculateResponsivePositions();
            },

            handleResize() {
                if (!this.locked) return;
                this.ensureAllVisible();
                localStorage.removeItem('windowPositions');
                this.calculateResponsivePositions();
                // Re-apply mobile accordion on resize
                if (this.isMobile()) {
                    this.initMobileAccordion();
                }
            },

            // Mobile detection
            isMobile() {
                return window.innerWidth < 768;
            },

            // Mobile accordion mode
            mobileExpandedWindow: 'profiles',

            initMobileAccordion() {
                if (!this.isMobile()) return;

                const windowOrder = ['profiles', 'limits', 'logs', 'preview', 'control', 'postproc'];
                const savedExpanded = localStorage.getItem('mobileExpandedWindow');
                this.mobileExpandedWindow = savedExpanded && windowOrder.includes(savedExpanded)
                    ? savedExpanded
                    : 'profiles';

                // Add accordion indicators to titlebars
                Object.keys(this.windows).forEach(id => {
                    const win = this.windows[id];
                    const titlebar = win.el.querySelector('.window-titlebar');

                    // Add indicator if not exists
                    if (!titlebar.querySelector('.mobile-accordion-indicator')) {
                        const indicator = document.createElement('span');
                        indicator.className = 'mobile-accordion-indicator';
                        indicator.textContent = '‚ñº';
                        // Insert before window-controls
                        const controls = titlebar.querySelector('.window-controls');
                        titlebar.insertBefore(indicator, controls);
                    }

                    // Add click handler for accordion toggle (on mobile only)
                    if (!titlebar.dataset.accordionInit) {
                        titlebar.dataset.accordionInit = 'true';
                        titlebar.addEventListener('click', (e) => {
                            if (!this.isMobile()) return;
                            if (e.target.closest('.window-controls')) return;
                            this.toggleMobileAccordion(id);
                        });
                    }
                });

                this.applyMobileAccordion();
            },

            toggleMobileAccordion(id) {
                if (this.mobileExpandedWindow === id) {
                    // Already expanded, collapse it
                    this.mobileExpandedWindow = null;
                } else {
                    this.mobileExpandedWindow = id;
                }
                localStorage.setItem('mobileExpandedWindow', this.mobileExpandedWindow || '');
                this.applyMobileAccordion();
            },

            applyMobileAccordion() {
                if (!this.isMobile()) {
                    // Remove mobile classes on non-mobile
                    Object.keys(this.windows).forEach(id => {
                        this.windows[id].el.classList.remove('mobile-collapsed');
                    });
                    return;
                }

                const padding = 10;
                const statsBar = document.querySelector('.stats-bar');
                const headerHeight = statsBar ? statsBar.offsetHeight + padding : 150;
                const taskbarHeight = 50;
                const collapsedHeight = 44;

                const windowOrder = ['profiles', 'limits', 'logs', 'preview', 'control', 'postproc'];
                const visibleWindows = windowOrder.filter(id => {
                    const win = this.windows[id];
                    return win && win.el && win.el.style.display !== 'none';
                });

                let currentTop = 0;
                const totalCollapsedHeight = (visibleWindows.length - 1) * (collapsedHeight + padding);
                const availableHeight = window.innerHeight - headerHeight - taskbarHeight - totalCollapsedHeight - padding;
                const expandedHeight = Math.max(200, availableHeight);

                visibleWindows.forEach(id => {
                    const win = this.windows[id];
                    const isExpanded = (id === this.mobileExpandedWindow);

                    win.el.style.left = padding + 'px';
                    win.el.style.top = currentTop + 'px';
                    win.el.style.width = (window.innerWidth - padding * 2) + 'px';

                    if (isExpanded) {
                        win.el.classList.remove('mobile-collapsed');
                        win.el.style.height = expandedHeight + 'px';
                        currentTop += expandedHeight + padding;
                    } else {
                        win.el.classList.add('mobile-collapsed');
                        win.el.style.height = collapsedHeight + 'px';
                        currentTop += collapsedHeight + padding;
                    }
                });

                // Update container height
                const container = document.getElementById('windowsContainer');
                if (container) {
                    container.style.minHeight = (currentTop + padding) + 'px';
                }
            }
        };

        // Add resize listener
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => windowManager.handleResize(), 250);
        });

        // --- Status Logic ---
        let isRunning = false;
        let wasRunning = false;
        let runningProfiles = new Set();
        let lastStats = null;
        let selectedPreviewProfile = null;
        let lastProfilesRowCount = null;
        let lastProgressVisible = null;
        let logsEverStarted = false;
        let logsSuppressed = false;
        let logsForceVisible = false;
        const LOGS_PREF_KEY = 'ocrLogsPreference';
        const LAST_JOB_PARAMS_KEY = 'lastJobParams';
        let lastJobParams = null;
        const controlDefaults = {
            source_path: '',
            profiles: [],
            workers: {{ default_workers | default (2) | tojson }},
        scans_per_worker: { { default_scans_per_worker | default (2) | tojson } },
        batch_id: '',
            headed: true,
                engine: 'auto',
                    continue_mode: true,
                        pro_only: true,
                            collect_timeout_sec: 400,
                                pg_enabled: true,
                                    pg_dsn: 'postgresql://tomaasz:123Karinka!%40%23@127.0.0.1:5432/ocr',
                                        pg_table: 'public.ocr_raw_texts',
                                            clean_temp_images: true,
                                                browser_id: '',
                                                    use_custom_profile: false,
                                                        custom_profile: '',
                                                            preproc_max_dimension: 2500,
                                                                preproc_median_kernel: 3,
                                                                    preproc_denoise_strength: 8,
                                                                        preproc_clahe_clip_limit: 2.0,
                                                                            preproc_clahe_grid_size: '8,8',
                                                                                preproc_morph_kernel_size: 2,
                                                                                    preproc_unsharp_amount: 1.2,
                                                                                        preproc_unsharp_radius: 1,
                                                                                            preproc_margin_percent: 0.05,
                                                                                                preproc_dark_threshold: 60,
                                                                                                    preproc_margin_ink_ratio_max: 0.01,
                                                                                                        preproc_margin_shadow_mean_max: 200,
                                                                                                            preproc_background_kernel_ratio: 0.025,
                                                                                                                preproc_background_kernel_min: 31,
                                                                                                                    preproc_local_contrast_sigma: 12.0,
                                                                                                                        preproc_local_contrast_amount: 0.35,
                                                                                                                            preproc_blackhat_kernel_size: 5,
                                                                                                                                preproc_blackhat_strength: 0.45,
                                                                                                                                    preproc_enable_adaptive_binarization: false,
                                                                                                                                        preproc_sauvola_window: 31,
                                                                                                                                            preproc_sauvola_k: 0.2,
                                                                                                                                                preproc_sauvola_r: 128.0,
                                                                                                                                                    preproc_text_mask_block_size: 31,
                                                                                                                                                        preproc_text_mask_c: 12,
                                                                                                                                                            preproc_text_mask_open_kernel: 3,
                                                                                                                                                                preproc_text_mask_close_kernel: 9,
                                                                                                                                                                    preproc_text_mask_close_iters: 2,
                                                                                                                                                                        preproc_text_mask_dilate_iters: 1,
                                                                                                                                                                            preproc_text_mask_min_area_ratio: 0.0005,
                                                                                                                                                                                preproc_trim_band_ratio: 0.02,
                                                                                                                                                                                    preproc_trim_ink_ratio_max: 0.02,
                                                                                                                                                                                        preproc_trim_max_ratio: 0.15,
                                                                                                                                                                                            preproc_trim_min_dimension: 200
        };

        let currentControlTab = 'basic';
        let lastLimitStatus = null;
        let profileCatalog = new Set();
        let profileCatalogDirty = false;
        const profileCatalogSources = {
            disk: new Set(),
            stats: new Set(),
            jobs: new Set(),
            limits: new Set()
        };
        let profileSelectionSeeded = false;
        let limitSelectionSeeded = false;
        let limitLastResultMap = {};
        const LIMIT_CHECK_HOST_KEY = 'ocrLimitCheckHost';
        const DEFAULT_LIMIT_CHECK_HOST = (typeof LIMIT_WORKER_URL === 'string' && LIMIT_WORKER_URL && LIMIT_WORKER_URL.trim())
            ? 'remote'
            : 'local';

        const tabFieldMap = {
            'basic': ['source_path', 'profiles', 'workers', 'batch_id', 'headed', 'engine', 'use_custom_profile', 'custom_profile'],
            'performance': ['scans_per_worker', 'collect_timeout_sec'],
            'database': ['pg_enabled', 'pg_dsn', 'pg_table'],
            'preprocess': Object.keys(controlDefaults).filter(k => k.startsWith('preproc_')),
            'advanced': ['continue_mode', 'pro_only', 'browser_id', 'clean_temp_images']
        };

        const SESSION_START_KEY = 'ocrSessionStartMs';
        let sessionStartMs = sessionStorage.getItem(SESSION_START_KEY);
        if (!sessionStartMs || Number.isNaN(Number(sessionStartMs))) {
            sessionStartMs = Date.now().toString();
            sessionStorage.setItem(SESSION_START_KEY, sessionStartMs);
        }
        const AUTO_RESTART_COOLDOWN_MS = 5 * 60 * 1000;
        const AUTO_RESTART_KEY_PREFIX = 'ocrAutoRestartTs.';

        function formatTokenCount(value) {
            if (value === null || value === undefined || Number.isNaN(Number(value))) return '-';
            const num = Number(value);
            if (num >= 1_000_000) return `${(num / 1_000_000).toFixed(1)}m`;
            if (num >= 1_000) return `${(num / 1_000).toFixed(1)}k`;
            return String(Math.round(num));
        }

        function formatLimitTime(iso) {
            if (!iso) return '-';
            const d = new Date(iso);
            if (Number.isNaN(d.getTime())) return '-';
            return d.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function formatLimitAge(sec) {
            if (sec === null || sec === undefined) return '-';
            if (sec < 60) return `${sec}s`;
            if (sec < 3600) return `${Math.round(sec / 60)}m`;
            return `${Math.round(sec / 3600)}h`;
        }

        async function readJsonSafely(response) {
            const text = await response.text();
            if (!text) {
                return response.ok ? {} : { detail: `HTTP ${response.status}` };
            }
            try {
                return JSON.parse(text);
            } catch (e) {
                const preview = text.replace(/\s+/g, ' ').trim().slice(0, 200);
                return { detail: preview || 'Invalid JSON response' };
            }
        }


        async function refreshPanelWindow(windowId) {
            setActionMsg(`Od≈õwie≈ºanie okna: ${windowId}...`, "text-blue-400");
            try {
                if (windowId === 'limits') {
                    await updateLimitStatus();
                    setActionMsg("Od≈õwie≈ºono limity.", "text-green-400");
                    return;
                }
                if (windowId === 'preview') {
                    await updateStats();
                    await updateLivePreviews();
                    setActionMsg("Od≈õwie≈ºono podglƒÖd.", "text-green-400");
                    return;
                }
                if (windowId === 'logs') {
                    await updateLogs(true); // Force refresh
                    setActionMsg("Od≈õwie≈ºono logi.", "text-green-400");
                    return;
                }
                await updateStats();
                setActionMsg("Od≈õwie≈ºono dane.", "text-green-400");
            } catch (e) {
                console.error("Refresh error:", e);
                setActionMsg("B≈ÇƒÖd od≈õwie≈ºania.", "text-red-400");
            }
        }

        async function syncProfiles() {
            if (!confirm("Czy na pewno chcesz zsynchronizowaƒá profile? Lokalne profile z tego serwera nadpiszƒÖ profile na zdalnym workerze (1DTW2-1).")) {
                return;
            }

            const btn = document.getElementById('syncProfilesBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>‚è≥</span> Trwa synchronizacja...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/profiles/sync', { method: 'POST' });
                const data = await readJsonSafely(response);

                if (response.ok) {
                    alert("Sukces:\n" + (data.output || data.detail));
                    setActionMsg("Synchronizacja zako≈Ñczona pomy≈õlnie.", "text-green-400");
                } else {
                    alert("B≈ÇƒÖd:\n" + (data.detail || "Unknown error"));
                    setActionMsg("B≈ÇƒÖd synchronizacji.", "text-red-400");
                }
            } catch (e) {
                alert("B≈ÇƒÖd po≈ÇƒÖczenia: " + e);
                setActionMsg("B≈Çad po≈ÇƒÖczenia.", "text-red-400");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function initLimitCheckHost() {
            const select = document.getElementById('limitCheckHost');
            if (!select) return;
            const saved = localStorage.getItem(LIMIT_CHECK_HOST_KEY);
            let value = saved || DEFAULT_LIMIT_CHECK_HOST;
            const remoteOption = select.querySelector('option[value="remote"]');
            // Ensure remote option is enabled since we have a fallback
            const hasRemote = true; // Hardcoded fallback ensures this is always true
            if (!hasRemote && remoteOption) {
                remoteOption.disabled = true;
                if (value === 'remote') value = 'local';
            }
            select.value = value;
            localStorage.setItem(LIMIT_CHECK_HOST_KEY, value);
            select.addEventListener('change', () => {
                if (select.value === 'remote' && !hasRemote) {
                    setActionMsg("Brak skonfigurowanego zdalnego hosta.", "text-red-400");
                    select.value = 'local';
                }
                localStorage.setItem(LIMIT_CHECK_HOST_KEY, select.value);
            });
        }

        function getLimitCheckHost() {
            const select = document.getElementById('limitCheckHost');
            return select ? select.value : DEFAULT_LIMIT_CHECK_HOST;
        }

        function updateLimitPanel(data) {
            lastLimitStatus = data || null;
            const lastRunEl = document.getElementById('limitLastRun');
            const lastAgeEl = document.getElementById('limitLastAge');
            const sessionRunsEl = document.getElementById('limitSessionRuns');
            const runIdEl = document.getElementById('limitRunId');
            const tbody = document.getElementById('limitStatusTableBody');

            const status = data && data.status ? data.status : {};
            const session = data && data.session ? data.session : {};
            const pauses = data && data.pauses ? data.pauses : {};
            const lastAny = data && data.last_any ? data.last_any : {};
            const recentRuns = data && data.recent_runs ? data.recent_runs : [];

            lastRunEl.textContent = formatLimitTime(status.run_at);
            lastAgeEl.textContent = formatLimitAge(data.last_age_sec);
            runIdEl.textContent = status.run_id || '-';
            sessionRunsEl.textContent = session.total_runs || 0;

            const statusMap = {};
            (status.results || []).forEach(item => {
                statusMap[item.profile] = item.status;
            });

            const limitProfiles = new Set();
            [
                Object.keys(statusMap || {}),
                Object.keys(lastAny || {}),
                Object.keys(session.counts || {}),
                Object.keys(pauses || {})
            ].forEach(list => {
                (list || []).forEach(name => {
                    if (name) limitProfiles.add(name);
                });
            });
            if (lastStats && Array.isArray(lastStats.profiles)) {
                lastStats.profiles.forEach(p => {
                    if (p && p.name) limitProfiles.add(p.name);
                });
            }
            updateProfileSource('limits', Array.from(limitProfiles));
            syncProfileLists();

            const rows = [];
            const profiles = getUnifiedProfileList();
            limitLastResultMap = {};
            profiles.forEach(profile => {
                const count = (session.counts && session.counts[profile]) || 0;
                const last = (session.last && session.last[profile]) || {};
                const lastAnyEntry = lastAny[profile] || {};
                let lastStatus = lastAnyEntry.status || last.status || statusMap[profile] || '-';
                const lastRun = lastAnyEntry.run_at || last.run_at || (statusMap[profile] ? status.run_at : null);
                const pause = pauses[profile] || {};
                const pauseUntil = pause.until || null;
                const pauseActive = pauseUntil && new Date(pauseUntil) > new Date();

                let statusClass = "text-gray-300";
                if (String(lastStatus).includes("LIMIT")) statusClass = "text-red-400 font-semibold";
                if (String(lastStatus).includes("OK")) statusClass = "text-green-400 font-semibold";
                if (String(lastStatus).includes("SKIPPED")) statusClass = "text-gray-500";

                const source = pause.source || pause.reason || (status.run_id ? "precheck" : "-");
                const pauseLabel = pauseActive ? formatLimitTime(pauseUntil) : "-";
                limitLastResultMap[profile] = { lastStatus, lastRun };

                // Get duration from stored data if available
                const checkData = (data && data.check_durations && data.check_durations[profile]) || {};
                const durationMs = checkData.duration_ms || null;
                let durationLabel = '-';
                if (durationMs !== null) {
                    if (durationMs < 1000) {
                        durationLabel = `${durationMs}ms`;
                    } else {
                        durationLabel = `${(durationMs / 1000).toFixed(1)}s`;
                    }
                }

                rows.push(`
                    <tr>
                        <td class="px-3 py-2 text-white">${profile}</td>
                        <td class="px-3 py-2">${count}</td>
                        <td class="px-3 py-2 ${statusClass}">${lastStatus}</td>
                        <td class="px-3 py-2">${formatLimitTime(lastRun)}</td>
                        <td class="px-3 py-2 text-gray-400">${durationLabel}</td>
                        <td class="px-3 py-2 ${pauseActive ? 'text-yellow-400' : ''}">${pauseLabel}</td>
                        <td class="px-3 py-2 text-gray-400">${source}</td>
                    </tr>
                `);
            });

            tbody.innerHTML = rows.length
                ? rows.join('')
                : "<tr><td colspan='7' class='px-3 py-3 text-center text-gray-500'>Brak danych</td></tr>";

            const recentEl = document.getElementById('limitRecentRuns');
            if (recentEl) {
                if (!recentRuns.length) {
                    recentEl.innerHTML = "<span class='text-gray-500'>Brak historii</span>";
                } else {
                    recentEl.innerHTML = recentRuns.map(r => {
                        const at = formatLimitTime(r.run_at);
                        let dur = '-';
                        if (r.duration !== undefined && r.duration !== null) {
                            dur = r.duration < 1000 ? r.duration + 'ms' : (r.duration / 1000).toFixed(1) + 's';
                        }
                        return `<div class="flex items-center justify-between gap-2">
                            <span class="text-gray-400 whitespace-nowrap">${at}</span>
                            <span class="text-gray-300">ok:${r.ok} limit:${r.limit} err:${r.error}</span>
                            <span class="text-blue-300 whitespace-nowrap ml-auto">${dur}</span>
                            <span class="text-[10px] text-gray-500 bg-gray-800 px-1 rounded whitespace-nowrap" title="${r.host || 'unknown'}">${r.host === '100.102.158.100' ? 'Remote' : (r.host || 'local')}</span>
                            <span class="text-gray-500 text-[10px] whitespace-nowrap">#${r.run_id ? r.run_id.slice(-4) : '-'}</span>
                        </div>`;
                    }).join('');
                }
            }

            const profileListEl = document.getElementById('limitProfileList');
            if (profileListEl) {
                const items = Array.from(profiles).sort();
                profileListEl.innerHTML = items.map(p => `
                    <label class="flex items-center gap-2 text-xs text-gray-300">
                        <input type="checkbox" class="limit-profile-checkbox" value="${p}">
                        <span class="truncate">${p}</span>
                    </label>
                `).join('');
                if (!limitSelectionSeeded) {
                    selectLimitProfiles('all');
                    limitSelectionSeeded = true;
                }
            }
        }

        async function updateLimitStatus() {
            try {
                const res = await fetch(`/api/limits/status?session_start=${encodeURIComponent(sessionStartMs)}`);
                if (!res.ok) return;
                const data = await readJsonSafely(res);
                updateLimitPanel(data);
            } catch (e) {
                console.error("Limit status fetch failed", e);
            }
        }

        // Track limit check state
        let limitCheckStartTime = null;
        let limitCheckTimer = null;
        let isLimitCheckRunning = false;
        let currentLimitCheckPid = null;

        async function runLimitCheck() {
            const btn = document.getElementById('limitRunBtn');
            const statusEl = document.getElementById('limitRunStatus');
            const progressEl = document.getElementById('limitCheckProgress');
            const modeLabel = document.getElementById('limitCheckModeLabel');
            const profileLabel = document.getElementById('limitCheckCurrentProfile');
            const progressText = document.getElementById('limitCheckProgressText');
            const modeBadge = document.getElementById('limitCheckMode');

            // If already running, STOP it
            if (isLimitCheckRunning) {
                await stopLimitCheck();
                return;
            }

            // Start timer for elapsed time
            isLimitCheckRunning = true;
            limitCheckStartTime = Date.now();
            btn.classList.remove('bg-amber-600', 'hover:bg-amber-500');
            btn.classList.add('bg-red-500', 'hover:bg-red-400');
            btn.innerHTML = '‚èπ Zatrzymaj <span id="limitCheckTimer">0s</span>';

            // Show progress section
            progressEl.classList.remove('hidden');
            modeLabel.textContent = 'Sprawdzam...';
            profileLabel.textContent = '-';
            progressText.textContent = '-';

            // Update timer every second
            if (limitCheckTimer) clearInterval(limitCheckTimer);
            limitCheckTimer = setInterval(() => {
                if (!limitCheckStartTime) return;
                const elapsed = Math.floor((Date.now() - limitCheckStartTime) / 1000);
                const timerEl = document.getElementById('limitCheckTimer');
                if (timerEl) timerEl.textContent = `${elapsed}s`;
            }, 1000);

            statusEl.textContent = "Uruchamiam...";

            try {
                const checkboxes = Array.from(document.querySelectorAll('.limit-profile-checkbox:checked'));
                const profiles = checkboxes.map(el => el.value);
                const quickEl = document.getElementById('limitQuickMode');
                const quick = quickEl ? !!quickEl.checked : false;
                const host = getLimitCheckHost();
                const res = await fetch('/api/limits/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: profiles.length
                        ? JSON.stringify({ profiles, quick, host })
                        : JSON.stringify({ quick, host })
                });
                let data = null;
                try {
                    data = await readJsonSafely(res);
                } catch (e) {
                    data = null;
                }
                if (!res.ok) {
                    const detail = data && (data.detail || data.error) ? (data.detail || data.error) : `HTTP ${res.status}`;
                    statusEl.textContent = `B≈ÇƒÖd: ${detail}`;
                    resetLimitCheckButton();
                } else {
                    // Determine mode from response
                    const source = data?.source || 'local';
                    const isRemote = source === 'remote_worker';

                    // Show mode badge
                    modeBadge.classList.remove('hidden', 'bg-blue-600', 'bg-purple-600');
                    modeBadge.classList.add(isRemote ? 'bg-purple-600' : 'bg-blue-600');
                    modeBadge.textContent = isRemote ? '100.102.158.100' : '100.127.229.84';
                    modeLabel.textContent = isRemote ? `100.102.158.100 (${data.worker_url || 'worker'})` : '100.127.229.84 (subprocess)';

                    if (data?.status === 'completed') {
                        // Remote worker returned results immediately
                        const results = data?.results?.results || [];
                        const summary = data?.results?.summary || {};
                        profileLabel.textContent = `Zako≈Ñczono ${results.length} profili`;
                        progressText.textContent = `‚úÖ ${summary.ok || 0} OK, ‚õî ${summary.limited || 0} LIMIT, ‚ùå ${summary.error || 0} ERROR`;
                        statusEl.textContent = 'Zako≈Ñczono!';
                        setTimeout(resetLimitCheckButton, 3000);
                    } else {
                        currentLimitCheckPid = data?.pid || null;
                        statusEl.textContent = `PID: ${data?.pid || '?'} - lokalny check`;
                        profileLabel.textContent = `${profiles.length || 'Wszystkie'} profili`;
                        progressText.textContent = 'W toku...';
                        // Auto-reset after longer time (checks can take 2-3 min now)
                        setTimeout(() => {
                            if (isLimitCheckRunning) {
                                resetLimitCheckButton();
                            }
                        }, 180000); // 3 minutes max
                    }
                }
            } catch (e) {
                statusEl.textContent = "B≈ÇƒÖd uruchomienia";
                resetLimitCheckButton();
            }
        }

        async function stopLimitCheck() {
            const statusEl = document.getElementById('limitRunStatus');
            statusEl.textContent = "Zatrzymywanie...";

            try {
                const res = await fetch('/api/limits/stop', { method: 'POST' });
                const data = await readJsonSafely(res);
                if (data.status === 'stopped') {
                    statusEl.textContent = `Zatrzymano PID: ${data.pid}`;
                } else if (data.status === 'not_running') {
                    statusEl.textContent = "Proces ju≈º nie dzia≈Ça≈Ç";
                } else {
                    statusEl.textContent = `Status: ${data.status}`;
                }
            } catch (e) {
                statusEl.textContent = "B≈ÇƒÖd zatrzymania";
            }

            resetLimitCheckButton();
        }

        function resetLimitCheckButton() {
            const btn = document.getElementById('limitRunBtn');
            const progressEl = document.getElementById('limitCheckProgress');
            const modeBadge = document.getElementById('limitCheckMode');
            if (limitCheckTimer) {
                clearInterval(limitCheckTimer);
                limitCheckTimer = null;
            }
            limitCheckStartTime = null;
            isLimitCheckRunning = false;
            currentLimitCheckPid = null;
            btn.classList.remove('bg-red-500', 'hover:bg-red-400', 'bg-yellow-500', 'animate-pulse');
            btn.classList.add('bg-amber-600', 'hover:bg-amber-500');
            btn.innerHTML = 'Sprawd≈∫ teraz';
            // Hide progress section after short delay
            setTimeout(() => {
                if (progressEl) progressEl.classList.add('hidden');
                if (modeBadge) modeBadge.classList.add('hidden');
            }, 60000);
            updateLimitStatus();
        }


        function selectLimitProfiles(mode) {
            const boxes = Array.from(document.querySelectorAll('.limit-profile-checkbox'));
            if (mode === 'none') {
                boxes.forEach(b => b.checked = false);
                return;
            }
            if (mode === 'all') {
                boxes.forEach(b => {
                    if (!b.disabled) b.checked = true;
                });
                return;
            }
            if (mode === 'active') {
                const active = new Set((lastStats && lastStats.profiles || []).filter(p => String(p.status || '').includes("AKTYWNY")).map(p => p.name));
                boxes.forEach(b => { b.checked = !b.disabled && active.has(b.value); });
                return;
            }
            if (mode === 'paused') {
                const pauses = (lastLimitStatus && lastLimitStatus.pauses) ? lastLimitStatus.pauses : {};
                const now = new Date();
                const paused = new Set(Object.entries(pauses).filter(([, v]) => {
                    if (!v || !v.until) return false;
                    const dt = new Date(v.until);
                    return !Number.isNaN(dt.getTime()) && dt > now;
                }).map(([k]) => k));
                boxes.forEach(b => { b.checked = !b.disabled && paused.has(b.value); });
            }
        }

        function updateProfileStatsBadges() {
            if (!lastStats || !lastStats.profiles) return;
            const map = {};
            lastStats.profiles.forEach(p => { map[p.name] = p; });
            document.querySelectorAll('[data-profile-stats]').forEach(el => {
                const name = el.getAttribute('data-profile-stats');
                const p = map[name];
                if (!p) {
                    el.textContent = 'tok: -';
                    return;
                }
                const perScan = formatTokenCount(p.pro_tokens_per_scan);
                const today = formatTokenCount(p.pro_tokens_today);
                const remB = formatTokenCount(p.pro_tokens_remaining_implied);
                const remC = formatTokenCount(p.pro_tokens_remaining_pace);
                el.textContent = `tok/scan ${perScan} | today ${today} | rem B=${remB} C=${remC}`;
            });

            document.querySelectorAll('[data-profile-chrome]').forEach(el => {
                const name = el.getAttribute('data-profile-chrome');
                fetch(`/api/profiles/active-dir?profile=${encodeURIComponent(name)}`)
                    .then(res => res.ok ? readJsonSafely(res) : null)
                    .then(data => {
                        if (!data) return;
                        el.textContent = `chrome: ${data.active_dir || '-'}`;
                    })
                    .catch(() => { });
            });
        }

        function updateProfileActionButtons() {
            document.querySelectorAll('[data-profile-start]').forEach(btn => {
                const name = btn.getAttribute('data-profile-start');
                const isActive = runningProfiles.has(name);
                btn.disabled = isActive;
                btn.classList.toggle('opacity-40', isActive);
                btn.classList.toggle('cursor-not-allowed', isActive);
            });
            document.querySelectorAll('[data-profile-stop]').forEach(btn => {
                const name = btn.getAttribute('data-profile-stop');
                const isActive = runningProfiles.has(name);
                btn.disabled = !isActive;
                btn.classList.toggle('opacity-40', !isActive);
                btn.classList.toggle('cursor-not-allowed', !isActive);
            });
        }

        function loadLogsPreferences() {
            const raw = localStorage.getItem(LOGS_PREF_KEY);
            if (!raw) return;
            try {
                const pref = JSON.parse(raw);
                logsForceVisible = !!pref.forceVisible;
                logsSuppressed = !!pref.suppressed && !logsForceVisible;
            } catch (e) {
                console.warn('Invalid logs preference, resetting', e);
                localStorage.removeItem(LOGS_PREF_KEY);
            }
        }

        function saveLogsPreferences() {
            localStorage.setItem(LOGS_PREF_KEY, JSON.stringify({
                forceVisible: logsForceVisible,
                suppressed: logsSuppressed
            }));
        }

        function updateLogsTaskbarButton() {
            const btn = document.getElementById('taskbarLogsToggle');
            const logsWin = document.getElementById('window-logs');
            if (!btn || !logsWin) return;
            if (!isRunning) {
                btn.classList.add('hidden');
                return;
            }
            btn.classList.remove('hidden');
            const isVisible = logsWin.style.display !== 'none';
            if (isVisible) {
                btn.textContent = 'Ukryj logi';
            } else {
                btn.textContent = 'Poka≈º logi';
            }
        }

        function updateLogsStoppedButtonStyle() {
            const stoppedBtn = document.getElementById('taskbarLogsShowStopped');
            const note = document.getElementById('taskbarLogsNote');
            if (!stoppedBtn) return;
            if (isRunning) {
                stoppedBtn.classList.remove('bg-blue-700/70', 'hover:bg-blue-600', 'border-blue-400/60', 'text-blue-100');
                stoppedBtn.classList.add('bg-gray-700/70', 'hover:bg-gray-600', 'border-gray-500/60', 'text-gray-200');
            } else {
                stoppedBtn.classList.remove('bg-gray-700/70', 'hover:bg-gray-600', 'border-gray-500/60', 'text-gray-200');
                stoppedBtn.classList.add('bg-blue-700/70', 'hover:bg-blue-600', 'border-blue-400/60', 'text-blue-100');
            }
            if (note) {
                const showNote = !isRunning && !stoppedBtn.classList.contains('hidden');
                note.classList.toggle('hidden', !showNote);
            }
        }

        function setLogsVisible(visible) {
            const logsWin = document.getElementById('window-logs');
            if (!logsWin) return;
            if (visible) {
                logsWin.dataset.autoHidden = 'false';
                logsWin.style.display = 'flex';
                logsWin.classList.remove('minimized', 'maximized');
                if (windowManager && windowManager.windows && windowManager.windows.logs) {
                    windowManager.removeFromTaskbar('logs');
                    if (windowManager.locked) {
                        windowManager.calculateResponsivePositions();
                    } else {
                        windowManager.updateContainerSize();
                    }
                }
            } else {
                logsWin.dataset.autoHidden = 'true';
                logsWin.style.display = 'none';
                logsWin.classList.remove('minimized', 'maximized');
                if (windowManager) {
                    windowManager.removeFromTaskbar('logs');
                    if (windowManager.locked) {
                        windowManager.calculateResponsivePositions();
                    } else {
                        windowManager.updateContainerSize();
                    }
                }
            }
            updateLogsTaskbarButton();
        }

        function toggleLogsVisibility() {
            if (!isRunning) {
                setLogsVisible(false);
                return;
            }
            const logsWin = document.getElementById('window-logs');
            if (!logsWin) return;
            const isVisible = logsWin.style.display !== 'none';
            if (isVisible) {
                logsSuppressed = true;
                logsForceVisible = false;
                setLogsVisible(false);
            } else {
                logsForceVisible = true;
                logsSuppressed = false;
                logsEverStarted = logsEverStarted || isRunning;
                setLogsVisible(true);
            }
            saveLogsPreferences();
        }

        function syncLivePreviewVisibility() {
            const previewWin = document.getElementById('window-preview');
            const logsWin = document.getElementById('window-logs');
            if (!previewWin && !logsWin) {
                wasRunning = isRunning;
                return;
            }

            if (isRunning && !wasRunning) {
                logsEverStarted = true;
                if (previewWin) {
                    previewWin.dataset.autoHidden = 'false';
                    previewWin.style.display = 'flex';
                    previewWin.classList.remove('minimized');
                }
                if (windowManager && windowManager.windows && windowManager.windows.preview) {
                    windowManager.removeFromTaskbar('preview');
                }
                if (windowManager) {
                    if (windowManager.locked) {
                        windowManager.calculateResponsivePositions();
                    } else {
                        windowManager.updateContainerSize();
                    }
                }
                const shouldShowLogs = logsForceVisible || !logsSuppressed;
                setLogsVisible(shouldShowLogs);
            } else if (!isRunning && wasRunning) {
                if (previewWin) {
                    previewWin.dataset.autoHidden = 'true';
                    previewWin.style.display = 'none';
                    previewWin.classList.remove('minimized', 'maximized');
                }
                if (windowManager) {
                    windowManager.removeFromTaskbar('preview');
                    if (windowManager.locked) {
                        windowManager.calculateResponsivePositions();
                    } else {
                        windowManager.updateContainerSize();
                    }
                }
                setLogsVisible(false);
            } else if (!isRunning) {
                if (logsWin && logsWin.style.display !== 'none') {
                    setLogsVisible(false);
                } else {
                    updateLogsTaskbarButton();
                }
            } else {
                updateLogsTaskbarButton();
            }

            wasRunning = isRunning;
        }

        const POLL_ACTIVE_MS = 1000;  // 1 sekunda - 5x szybsze od≈õwie≈ºanie
        const POLL_HIDDEN_MS = 20000;
        let statsTimer = null;

        function scheduleNextStatsPoll(delayMs) {
            if (statsTimer) {
                clearTimeout(statsTimer);
            }
            statsTimer = setTimeout(updateStats, delayMs);
        }

        async function parseJsonSafe(res) {
            const text = await res.text();
            if (!text) return {};
            try {
                return JSON.parse(text);
            } catch (e) {
                throw new Error(`Bad JSON (${res.status}): ${text.slice(0, 120)}`);
            }
        }

        async function updateStats() {
            try {
                const summaryRes = await fetch(`/api/summary?session_start=${encodeURIComponent(sessionStartMs)}`);
                if (!summaryRes.ok) {
                    throw new Error(`HTTP ${summaryRes.status}`);
                }
                const summary = await parseJsonSafe(summaryRes);
                const jobData = summary.job || { running: false };
                const data = summary.stats || {};

                isRunning = !!jobData.running;
                runningProfiles = new Set(jobData.profiles || []);
                updateProfileSource('jobs', jobData.profiles || []);

                const statusEl = document.getElementById('jobStatus');
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');

                if (isRunning) {
                    statusEl.textContent = "URUCHOMIONE (PID: " + jobData.pid + ")";
                    statusEl.classList.add("text-green-400");
                    statusEl.classList.remove("text-white", "text-red-400");
                    startBtn.classList.add("hidden");
                    stopBtn.classList.remove("hidden");
                } else {
                    statusEl.textContent = "ZATRZYMANE";
                    statusEl.classList.remove("text-green-400");
                    statusEl.classList.add("text-white");
                    startBtn.classList.remove("hidden");
                    stopBtn.classList.add("hidden");
                }
                setControlPanelLocked(isRunning);
                syncLivePreviewVisibility();
                updateLogsStoppedButtonStyle();

                lastStats = data;
                const statsProfiles = Array.isArray(data && data.profiles) ? data.profiles.map(p => p.name) : [];
                updateProfileSource('stats', statsProfiles);
                syncProfileLists();

                if (data && data.error) {
                    document.getElementById('connectionStatus').classList.remove("text-green-500");
                    document.getElementById('connectionStatus').classList.add("text-red-500");
                    scheduleNextStatsPoll(document.hidden ? POLL_HIDDEN_MS : POLL_ACTIVE_MS);
                    return;
                }

                if (!data || !data.profiles) {
                    document.getElementById('connectionStatus').classList.remove("text-green-500");
                    document.getElementById('connectionStatus').classList.add("text-red-500");
                    scheduleNextStatsPoll(document.hidden ? POLL_HIDDEN_MS : POLL_ACTIVE_MS);
                    return;
                }

                document.getElementById('connectionStatus').classList.add("text-green-500");
                document.getElementById('connectionStatus').classList.remove("text-red-500");

                const fmtEst = (val) => (val === null || val === undefined ? 0 : val);
                const fmtEstLine = (label, val, emptyTitle) => {
                    const isEmpty = val === null || val === undefined;
                    const titleAttr = isEmpty && emptyTitle ? ` title="${emptyTitle}"` : '';
                    const cls = isEmpty ? ' class="text-gray-500"' : '';
                    return `<div${cls}${titleAttr}>${label}:${fmtEst(val)}</div>`;
                };
                const fmtEstLines = (a, b, c) => (
                    `${fmtEstLine('A', a, 'Brak OCR_PRO_DAILY_LIMIT (limit dzienny nieustawiony)')}` +
                    `${fmtEstLine('B', b, 'Brak PRO LIMIT detected w dzisiejszych logach')}` +
                    `${fmtEstLine('C', c, 'Brak danych tempa (brak aktywnej sesji)')}`
                );
                const fmtRate = (val) => (val === null || val === undefined || Number.isNaN(Number(val)))
                    ? '-'
                    : Number(val).toFixed(2);
                const allDone = Array.isArray(data.profiles) && data.profiles.length > 0 && data.profiles.every(p => p.all_done);
                if (allDone && isRunning) {
                    setActionMsg("‚úÖ Wszystkie pliki sƒÖ ju≈º przetworzone.", "text-green-400");
                } else if (!isRunning) {
                    setActionMsg("");
                }

                document.getElementById('sessionDoneCount').textContent = data.grand_total_done;
                document.getElementById('dbTodayCount').textContent = data.db_today_count !== undefined ? data.db_today_count : '-';
                document.getElementById('activeWorkers').textContent = isRunning ? data.grand_total_workers : 0;
                const nonProCount = isRunning ? (data.non_pro_rejected_total || 0) : 0;
                const nonProEl = document.getElementById('nonProRejectedCount');
                if (nonProEl) nonProEl.textContent = nonProCount;
                const proEstEl = document.getElementById('proRemainingEst');
                if (proEstEl) {
                    proEstEl.innerHTML = fmtEstLines(
                        data.pro_remaining_config_total,
                        data.pro_remaining_implied_total,
                        data.pro_remaining_pace_total
                    );
                }
                updateProfileStatsBadges();
                updateProfileActionButtons();

                const batchIds = data.batch_ids ? data.batch_ids.join(', ') : 'brak';
                document.getElementById('currentBatchId').textContent = batchIds.length > 20 ? batchIds.substring(0, 20) + '...' : batchIds;

                // Update Table
                const tbody = document.getElementById('profilesTableBody');
                tbody.innerHTML = '';

                const profileMap = {};
                (data.profiles || []).forEach(p => { profileMap[p.name] = p; });
                const tableProfiles = getUnifiedProfileList();
                tableProfiles.forEach(name => {
                    const p = profileMap[name] || {
                        name,
                        workers: 0,
                        done_today: 0,
                        status: "",
                        limit_reset: "-",
                        pro_remaining_config: null,
                        pro_remaining_implied: null,
                        pro_remaining_pace: null,
                        last_done_session: null,
                    };
                    const row = document.createElement('tr');
                    let statusColor = "text-gray-400";
                    let displayStatus = p.status;
                    let displayWorkers = p.workers;
                    let displayDoneToday = p.done_today;
                    const proEstText = fmtEstLines(
                        p.pro_remaining_config,
                        p.pro_remaining_implied,
                        p.pro_remaining_pace
                    );

                    if (!isRunning) {
                        displayStatus = "";
                        displayWorkers = 0;
                        displayDoneToday = 0;
                        statusColor = "text-gray-600";
                    } else {
                        if (p.status.includes("AKTYWNY")) statusColor = "text-green-400 font-bold";
                        if (p.status.includes("B≈ÅƒÑD")) statusColor = "text-red-400 font-bold";
                        if (p.status.includes("PAUZA")) statusColor = "text-yellow-500";
                        if (p.status.includes("BEZCZYNNY")) statusColor = "text-blue-300";
                    }

                    row.innerHTML = `
                        <td class="px-3 py-2 font-medium text-white">
                            <span class="flex items-center gap-2">
                                <span>${p.name}</span>
                                
                            </span>
                        </td>
                        <td class="px-3 py-2">${displayWorkers}</td>
                        <td class="px-3 py-2 text-white">
                            <span class="flex items-baseline gap-2 whitespace-nowrap">
                                <span>${displayDoneToday}</span>
                                <span class="text-[10px] text-gray-400">${isRunning ? formatLimitTime(p.last_done_session) : '-'}</span>
                            </span>
                        </td>
                        <td class="px-3 py-2 ${statusColor}">${displayStatus}</td>
                        <td class="px-3 py-2">${p.limit_reset}</td>
                        <td class="px-3 py-2 text-[11px] text-gray-300 leading-4">${proEstText}</td>
                    `;
                    tbody.appendChild(row);
                });

                await autoRestartExpiredSessions(data.profiles || []);
                updateSessionExpiredBanner(data.profiles || []);
                updateNonProBanner(data.profiles || [], nonProCount);
                await updateLimitStatus();

                // Update Table Footer
                const tableTotalWorkersEl = document.getElementById('tableTotalWorkers');
                if (tableTotalWorkersEl) tableTotalWorkersEl.textContent = isRunning ? data.grand_total_workers : 0;

                const tableTotalDoneEl = document.getElementById('tableTotalDone');
                if (tableTotalDoneEl) tableTotalDoneEl.textContent = isRunning ? data.grand_total_done : 0;
                const tableTotalProEstEl = document.getElementById('tableTotalProEst');
                if (tableTotalProEstEl) {
                    tableTotalProEstEl.innerHTML = fmtEstLines(
                        data.pro_remaining_config_total,
                        data.pro_remaining_implied_total,
                        data.pro_remaining_pace_total
                    );
                }

                // Update Logs
                const logBox = document.getElementById('workerLogs');
                if (!isRunning) {
                    logBox.innerHTML = "<span class='text-gray-500 italic'>Farma nie jest uruchomiona</span>";
                } else if (data.active_profile_logs && data.active_profile_logs.length > 0) {
                    let html = '';
                    data.active_profile_logs.forEach(([path, logs]) => {
                        let cleanPath = path.split('/').pop();
                        html += `<div class='text-blue-400 mb-1 border-b border-gray-800 pb-1 mt-2'>==> ${cleanPath}</div>`;

                        const keys = Object.keys(logs).sort();
                        if (keys.length === 0) html += "<div class='text-gray-600 italic ml-3'> (brak aktywno≈õci)</div>";

                        keys.forEach(k => {
                            let line = logs[k];
                            let content = line;
                            if (content.includes(" - ")) content = content.split(" - ").slice(2).join(" - ");

                            let color = "text-gray-300";
                            if (content.includes("SENT") || content.includes("üöÄ")) color = "text-green-300";
                            if (content.includes("ERROR") || content.includes("‚ùå")) color = "text-red-400";

                            html += `<div class='ml-3 flex'><span class='w-8 text-gray-500 font-bold shrink-0'>[${k}]</span> <span class='${color}'>${content}</span></div>`;
                        });
                    });
                    logBox.innerHTML = html;
                } else {
                    logBox.innerHTML = "<span class='text-gray-500 italic'>Oczekiwanie na aktywne workery...</span>";
                }

                // Update Progress Info Section
                const progressSection = document.getElementById('progressInfoSection');
                const progressVisible = isRunning && data.source_folder;
                if (progressVisible) {
                    progressSection.classList.remove('hidden');

                    // Source folder (truncate if too long)
                    const folderEl = document.getElementById('sourceFolder');
                    const folder = data.source_folder || '-';
                    folderEl.textContent = folder.length > 60 ? '...' + folder.slice(-57) : folder;
                    folderEl.title = folder;

                    // Progress stats
                    const processed = data.source_processed_files || 0;
                    const total = data.source_total_files || 0;
                    const percent = total > 0 ? Math.round((processed / total) * 100) : 0;

                    document.getElementById('processedCount').textContent = processed;
                    document.getElementById('totalFilesCount').textContent = total;
                    document.getElementById('progressPercent').textContent = percent;
                    document.getElementById('avgRateSession').textContent = fmtRate(data.scan_rate_session);
                    document.getElementById('avgRate5m').textContent = fmtRate(data.scan_rate_5m);

                    // Gaps info
                    const gapsContainer = document.getElementById('gapsInfoContainer');
                    const gapsInfoEl = document.getElementById('gapsInfo');
                    if (data.gaps_info && data.gaps_info.gaps && data.gaps_info.gaps.length > 0) {
                        gapsContainer.classList.remove('hidden');
                        const gapsDisplay = data.gaps_info.gaps.length > 10
                            ? data.gaps_info.gaps.slice(0, 10).join(', ') + ` ... (+${data.gaps_info.gaps.length - 10})`
                            : data.gaps_info.gaps.join(', ');
                        gapsInfoEl.textContent = `${gapsDisplay} (brakuje: ${data.gaps_info.missing || 0})`;
                    } else if (data.gaps_info && data.gaps_info.processed > 0) {
                        gapsContainer.classList.remove('hidden');
                        gapsInfoEl.textContent = `brak (ciƒÖg≈Ço≈õƒá ${data.gaps_info.range_start}-${data.gaps_info.range_end})`;
                        gapsInfoEl.className = 'text-green-400 ml-1';
                    } else {
                        gapsContainer.classList.add('hidden');
                    }
                } else {
                    progressSection.classList.add('hidden');
                }

                const storedParams = loadStoredJobParams();
                if (isRunning && storedParams) {
                    applyJobParams({ ...controlDefaults, ...storedParams });
                }
                setControlPanelLocked(isRunning);
                renderLivePreviewTabs();
                updateLivePreviews();

                const profileCount = Array.isArray(data.profiles) ? data.profiles.length : 0;
                if (windowManager && windowManager.locked) {
                    const shouldResize = (profileCount !== lastProfilesRowCount) || (progressVisible !== lastProgressVisible);
                    if (shouldResize) {
                        lastProfilesRowCount = profileCount;
                        lastProgressVisible = progressVisible;
                        setTimeout(() => windowManager.handleResize(), 50);
                    }
                }
            } catch (e) {
                console.error(e);
                isRunning = false;
                runningProfiles = new Set();
                scheduleNextStatsPoll(10000);
                return;
            }
            scheduleNextStatsPoll(document.hidden ? POLL_HIDDEN_MS : POLL_ACTIVE_MS);
        }

        function loadStoredJobParams() {
            if (lastJobParams) return lastJobParams;
            const raw = localStorage.getItem(LAST_JOB_PARAMS_KEY);
            if (!raw) return null;
            try {
                lastJobParams = JSON.parse(raw);
                return lastJobParams;
            } catch (e) {
                return null;
            }
        }

        function storeJobParams(params) {
            lastJobParams = params;
            try {
                localStorage.setItem(LAST_JOB_PARAMS_KEY, JSON.stringify(params));
            } catch (e) {
                console.warn("Nie mozna zapisac parametrow zadania:", e);
            }
        }

        function applyJobParams(params) {
            if (!params) return;
            const sourceEl = document.getElementById('sourcePath');
            const batchEl = document.getElementById('batchId');
            const workersEl = document.getElementById('workersCount');
            const scansEl = document.getElementById('scansPerWorker');
            const timeoutEl = document.getElementById('collectTimeoutSec');
            const headedEl = document.getElementById('headedMode');
            const engineEl = document.getElementById('engineSelect');
            const continueEl = document.getElementById('continueMode');
            const proOnlyEl = document.getElementById('proOnly');
            const cleanTempEl = document.getElementById('cleanTempImages');
            const pgEnabledEl = document.getElementById('pgEnabled');
            const pgDsnEl = document.getElementById('pgDsn');
            const pgTableEl = document.getElementById('pgTable');
            const browserIdEl = document.getElementById('browserId');
            const preprocMaxDimEl = document.getElementById('preprocMaxDimension');
            const preprocMedianEl = document.getElementById('preprocMedianKernel');
            const preprocDenoiseEl = document.getElementById('preprocDenoiseStrength');
            const preprocClaheClipEl = document.getElementById('preprocClaheClipLimit');
            const preprocClaheGridEl = document.getElementById('preprocClaheGridSize');
            const preprocMorphEl = document.getElementById('preprocMorphKernelSize');
            const preprocUnsharpAmountEl = document.getElementById('preprocUnsharpAmount');
            const preprocUnsharpRadiusEl = document.getElementById('preprocUnsharpRadius');
            const preprocMarginPercentEl = document.getElementById('preprocMarginPercent');
            const preprocDarkThresholdEl = document.getElementById('preprocDarkThreshold');
            const preprocMarginInkRatioEl = document.getElementById('preprocMarginInkRatioMax');
            const preprocMarginShadowEl = document.getElementById('preprocMarginShadowMeanMax');
            const preprocBackgroundKernelRatioEl = document.getElementById('preprocBackgroundKernelRatio');
            const preprocBackgroundKernelMinEl = document.getElementById('preprocBackgroundKernelMin');
            const preprocLocalContrastSigmaEl = document.getElementById('preprocLocalContrastSigma');
            const preprocLocalContrastAmountEl = document.getElementById('preprocLocalContrastAmount');
            const preprocBlackhatKernelEl = document.getElementById('preprocBlackhatKernelSize');
            const preprocBlackhatStrengthEl = document.getElementById('preprocBlackhatStrength');
            const preprocAdaptiveEl = document.getElementById('preprocEnableAdaptiveBinarization');
            const preprocSauvolaWindowEl = document.getElementById('preprocSauvolaWindow');
            const preprocSauvolaKEl = document.getElementById('preprocSauvolaK');
            const preprocSauvolaREl = document.getElementById('preprocSauvolaR');
            const preprocTextMaskBlockEl = document.getElementById('preprocTextMaskBlockSize');
            const preprocTextMaskCEl = document.getElementById('preprocTextMaskC');
            const preprocTextMaskOpenEl = document.getElementById('preprocTextMaskOpenKernel');
            const preprocTextMaskCloseEl = document.getElementById('preprocTextMaskCloseKernel');
            const preprocTextMaskCloseItersEl = document.getElementById('preprocTextMaskCloseIters');
            const preprocTextMaskDilateItersEl = document.getElementById('preprocTextMaskDilateIters');
            const preprocTextMaskMinAreaEl = document.getElementById('preprocTextMaskMinAreaRatio');
            const preprocTrimBandEl = document.getElementById('preprocTrimBandRatio');
            const preprocTrimInkEl = document.getElementById('preprocTrimInkRatioMax');
            const preprocTrimMaxEl = document.getElementById('preprocTrimMaxRatio');
            const preprocTrimMinEl = document.getElementById('preprocTrimMinDimension');
            const useCustomEl = document.getElementById('useCustomProfile');
            const customEl = document.getElementById('customProfileInput');

            if (sourceEl && params.source_path !== undefined) sourceEl.value = params.source_path || '';
            if (batchEl && params.batch_id !== undefined) batchEl.value = params.batch_id || '';
            if (workersEl && params.workers !== undefined) workersEl.value = params.workers;
            if (scansEl && params.scans_per_worker !== undefined) scansEl.value = params.scans_per_worker;
            if (timeoutEl && params.collect_timeout_sec !== undefined) timeoutEl.value = params.collect_timeout_sec;
            if (headedEl && params.headed !== undefined) headedEl.checked = !!params.headed;
            if (engineEl && params.engine !== undefined) engineEl.value = params.engine || 'auto';
            if (continueEl && params.continue_mode !== undefined) continueEl.checked = !!params.continue_mode;
            if (proOnlyEl && params.pro_only !== undefined) proOnlyEl.checked = !!params.pro_only;
            if (cleanTempEl && params.clean_temp_images !== undefined) cleanTempEl.checked = !!params.clean_temp_images;
            if (pgEnabledEl && params.pg_enabled !== undefined) pgEnabledEl.checked = !!params.pg_enabled;
            if (pgDsnEl && params.pg_dsn !== undefined) pgDsnEl.value = params.pg_dsn || '';
            if (pgTableEl && params.pg_table !== undefined) pgTableEl.value = params.pg_table || '';
            if (browserIdEl && params.browser_id !== undefined) browserIdEl.value = params.browser_id || '';
            if (preprocMaxDimEl && params.preproc_max_dimension !== undefined) preprocMaxDimEl.value = params.preproc_max_dimension;
            if (preprocMedianEl && params.preproc_median_kernel !== undefined) preprocMedianEl.value = params.preproc_median_kernel;
            if (preprocDenoiseEl && params.preproc_denoise_strength !== undefined) preprocDenoiseEl.value = params.preproc_denoise_strength;
            if (preprocClaheClipEl && params.preproc_clahe_clip_limit !== undefined) preprocClaheClipEl.value = params.preproc_clahe_clip_limit;
            if (preprocClaheGridEl && params.preproc_clahe_grid_size !== undefined) preprocClaheGridEl.value = params.preproc_clahe_grid_size || '';
            if (preprocMorphEl && params.preproc_morph_kernel_size !== undefined) preprocMorphEl.value = params.preproc_morph_kernel_size;
            if (preprocUnsharpAmountEl && params.preproc_unsharp_amount !== undefined) preprocUnsharpAmountEl.value = params.preproc_unsharp_amount;
            if (preprocUnsharpRadiusEl && params.preproc_unsharp_radius !== undefined) preprocUnsharpRadiusEl.value = params.preproc_unsharp_radius;
            if (preprocMarginPercentEl && params.preproc_margin_percent !== undefined) preprocMarginPercentEl.value = params.preproc_margin_percent;
            if (preprocDarkThresholdEl && params.preproc_dark_threshold !== undefined) preprocDarkThresholdEl.value = params.preproc_dark_threshold;
            if (preprocMarginInkRatioEl && params.preproc_margin_ink_ratio_max !== undefined) preprocMarginInkRatioEl.value = params.preproc_margin_ink_ratio_max;
            if (preprocMarginShadowEl && params.preproc_margin_shadow_mean_max !== undefined) preprocMarginShadowEl.value = params.preproc_margin_shadow_mean_max;
            if (preprocBackgroundKernelRatioEl && params.preproc_background_kernel_ratio !== undefined) preprocBackgroundKernelRatioEl.value = params.preproc_background_kernel_ratio;
            if (preprocBackgroundKernelMinEl && params.preproc_background_kernel_min !== undefined) preprocBackgroundKernelMinEl.value = params.preproc_background_kernel_min;
            if (preprocLocalContrastSigmaEl && params.preproc_local_contrast_sigma !== undefined) preprocLocalContrastSigmaEl.value = params.preproc_local_contrast_sigma;
            if (preprocLocalContrastAmountEl && params.preproc_local_contrast_amount !== undefined) preprocLocalContrastAmountEl.value = params.preproc_local_contrast_amount;
            if (preprocBlackhatKernelEl && params.preproc_blackhat_kernel_size !== undefined) preprocBlackhatKernelEl.value = params.preproc_blackhat_kernel_size;
            if (preprocBlackhatStrengthEl && params.preproc_blackhat_strength !== undefined) preprocBlackhatStrengthEl.value = params.preproc_blackhat_strength;
            if (preprocAdaptiveEl && params.preproc_enable_adaptive_binarization !== undefined) preprocAdaptiveEl.checked = !!params.preproc_enable_adaptive_binarization;
            if (preprocSauvolaWindowEl && params.preproc_sauvola_window !== undefined) preprocSauvolaWindowEl.value = params.preproc_sauvola_window;
            if (preprocSauvolaKEl && params.preproc_sauvola_k !== undefined) preprocSauvolaKEl.value = params.preproc_sauvola_k;
            if (preprocSauvolaREl && params.preproc_sauvola_r !== undefined) preprocSauvolaREl.value = params.preproc_sauvola_r;
            if (preprocTextMaskBlockEl && params.preproc_text_mask_block_size !== undefined) preprocTextMaskBlockEl.value = params.preproc_text_mask_block_size;
            if (preprocTextMaskCEl && params.preproc_text_mask_c !== undefined) preprocTextMaskCEl.value = params.preproc_text_mask_c;
            if (preprocTextMaskOpenEl && params.preproc_text_mask_open_kernel !== undefined) preprocTextMaskOpenEl.value = params.preproc_text_mask_open_kernel;
            if (preprocTextMaskCloseEl && params.preproc_text_mask_close_kernel !== undefined) preprocTextMaskCloseEl.value = params.preproc_text_mask_close_kernel;
            if (preprocTextMaskCloseItersEl && params.preproc_text_mask_close_iters !== undefined) preprocTextMaskCloseItersEl.value = params.preproc_text_mask_close_iters;
            if (preprocTextMaskDilateItersEl && params.preproc_text_mask_dilate_iters !== undefined) preprocTextMaskDilateItersEl.value = params.preproc_text_mask_dilate_iters;
            if (preprocTextMaskMinAreaEl && params.preproc_text_mask_min_area_ratio !== undefined) preprocTextMaskMinAreaEl.value = params.preproc_text_mask_min_area_ratio;
            if (preprocTrimBandEl && params.preproc_trim_band_ratio !== undefined) preprocTrimBandEl.value = params.preproc_trim_band_ratio;
            if (preprocTrimInkEl && params.preproc_trim_ink_ratio_max !== undefined) preprocTrimInkEl.value = params.preproc_trim_ink_ratio_max;
            if (preprocTrimMaxEl && params.preproc_trim_max_ratio !== undefined) preprocTrimMaxEl.value = params.preproc_trim_max_ratio;
            if (preprocTrimMinEl && params.preproc_trim_min_dimension !== undefined) preprocTrimMinEl.value = params.preproc_trim_min_dimension;

            if (useCustomEl) useCustomEl.checked = !!params.use_custom_profile;
            if (customEl) {
                customEl.value = params.custom_profile || '';
                customEl.classList.toggle('hidden', !params.use_custom_profile);
            }

            const selected = new Set((params.profiles || []).map(p => String(p)));
            document.querySelectorAll('input[name="profileCheckbox"]').forEach(cb => {
                cb.checked = selected.has(cb.value);
            });
        }

        function setControlPanelLocked(locked) {
            const lockClasses = ['opacity-60', 'cursor-not-allowed'];
            const toggle = (el) => {
                if (!el) return;
                el.disabled = locked;
                if (locked) {
                    el.classList.add(...lockClasses);
                } else {
                    el.classList.remove(...lockClasses);
                }
            };

            toggle(document.getElementById('sourcePath'));
            toggle(document.getElementById('openBrowserBtn'));
            toggle(document.getElementById('batchId'));
            toggle(document.getElementById('workersCount'));
            toggle(document.getElementById('scansPerWorker'));
            toggle(document.getElementById('collectTimeoutSec'));
            toggle(document.getElementById('headedMode'));
            toggle(document.getElementById('continueMode'));
            toggle(document.getElementById('proOnly'));
            toggle(document.getElementById('cleanTempImages'));
            toggle(document.getElementById('pgEnabled'));
            toggle(document.getElementById('pgDsn'));
            toggle(document.getElementById('pgTable'));
            toggle(document.getElementById('browserId'));
            toggle(document.getElementById('useCustomProfile'));
            toggle(document.getElementById('customProfileInput'));
            toggle(document.getElementById('manageProfilesBtn'));
            toggle(document.getElementById('selectAllProfilesBtn'));
            toggle(document.getElementById('deselectAllProfilesBtn'));
            toggle(document.getElementById('selectOkLimitProfilesBtn'));
            toggle(document.getElementById('sortProfilesAscBtn'));
            toggle(document.getElementById('sortProfilesDescBtn'));
            toggle(document.getElementById('newProfileName'));
            toggle(document.getElementById('addProfileBtn'));
            toggle(document.getElementById('controlTabBasic'));
            toggle(document.getElementById('controlTabPerformance'));
            toggle(document.getElementById('controlTabDatabase'));
            toggle(document.getElementById('controlTabPreprocess'));
            toggle(document.getElementById('controlTabAdvanced'));
            toggle(document.getElementById('resetDefaultsBtn'));
            toggle(document.getElementById('preprocMaxDimension'));
            toggle(document.getElementById('preprocMedianKernel'));
            toggle(document.getElementById('preprocDenoiseStrength'));
            toggle(document.getElementById('preprocClaheClipLimit'));
            toggle(document.getElementById('preprocClaheGridSize'));
            toggle(document.getElementById('preprocMorphKernelSize'));
            toggle(document.getElementById('preprocUnsharpAmount'));
            toggle(document.getElementById('preprocUnsharpRadius'));
            toggle(document.getElementById('preprocMarginPercent'));
            toggle(document.getElementById('preprocDarkThreshold'));
            toggle(document.getElementById('preprocMarginInkRatioMax'));
            toggle(document.getElementById('preprocMarginShadowMeanMax'));
            toggle(document.getElementById('preprocBackgroundKernelRatio'));
            toggle(document.getElementById('preprocBackgroundKernelMin'));
            toggle(document.getElementById('preprocLocalContrastSigma'));
            toggle(document.getElementById('preprocLocalContrastAmount'));
            toggle(document.getElementById('preprocBlackhatKernelSize'));
            toggle(document.getElementById('preprocBlackhatStrength'));
            toggle(document.getElementById('preprocEnableAdaptiveBinarization'));
            toggle(document.getElementById('preprocSauvolaWindow'));
            toggle(document.getElementById('preprocSauvolaK'));
            toggle(document.getElementById('preprocSauvolaR'));
            toggle(document.getElementById('preprocTextMaskBlockSize'));
            toggle(document.getElementById('preprocTextMaskC'));
            toggle(document.getElementById('preprocTextMaskOpenKernel'));
            toggle(document.getElementById('preprocTextMaskCloseKernel'));
            toggle(document.getElementById('preprocTextMaskCloseIters'));
            toggle(document.getElementById('preprocTextMaskDilateIters'));
            toggle(document.getElementById('preprocTextMaskMinAreaRatio'));
            toggle(document.getElementById('preprocTrimBandRatio'));
            toggle(document.getElementById('preprocTrimInkRatioMax'));
            toggle(document.getElementById('preprocTrimMaxRatio'));
            toggle(document.getElementById('preprocTrimMinDimension'));

            document.querySelectorAll('input[name="profileCheckbox"]').forEach(cb => {
                cb.disabled = locked;
                if (locked) {
                    cb.classList.add('opacity-60', 'cursor-not-allowed');
                } else {
                    cb.classList.remove('opacity-60', 'cursor-not-allowed');
                }
            });

            const isManaging = true; // Profile manager is always visible
            document.querySelectorAll('[data-profile-delete="true"]').forEach(btn => {
                // Button is disabled if globally locked (job running)
                const shouldDisable = locked;
                btn.disabled = shouldDisable;

                if (shouldDisable) {
                    btn.classList.add(...lockClasses);
                } else {
                    btn.classList.remove(...lockClasses);
                    btn.classList.remove('pointer-events-none');
                }
            });
        }

        function getActiveProfiles() {
            // Return all profiles from stats (same as Status Farmy table)
            if (!lastStats || !lastStats.profiles) return [];
            return lastStats.profiles;
        }

        function switchControlTab(tabName) {
            currentControlTab = tabName;
            const tabs = document.querySelectorAll('.control-tab-content');
            const buttons = document.querySelectorAll('.control-tab-btn');
            tabs.forEach(tab => {
                const isActive = tab.dataset.tabContent === tabName;
                tab.classList.toggle('hidden', !isActive);
            });
            buttons.forEach(btn => {
                const isActive = btn.id === `controlTab${tabName.charAt(0).toUpperCase()}${tabName.slice(1)}`;
                if (isActive) {
                    btn.classList.add('bg-blue-600', 'border-blue-400', 'text-white');
                    btn.classList.remove('bg-gray-800', 'text-gray-300');
                } else {
                    btn.classList.remove('bg-blue-600', 'border-blue-400', 'text-white');
                    btn.classList.add('bg-gray-800', 'text-gray-300');
                }
            });

            // Force layout recalculate to adjust window size (auto height)
            setTimeout(() => {
                if (typeof windowManager !== 'undefined' && windowManager.locked) {
                    windowManager.handleResize();
                }
            }, 50);
        }

        function applyControlDefaults() {
            // Apply only defaults for current tab
            const fields = tabFieldMap[currentControlTab] || [];

            // Build params object with only those fields
            const paramsToReset = {};
            fields.forEach(field => {
                if (field === 'profiles') {
                    // Special default: all except 'tomaasz'
                    const allCheckboxes = Array.from(document.querySelectorAll('input[name="profileCheckbox"]'));
                    paramsToReset['profiles'] = allCheckboxes
                        .map(cb => cb.value)
                        .filter(val => val !== 'tomaasz');
                } else if (controlDefaults[field] !== undefined) {
                    paramsToReset[field] = controlDefaults[field];
                }
            });

            applyJobParams(paramsToReset);
        }

        function toInt(value, fallback) {
            const num = parseInt(value, 10);
            return Number.isNaN(num) ? fallback : num;
        }

        function toFloat(value, fallback) {
            const num = parseFloat(value);
            return Number.isNaN(num) ? fallback : num;
        }

        function setActionMsg(text, colorClass = "text-gray-300") {
            const msg = document.getElementById('actionMsg');
            if (!msg) return;
            msg.textContent = text || "";
            msg.className = `text-center text-xs h-4 ${colorClass}`;
        }

        function updateSessionExpiredBanner(profiles) {
            const banner = document.getElementById('sessionExpiredBanner');
            const listEl = document.getElementById('sessionExpiredProfiles');
            if (!banner || !listEl) return;

            const expired = profiles
                .filter(p => String(p.status || '').includes("SESJA WYGAS≈ÅA"))
                .map(p => p.name);

            if (expired.length === 0) {
                banner.classList.add('hidden');
                listEl.textContent = '-';
                return;
            }

            banner.classList.remove('hidden');
            listEl.textContent = expired.join(', ');
        }

        function updateNonProBanner(profiles, totalCount) {
            const banner = document.getElementById('nonProBanner');
            const countEl = document.getElementById('nonProBannerCount');
            const listEl = document.getElementById('nonProBannerProfiles');
            if (!banner || !countEl || !listEl) return;

            const offenders = (profiles || [])
                .filter(p => (p.non_pro_rejected_session || 0) > 0)
                .map(p => `${p.name}(${p.non_pro_rejected_session})`);

            if (!isRunning || !totalCount) {
                banner.classList.add('hidden');
                countEl.textContent = '0';
                listEl.textContent = '-';
                return;
            }

            banner.classList.remove('hidden');
            countEl.textContent = String(totalCount);
            listEl.textContent = offenders.length ? offenders.join(', ') : '-';
        }

        function resetLayoutHard() {
            localStorage.removeItem('windowPositions');
            localStorage.setItem('layoutLocked', 'true');
            localStorage.removeItem(LOGS_PREF_KEY);
            logsForceVisible = false;
            logsSuppressed = false;
            if (!isRunning) {
                logsEverStarted = false;
                setLogsVisible(false);
            } else {
                logsEverStarted = true;
                setLogsVisible(true);
            }
            if (windowManager && typeof windowManager.forceResetLayout === 'function') {
                windowManager.forceResetLayout();
            }
            setTimeout(() => {
                if (windowManager && typeof windowManager.handleResize === 'function') {
                    windowManager.handleResize();
                }
            }, 50);
        }

        function renderLivePreviewTabs() {
            const tabsEl = document.getElementById('livePreviewTabs');
            if (!tabsEl) return;

            const activeProfiles = getActiveProfiles();
            tabsEl.innerHTML = "";

            if (activeProfiles.length === 0) {
                selectedPreviewProfile = null;
                tabsEl.innerHTML = "<span class='text-gray-500 text-xs italic'>Brak aktywnych profili</span>";
                return;
            }

            if (!selectedPreviewProfile || !activeProfiles.some(p => p.name === selectedPreviewProfile)) {
                selectedPreviewProfile = activeProfiles[0].name;
            }

            activeProfiles.forEach(p => {
                const isActive = p.name === selectedPreviewProfile;
                const showRealStatus = isRunning;
                const isPaused = showRealStatus && p.status && p.status.includes('PAUZA');
                const isError = showRealStatus && p.status && p.status.includes('B≈ÅƒÑD');
                const isIdle = !showRealStatus || (p.status && p.status.includes('BEZCZYNNY'));

                const btn = document.createElement('button');
                btn.className = isActive
                    ? "w-full bg-gradient-to-r from-blue-600 to-blue-500 text-white px-2 py-1.5 rounded text-xs font-medium shadow-lg shadow-blue-500/20 transition-all duration-200 text-left"
                    : "w-full bg-gray-800/80 text-gray-300 px-2 py-1.5 rounded text-xs hover:bg-gray-700 hover:text-white transition-all duration-200 border border-gray-700/50 text-left";

                // Status dot
                let statusDot = '';
                if (isPaused) statusDot = '<span class="w-1.5 h-1.5 rounded-full bg-yellow-400 mr-1.5 shrink-0"></span>';
                else if (isError) statusDot = '<span class="w-1.5 h-1.5 rounded-full bg-red-400 mr-1.5 shrink-0"></span>';
                else if (isIdle) statusDot = '<span class="w-1.5 h-1.5 rounded-full bg-gray-500 mr-1.5 shrink-0"></span>';
                else statusDot = '<span class="w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5 shrink-0 animate-pulse"></span>';

                btn.innerHTML = `<span class="flex items-center truncate">${statusDot}<span class="truncate">${p.name}</span></span>`;
                btn.onclick = () => {
                    selectedPreviewProfile = p.name;
                    renderLivePreviewTabs();
                    updateLivePreviews();
                };
                tabsEl.appendChild(btn);
            });
        }

        async function updateLivePreviews() {
            if (!isRunning) {
                document.getElementById('livePreviewGrid').innerHTML = "<div class='live-preview-empty text-gray-500 text-sm italic'>Zadanie zatrzymane.</div>";
                return;
            }

            if (!lastStats || !lastStats.profiles) {
                return;
            }

            const grid = document.getElementById('livePreviewGrid');
            let html = "";

            const activeProfiles = getActiveProfiles();

            if (activeProfiles.length === 0) {
                grid.innerHTML = "<div class='live-preview-empty text-gray-500 text-sm italic'>Brak aktywnych profili...</div>";
                return;
            }

            if (!selectedPreviewProfile || !activeProfiles.some(p => p.name === selectedPreviewProfile)) {
                selectedPreviewProfile = activeProfiles[0].name;
                renderLivePreviewTabs();
            }

            const p = activeProfiles.find(profile => profile.name === selectedPreviewProfile);
            if (!p) {
                grid.innerHTML = "<div class='live-preview-empty text-gray-500 text-sm italic'>Brak podglƒÖdu...</div>";
                return;
            }

            const isPaused = p.status && p.status.includes('PAUZA');
            const isSessionExpired = p.status && p.status.includes('SESJA WYGAS≈ÅA');
            let activeCount = 0;
            let totalCount = 0;
            try {
                if (p.workers && p.workers.includes('/')) {
                    const parts = p.workers.split('/');
                    activeCount = parseInt(parts[0], 10) || 0;
                    totalCount = parseInt(parts[1], 10) || 0;
                }
            } catch (e) { }
            if (activeCount <= 0) {
                grid.innerHTML = "<div class='live-preview-empty text-gray-500 text-sm italic'>Brak aktywnych worker√≥w.</div>";
                return;
            }
            let count = totalCount || Math.max(activeCount, 1);

            html += `<div class="live-preview-header text-xs text-gray-400 border-b border-gray-800 mt-2 mb-1 pb-1 font-bold">${p.name} (${p.status})</div>`;

            const showMissing = false;
            const imgOnError = "this.parentElement.style.display='none'";
            const imgOnLoad = "this.parentElement.style.display='block'; this.setAttribute('data-loaded', 'true')";

            for (let i = 1; i <= count; i++) {
                const ts = new Date().getTime();
                const captureTime = new Date().toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const url = `/api/live/${i}?profile=${encodeURIComponent(p.name)}&t=${ts}`;
                const label = `${p.name} W${i}`;

                html += `
                    <div class="live-preview-tile relative bg-black rounded overflow-hidden border border-gray-700 group cursor-pointer" onclick="openImageModal('${url}')">
                        <span class="absolute top-1 left-1 bg-black/70 text-white text-xs px-1 rounded z-10 pointer-events-none">${label}</span>
                        <span class="absolute bottom-1 right-1 bg-black/70 text-gray-300 text-xs px-1 rounded z-10 pointer-events-none">üì∑ ${captureTime}</span>
                        <img src="${url}" 
                             class="live-preview-image w-full h-full opacity-85 group-hover:opacity-100 transition" 
                             onerror="${imgOnError}"
                             onload="${imgOnLoad}"
                        >
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-30 bg-white transition pointer-events-none">
                             <span class="text-4xl text-black">üîç</span>
                        </div>
                    </div>
                `;
            }

            if (!html) html = "<div class='live-preview-empty text-gray-500 text-sm italic'>Brak podglƒÖdu...</div>";
            grid.innerHTML = html;
        }

        // Image Preview Modal
        function openImageModal(url) {
            const modal = document.getElementById('imagePreviewModal');
            const img = document.getElementById('imagePreviewTarget');
            img.src = url;
            modal.classList.remove('hidden');
        }

        function closeImageModal() {
            document.getElementById('imagePreviewModal').classList.add('hidden');
            setTimeout(() => { document.getElementById('imagePreviewTarget').src = ""; }, 200);
        }

        function normalizeProfileNames(names) {
            const normalized = new Set();
            (names || []).forEach(name => {
                const trimmed = String(name || '').trim();
                if (trimmed) {
                    normalized.add(trimmed);
                }
            });
            return Array.from(normalized);
        }

        function rebuildProfileCatalog() {
            const combined = new Set();
            Object.values(profileCatalogSources).forEach(sourceSet => {
                sourceSet.forEach(name => combined.add(name));
            });

            let unchanged = combined.size === profileCatalog.size;
            if (unchanged) {
                for (const name of combined) {
                    if (!profileCatalog.has(name)) {
                        unchanged = false;
                        break;
                    }
                }
            }

            if (unchanged) {
                return false;
            }

            profileCatalog = combined;
            profileCatalogDirty = true;
            return true;
        }

        function updateProfileSource(source, names) {
            const targetSet = profileCatalogSources[source];
            if (!targetSet) {
                return false;
            }
            const normalized = normalizeProfileNames(names);
            const filtered = source === 'disk' ? normalized : normalized.filter(name => profileCatalogSources.disk.has(name));
            let changed = normalized.length !== targetSet.size;
            if (!changed) {
                const iterable = source === 'disk' ? normalized : filtered;
                for (const name of iterable) {
                    if (!targetSet.has(name)) {
                        changed = true;
                        break;
                    }
                }
                if (!changed && source !== 'disk' && filtered.length !== normalized.length) {
                    changed = true;
                }
            }
            if (!changed) {
                return false;
            }
            targetSet.clear();
            (source === 'disk' ? normalized : filtered).forEach(name => targetSet.add(name));
            rebuildProfileCatalog();
            return true;
        }

        function getUnifiedProfileList() {
            const items = Array.from(profileCatalog);
            items.sort((a, b) => a.localeCompare(b, 'pl', { sensitivity: 'base' }));
            if (profilesSortOrder === 'desc') items.reverse();
            return items;
        }

        function renderProfilesList(profiles) {
            const list = document.getElementById('profilesList');
            if (!list) return;
            const isManaging = true; // Profile manager is always visible

            const existingCheckboxes = Array.from(document.querySelectorAll('input[name="profileCheckbox"]'));
            const selected = new Set(existingCheckboxes.filter(cb => cb.checked).map(cb => cb.value));
            if (existingCheckboxes.length > 0) {
                profileSelectionSeeded = true;
            }

            if (profiles && profiles.length > 0) {
                list.innerHTML = "";
                profiles.forEach(p => {
                    const isChecked = profileSelectionSeeded
                        ? selected.has(p)
                        : p !== 'tomaasz';
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between hover:bg-gray-800 p-1 rounded";
                    div.innerHTML = `
                       <label class="flex items-center space-x-2 cursor-pointer flex-1">
                           <input type="checkbox" name="profileCheckbox" value="${p}" class="form-checkbox bg-gray-700 border-gray-500 rounded text-blue-500" ${isChecked ? 'checked' : ''}>
                           <span class="flex flex-col min-w-0">
                           <span class="text-gray-300 font-mono truncate flex items-center gap-2">
                               <span class="truncate">${p}</span>
                               
                           </span>
                               <span class="text-[10px] text-gray-500 truncate" data-profile-stats="${p}">tok: -</span>
                               <span class="text-[10px] text-gray-600 truncate" data-profile-chrome="${p}">chrome: -</span>
                           </span>
                        </label>
                        <div class="flex items-center space-x-1">
                           <button data-profile-start="${p}" onclick="startProfile('${p}')" class="text-green-300 text-sm px-1 hover:text-green-200" title="Start profilu">‚ñ∂</button>
                           <button data-profile-stop="${p}" onclick="stopProfile('${p}')" class="text-red-300 text-sm px-1 hover:text-red-200" title="Stop profilu">‚èπ</button>
                           <button data-profile-reset="${p}" onclick="resetProfile('${p}')" class="text-yellow-300 text-sm px-1 hover:text-yellow-200" title="Reset profilu (restart + czyszczenie cache)">üîÑ</button>
                           <button onclick="loginProfile('${p}')" class="text-blue-300 hover:text-blue-200 text-sm px-1" title="Zaloguj profil">üîê</button>
                           <button data-profile-delete="true" 
                                   data-profile-name="${p}"
                                   onclick="console.log('Deleting:', '${p}'); deleteProfile('${p}')"
                                   title="Usu≈Ñ profil" 
                                   class="text-red-400 hover:text-red-300 text-sm px-1 inline-flex items-center justify-center" 
                                   aria-label="Usu≈Ñ profil">
                               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                   <path d="M5 7h14"></path>
                                   <path d="M8 7V5a1 1 0 011-1h6a1 1 0 011 1v2m2 0v12a1 1 0 01-1 1H6a1 1 0 01-1-1V7h12"></path>
                                   <path d="M10 11v6m4-6v6"></path>
                               </svg>
                           </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
                updateProfileStatsBadges();
                updateProfileActionButtons();
                const storedParams = loadStoredJobParams();
                if (isRunning && storedParams) {
                    applyJobParams({ ...controlDefaults, ...storedParams });
                }
                updateSortButtons();
            } else {
                list.innerHTML = "<div class='text-gray-500 text-xs text-center pt-2'>Brak profili w cache</div>";
            }
        }

        function syncProfileLists() {
            if (!profileCatalogDirty) return;
            const profiles = getUnifiedProfileList();
            renderProfilesList(profiles);
            profileCatalogDirty = false;
        }



        // --- Job Control ---
        async function loadProfiles() {
            try {
                const res = await fetch('/api/profiles');
                const data = await readJsonSafely(res);
                const profiles = (data.profiles || []).map(p => String(p));
                updateProfileSource('disk', profiles);
                syncProfileLists();
            } catch (e) {
                console.error(e);
                document.getElementById('profilesList').innerHTML = "<div class='text-red-500 text-xs text-center'>B≈ÇƒÖd ≈Çadowania</div>";
            }
        }

        // let profileManagerVisible = false; // Removed
        let profilesSortOrder = 'asc';

        // function toggleProfileManager() { // Removed
        //     profileManagerVisible = !profileManagerVisible; // Removed
        //     document.getElementById('profileManager').classList.toggle('hidden', !profileManagerVisible); // Removed
        //     loadProfiles(); // Removed
        // } // Removed

        function updateSortButtons() {
            const ascBtn = document.getElementById('sortProfilesAscBtn');
            const descBtn = document.getElementById('sortProfilesDescBtn');
            if (!ascBtn || !descBtn) return;
            if (profilesSortOrder === 'asc') {
                ascBtn.classList.add('bg-blue-600', 'border-blue-400', 'text-white');
                ascBtn.classList.remove('bg-gray-800');
                descBtn.classList.remove('bg-blue-600', 'border-blue-400', 'text-white');
                descBtn.classList.add('bg-gray-800');
            } else {
                descBtn.classList.add('bg-blue-600', 'border-blue-400', 'text-white');
                descBtn.classList.remove('bg-gray-800');
                ascBtn.classList.remove('bg-blue-600', 'border-blue-400', 'text-white');
                ascBtn.classList.add('bg-gray-800');
            }
        }

        function sortProfiles(order) {
            profilesSortOrder = order === 'desc' ? 'desc' : 'asc';
            renderProfilesList(getUnifiedProfileList());
        }

        function selectAllProfiles() {
            document.querySelectorAll('input[name="profileCheckbox"]').forEach(cb => {
                cb.checked = true;
            });
        }

        function deselectAllProfiles() {
            document.querySelectorAll('input[name="profileCheckbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        function getProfilesWithOkLimitStatus() {
            if (!limitLastResultMap || Object.keys(limitLastResultMap).length === 0) return [];
            return Object.entries(limitLastResultMap)
                .filter(([, v]) => {
                    if (!v || typeof v.lastStatus !== 'string') return false;
                    return v.lastStatus.toUpperCase().includes('OK');
                })
                .map(([name]) => name);
        }

        function selectOkLimitProfiles() {
            const okProfiles = new Set(getProfilesWithOkLimitStatus());
            if (okProfiles.size === 0) {
                setActionMsg("Brak profili z wynikiem OK w Kontroli limit√≥w.", "text-yellow-400");
                return;
            }
            document.querySelectorAll('input[name="profileCheckbox"]').forEach(cb => {
                cb.checked = okProfiles.has(cb.value);
            });
            setActionMsg(`Zaznaczono ${okProfiles.size} profil(e) z wynikiem OK.`, "text-green-400");
        }

        async function addProfile() {
            const name = document.getElementById('newProfileName').value.trim();
            if (!name) {
                setActionMsg("Wpisz nazwƒô profilu!", "text-red-400");
                return;
            }

            try {
                const res = await fetch('/api/profiles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });

                if (res.ok) {
                    document.getElementById('newProfileName').value = '';
                    loadProfiles();
                    setActionMsg(`Dodano profil "${name}".`, "text-green-400");
                } else {
                    const err = await readJsonSafely(res);
                    setActionMsg("B≈ÇƒÖd: " + err.detail, "text-red-400");
                }
            } catch (e) {
                setActionMsg("B≈ÇƒÖd sieci: " + e, "text-red-400");
            }
        }

        async function deleteProfile(name) {
            console.log("Attempting to delete profile:", name);
            if (!confirm(`Czy na pewno chcesz usunƒÖƒá profil "${name}"? Spowoduje to usuniƒôcie danych logowania przeglƒÖdarki dla tego profilu.`)) {
                return;
            }

            try {
                const res = await fetch(`/api/profiles/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });

                if (res.ok || res.status === 404) {
                    let data = {};
                    if (res.ok) {
                        data = await readJsonSafely(res);
                        console.log("Delete success:", data);
                        setActionMsg(`Usuniƒôto profil "${name}".`, "text-green-400");
                    } else {
                        console.warn("Profile not found on server, removing from UI:", name);
                        setActionMsg(`Profil "${name}" nie istnieje (usuniƒôto z listy).`, "text-yellow-400");
                    }

                    // Remove from catalog and reload
                    if (typeof profileCatalog !== 'undefined') {
                        profileCatalog.delete(name);
                        profileCatalogDirty = true;
                    }

                    loadProfiles();
                    syncProfileLists();
                } else {
                    const err = await readJsonSafely(res);
                    console.error("Delete failed:", err);
                    setActionMsg("B≈ÇƒÖd: " + (err.detail || "Nieznany b≈ÇƒÖd"), "text-red-400");
                }
            } catch (e) {
                setActionMsg("B≈ÇƒÖd sieci: " + e, "text-red-400");
            }
        }

        async function loginProfile(name = null) {
            if (!name) {
                const checkboxes = document.querySelectorAll('input[name="profileCheckbox"]:checked');
                const selected = Array.from(checkboxes).map(cb => cb.value);
                if (selected.length !== 1) {
                    setActionMsg("Wybierz dok≈Çadnie jeden profil do logowania (lub kliknij üîê przy profilu).", "text-red-400");
                    return;
                }
                name = selected[0];
            }
            if (lastStats && lastStats.profiles) {
                const p = lastStats.profiles.find(profile => profile.name === name);
                if (p && p.status && p.status.includes("AKTYWNY")) {
                    setActionMsg(`Profil "${name}" jest aktywny. Zatrzymaj go lub poczekaj, a≈º bƒôdzie bezczynny.`, "text-red-400");
                    return;
                }
            }
            try {
                const res = await fetch('/api/profiles/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                if (res.ok) {
                    setActionMsg("Uruchomiono logowanie. Zamknij okno przeglƒÖdarki, gdy sko≈Ñczysz.", "text-green-400");
                } else {
                    const err = await readJsonSafely(res);
                    let msg = "B≈ÇƒÖd: " + (err.detail || res.status);
                    if (err.log) {
                        try {
                            const logRes = await fetch(`/api/profiles/login/log?name=${encodeURIComponent(name)}`);
                            if (logRes.ok) {
                                const logData = await readJsonSafely(logRes);
                                if (logData.log) {
                                    msg += "\n\nLog:\n" + logData.log;
                                }
                            }
                        } catch (e) { }
                    }
                    setActionMsg(msg, "text-red-400");
                }
            } catch (e) {
                setActionMsg("B≈ÇƒÖd sieci: " + e, "text-red-400");
            }
        }

        function buildJobPayload(selectedProfiles, includeCustom = true) {
            const source = document.getElementById('sourcePath').value;
            const useCustom = document.getElementById('useCustomProfile').checked;
            const custom = document.getElementById('customProfileInput').value.trim();
            const scansPerWorker = toInt(document.getElementById('scansPerWorker').value, controlDefaults.scans_per_worker);
            const collectTimeoutSec = toInt(document.getElementById('collectTimeoutSec').value, controlDefaults.collect_timeout_sec);
            const engine = document.getElementById('engineSelect').value || controlDefaults.engine;
            const continueMode = document.getElementById('continueMode').checked;
            const proOnly = document.getElementById('proOnly').checked;
            const cleanTempImages = document.getElementById('cleanTempImages').checked;
            const pgEnabled = document.getElementById('pgEnabled').checked;
            const pgDsn = document.getElementById('pgDsn').value.trim();
            const pgTable = document.getElementById('pgTable').value.trim() || 'public.ocr_raw_texts';
            const browserId = document.getElementById('browserId').value.trim();
            const preprocMaxDimension = toInt(document.getElementById('preprocMaxDimension').value, controlDefaults.preproc_max_dimension);
            const preprocMedianKernel = toInt(document.getElementById('preprocMedianKernel').value, controlDefaults.preproc_median_kernel);
            const preprocDenoiseStrength = toInt(document.getElementById('preprocDenoiseStrength').value, controlDefaults.preproc_denoise_strength);
            const preprocClaheClipLimit = toFloat(document.getElementById('preprocClaheClipLimit').value, controlDefaults.preproc_clahe_clip_limit);
            const preprocClaheGridSize = document.getElementById('preprocClaheGridSize').value.trim() || controlDefaults.preproc_clahe_grid_size;
            const preprocMorphKernelSize = toInt(document.getElementById('preprocMorphKernelSize').value, controlDefaults.preproc_morph_kernel_size);
            const preprocUnsharpAmount = toFloat(document.getElementById('preprocUnsharpAmount').value, controlDefaults.preproc_unsharp_amount);
            const preprocUnsharpRadius = toInt(document.getElementById('preprocUnsharpRadius').value, controlDefaults.preproc_unsharp_radius);
            const preprocMarginPercent = toFloat(document.getElementById('preprocMarginPercent').value, controlDefaults.preproc_margin_percent);
            const preprocDarkThreshold = toInt(document.getElementById('preprocDarkThreshold').value, controlDefaults.preproc_dark_threshold);
            const preprocMarginInkRatioMax = toFloat(document.getElementById('preprocMarginInkRatioMax').value, controlDefaults.preproc_margin_ink_ratio_max);
            const preprocMarginShadowMeanMax = toInt(document.getElementById('preprocMarginShadowMeanMax').value, controlDefaults.preproc_margin_shadow_mean_max);
            const preprocBackgroundKernelRatio = toFloat(document.getElementById('preprocBackgroundKernelRatio').value, controlDefaults.preproc_background_kernel_ratio);
            const preprocBackgroundKernelMin = toInt(document.getElementById('preprocBackgroundKernelMin').value, controlDefaults.preproc_background_kernel_min);
            const preprocLocalContrastSigma = toFloat(document.getElementById('preprocLocalContrastSigma').value, controlDefaults.preproc_local_contrast_sigma);
            const preprocLocalContrastAmount = toFloat(document.getElementById('preprocLocalContrastAmount').value, controlDefaults.preproc_local_contrast_amount);
            const preprocBlackhatKernelSize = toInt(document.getElementById('preprocBlackhatKernelSize').value, controlDefaults.preproc_blackhat_kernel_size);
            const preprocBlackhatStrength = toFloat(document.getElementById('preprocBlackhatStrength').value, controlDefaults.preproc_blackhat_strength);
            const preprocEnableAdaptiveBinarization = document.getElementById('preprocEnableAdaptiveBinarization').checked;
            const preprocSauvolaWindow = toInt(document.getElementById('preprocSauvolaWindow').value, controlDefaults.preproc_sauvola_window);
            const preprocSauvolaK = toFloat(document.getElementById('preprocSauvolaK').value, controlDefaults.preproc_sauvola_k);
            const preprocSauvolaR = toFloat(document.getElementById('preprocSauvolaR').value, controlDefaults.preproc_sauvola_r);
            const preprocTextMaskBlockSize = toInt(document.getElementById('preprocTextMaskBlockSize').value, controlDefaults.preproc_text_mask_block_size);
            const preprocTextMaskC = toInt(document.getElementById('preprocTextMaskC').value, controlDefaults.preproc_text_mask_c);
            const preprocTextMaskOpenKernel = toInt(document.getElementById('preprocTextMaskOpenKernel').value, controlDefaults.preproc_text_mask_open_kernel);
            const preprocTextMaskCloseKernel = toInt(document.getElementById('preprocTextMaskCloseKernel').value, controlDefaults.preproc_text_mask_close_kernel);
            const preprocTextMaskCloseIters = toInt(document.getElementById('preprocTextMaskCloseIters').value, controlDefaults.preproc_text_mask_close_iters);
            const preprocTextMaskDilateIters = toInt(document.getElementById('preprocTextMaskDilateIters').value, controlDefaults.preproc_text_mask_dilate_iters);
            const preprocTextMaskMinAreaRatio = toFloat(document.getElementById('preprocTextMaskMinAreaRatio').value, controlDefaults.preproc_text_mask_min_area_ratio);
            const preprocTrimBandRatio = toFloat(document.getElementById('preprocTrimBandRatio').value, controlDefaults.preproc_trim_band_ratio);
            const preprocTrimInkRatioMax = toFloat(document.getElementById('preprocTrimInkRatioMax').value, controlDefaults.preproc_trim_ink_ratio_max);
            const preprocTrimMaxRatio = toFloat(document.getElementById('preprocTrimMaxRatio').value, controlDefaults.preproc_trim_max_ratio);
            const preprocTrimMinDimension = toInt(document.getElementById('preprocTrimMinDimension').value, controlDefaults.preproc_trim_min_dimension);
            const profiles = selectedProfiles.slice();
            if (includeCustom && useCustom && custom) profiles.push(custom);

            const body = {
                source_path: source,
                profiles: profiles,
                workers: parseInt(document.getElementById('workersCount').value),
                scans_per_worker: scansPerWorker,
                batch_id: document.getElementById('batchId').value || null,
                headed: document.getElementById('headedMode').checked,
                engine: engine,
                continue_mode: continueMode,
                pro_only: proOnly,
                collect_timeout_sec: collectTimeoutSec,
                pg_enabled: pgEnabled,
                pg_dsn: pgDsn || null,
                pg_table: pgTable,
                clean_temp_images: cleanTempImages,
                browser_id: browserId || null,
                preproc_max_dimension: preprocMaxDimension,
                preproc_median_kernel: preprocMedianKernel,
                preproc_denoise_strength: preprocDenoiseStrength,
                preproc_clahe_clip_limit: preprocClaheClipLimit,
                preproc_clahe_grid_size: preprocClaheGridSize,
                preproc_morph_kernel_size: preprocMorphKernelSize,
                preproc_unsharp_amount: preprocUnsharpAmount,
                preproc_unsharp_radius: preprocUnsharpRadius,
                preproc_margin_percent: preprocMarginPercent,
                preproc_dark_threshold: preprocDarkThreshold,
                preproc_margin_ink_ratio_max: preprocMarginInkRatioMax,
                preproc_margin_shadow_mean_max: preprocMarginShadowMeanMax,
                preproc_background_kernel_ratio: preprocBackgroundKernelRatio,
                preproc_background_kernel_min: preprocBackgroundKernelMin,
                preproc_local_contrast_sigma: preprocLocalContrastSigma,
                preproc_local_contrast_amount: preprocLocalContrastAmount,
                preproc_blackhat_kernel_size: preprocBlackhatKernelSize,
                preproc_blackhat_strength: preprocBlackhatStrength,
                preproc_enable_adaptive_binarization: preprocEnableAdaptiveBinarization,
                preproc_sauvola_window: preprocSauvolaWindow,
                preproc_sauvola_k: preprocSauvolaK,
                preproc_sauvola_r: preprocSauvolaR,
                preproc_text_mask_block_size: preprocTextMaskBlockSize,
                preproc_text_mask_c: preprocTextMaskC,
                preproc_text_mask_open_kernel: preprocTextMaskOpenKernel,
                preproc_text_mask_close_kernel: preprocTextMaskCloseKernel,
                preproc_text_mask_close_iters: preprocTextMaskCloseIters,
                preproc_text_mask_dilate_iters: preprocTextMaskDilateIters,
                preproc_text_mask_min_area_ratio: preprocTextMaskMinAreaRatio,
                preproc_trim_band_ratio: preprocTrimBandRatio,
                preproc_trim_ink_ratio_max: preprocTrimInkRatioMax,
                preproc_trim_max_ratio: preprocTrimMaxRatio,
                preproc_trim_min_dimension: preprocTrimMinDimension
            };
            const paramsSnapshot = {
                source_path: body.source_path,
                profiles: selectedProfiles,
                workers: body.workers,
                scans_per_worker: body.scans_per_worker,
                batch_id: body.batch_id,
                headed: body.headed,
                engine: body.engine,
                continue_mode: body.continue_mode,
                pro_only: body.pro_only,
                collect_timeout_sec: body.collect_timeout_sec,
                pg_enabled: body.pg_enabled,
                pg_dsn: body.pg_dsn,
                pg_table: body.pg_table,
                clean_temp_images: body.clean_temp_images,
                browser_id: body.browser_id,
                preproc_max_dimension: body.preproc_max_dimension,
                preproc_median_kernel: body.preproc_median_kernel,
                preproc_denoise_strength: body.preproc_denoise_strength,
                preproc_clahe_clip_limit: body.preproc_clahe_clip_limit,
                preproc_clahe_grid_size: body.preproc_clahe_grid_size,
                preproc_morph_kernel_size: body.preproc_morph_kernel_size,
                preproc_unsharp_amount: body.preproc_unsharp_amount,
                preproc_unsharp_radius: body.preproc_unsharp_radius,
                preproc_margin_percent: body.preproc_margin_percent,
                preproc_dark_threshold: body.preproc_dark_threshold,
                preproc_margin_ink_ratio_max: body.preproc_margin_ink_ratio_max,
                preproc_margin_shadow_mean_max: body.preproc_margin_shadow_mean_max,
                preproc_background_kernel_ratio: body.preproc_background_kernel_ratio,
                preproc_background_kernel_min: body.preproc_background_kernel_min,
                preproc_local_contrast_sigma: body.preproc_local_contrast_sigma,
                preproc_local_contrast_amount: body.preproc_local_contrast_amount,
                preproc_blackhat_kernel_size: body.preproc_blackhat_kernel_size,
                preproc_blackhat_strength: body.preproc_blackhat_strength,
                preproc_enable_adaptive_binarization: body.preproc_enable_adaptive_binarization,
                preproc_sauvola_window: body.preproc_sauvola_window,
                preproc_sauvola_k: body.preproc_sauvola_k,
                preproc_sauvola_r: body.preproc_sauvola_r,
                preproc_text_mask_block_size: body.preproc_text_mask_block_size,
                preproc_text_mask_c: body.preproc_text_mask_c,
                preproc_text_mask_open_kernel: body.preproc_text_mask_open_kernel,
                preproc_text_mask_close_kernel: body.preproc_text_mask_close_kernel,
                preproc_text_mask_close_iters: body.preproc_text_mask_close_iters,
                preproc_text_mask_dilate_iters: body.preproc_text_mask_dilate_iters,
                preproc_text_mask_min_area_ratio: body.preproc_text_mask_min_area_ratio,
                preproc_trim_band_ratio: body.preproc_trim_band_ratio,
                preproc_trim_ink_ratio_max: body.preproc_trim_ink_ratio_max,
                preproc_trim_max_ratio: body.preproc_trim_max_ratio,
                preproc_trim_min_dimension: body.preproc_trim_min_dimension,
                use_custom_profile: useCustom,
                custom_profile: custom
            };

            return { source, profiles, body, paramsSnapshot };
        }

        async function startProfile(profile) {
            const payload = buildJobPayload([profile], false);
            const { source, profiles, body } = payload;
            if (!source) {
                setActionMsg("Wybierz folder ≈∫r√≥d≈Çowy!", "text-red-400");
                return;
            }
            if (profiles.length === 0) {
                setActionMsg("Wybierz przynajmniej jeden profil!", "text-red-400");
                return;
            }

            setActionMsg(`Uruchamianie profilu "${profile}"...`, "text-blue-400");
            try {
                const res = await fetch('/api/jobs/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    storeJobParams(payload.paramsSnapshot);
                    setControlPanelLocked(true);
                    setTimeout(updateStats, 500);
                    setActionMsg(`Profil "${profile}" wystartowa≈Ç.`, "text-green-400");
                } else {
                    const err = await readJsonSafely(res);
                    setActionMsg("B≈ÇƒÖd: " + err.detail, "text-red-400");
                }
            } catch (e) {
                setActionMsg("B≈ÇƒÖd po≈ÇƒÖczenia: " + e, "text-red-400");
            }
        }

        async function startProfileWithOverrides(profile, overrides) {
            const payload = buildJobPayload([profile], false);
            const { source, profiles, body } = payload;
            if (!source) {
                setActionMsg("Wybierz folder ≈∫r√≥d≈Çowy!", "text-red-400");
                return;
            }
            if (profiles.length === 0) {
                setActionMsg("Wybierz przynajmniej jeden profil!", "text-red-400");
                return;
            }

            const mergedBody = { ...body, ...overrides };
            setActionMsg(`Restart profilu "${profile}" (okienkowy)...`, "text-yellow-400");
            try {
                const res = await fetch('/api/jobs/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(mergedBody)
                });

                if (res.ok) {
                    storeJobParams({ ...payload.paramsSnapshot, ...overrides });
                    setControlPanelLocked(true);
                    setTimeout(updateStats, 500);
                    setActionMsg(`Profil "${profile}" zrestartowany (okienkowy).`, "text-green-400");
                } else {
                    const err = await readJsonSafely(res);
                    setActionMsg("B≈ÇƒÖd: " + err.detail, "text-red-400");
                }
            } catch (e) {
                setActionMsg("B≈ÇƒÖd po≈ÇƒÖczenia: " + e, "text-red-400");
            }
        }

        function shouldAutoRestart(profile) {
            const key = `${AUTO_RESTART_KEY_PREFIX}${profile}`;
            const last = Number(sessionStorage.getItem(key) || 0);
            return (Date.now() - last) > AUTO_RESTART_COOLDOWN_MS;
        }

        function markAutoRestart(profile) {
            const key = `${AUTO_RESTART_KEY_PREFIX}${profile}`;
            sessionStorage.setItem(key, Date.now().toString());
        }

        async function autoRestartExpiredSessions(profiles) {
            const expired = profiles.filter(p => String(p.status || '').includes("SESJA WYGAS≈ÅA"));
            if (expired.length === 0) return;

            for (const p of expired) {
                if (!shouldAutoRestart(p.name)) continue;
                markAutoRestart(p.name);
                await stopProfile(p.name);
                await startProfileWithOverrides(p.name, { headed: true });
            }
        }

        async function stopProfile(profile) {
            setActionMsg(`Zatrzymywanie profilu "${profile}"...`, "text-blue-400");
            try {
                const res = await fetch(`/api/jobs/stop/${encodeURIComponent(profile)}`, { method: 'POST' });
                if (res.ok) {
                    updateStats();
                    setActionMsg(`Profil "${profile}" zatrzymany.`, "text-gray-300");
                } else {
                    const err = await readJsonSafely(res);
                    setActionMsg("B≈ÇƒÖd: " + err.detail, "text-red-400");
                }
            } catch (e) {
                setActionMsg("B≈ÇƒÖd po≈ÇƒÖczenia: " + e, "text-red-400");
            }
        }

        async function resetProfile(profile) {
            const wasActive = runningProfiles.has(profile);
            if (wasActive) {
                await stopProfile(profile);
            }
            setActionMsg(`Reset profilu "${profile}"...`, "text-yellow-400");
            try {
                const res = await fetch(`/api/profiles/reset/${encodeURIComponent(profile)}`, { method: 'POST' });
                if (!res.ok) {
                    const err = await readJsonSafely(res);
                    setActionMsg("B≈ÇƒÖd: " + (err.detail || res.status), "text-red-400");
                    return;
                }
                if (wasActive) {
                    const source = document.getElementById('sourcePath').value;
                    if (!source) {
                        setActionMsg(`Reset wykonany. Ustaw folder ≈∫r√≥d≈Çowy, aby uruchomiƒá profil "${profile}".`, "text-yellow-400");
                        return;
                    }
                    await startProfile(profile);
                } else {
                    setActionMsg(`Reset wykonany dla profilu "${profile}".`, "text-green-400");
                }
            } catch (e) {
                setActionMsg("B≈ÇƒÖd po≈ÇƒÖczenia: " + e, "text-red-400");
            }
        }

        async function startJob() {
            const source = document.getElementById('sourcePath').value;
            if (!source) {
                setActionMsg("Wybierz folder ≈∫r√≥d≈Çowy!", "text-red-400");
                return;
            }

            const checkboxes = document.querySelectorAll('input[name="profileCheckbox"]:checked');
            const selectedProfiles = Array.from(checkboxes).map(cb => cb.value);
            const payload = buildJobPayload(selectedProfiles, true);
            const profiles = payload.profiles;

            if (profiles.length === 0) {
                setActionMsg("Wybierz przynajmniej jeden profil!", "text-red-400");
                return;
            }

            const body = payload.body;
            const paramsSnapshot = payload.paramsSnapshot;

            setActionMsg("Uruchamianie...", "text-blue-400");

            try {
                const res = await fetch('/api/jobs/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    storeJobParams(paramsSnapshot);
                    applyJobParams(paramsSnapshot);
                    setControlPanelLocked(true);
                    sessionStartMs = Date.now().toString();
                    sessionStorage.setItem(SESSION_START_KEY, sessionStartMs);
                    setActionMsg("Zadanie wystartowa≈Ço!", "text-green-400");
                    // Optymistyczna aktualizacja UI - ustawiamy isRunning=true natychmiast
                    isRunning = true;
                    // Natychmiastowe od≈õwie≈ºanie + follow-up po 100ms
                    updateStats();
                    setTimeout(updateStats, 100);
                } else {
                    const err = await readJsonSafely(res);
                    setActionMsg("B≈ÇƒÖd: " + err.detail, "text-red-400");
                }
            } catch (e) {
                setActionMsg("B≈ÇƒÖd po≈ÇƒÖczenia: " + e, "text-red-400");
            }
        }

        function showStopModal() {
            document.getElementById('stopModal').classList.remove('hidden');
        }

        function closeStopModal() {
            document.getElementById('stopModal').classList.add('hidden');
        }

        async function confirmStop() {
            closeStopModal();
            setActionMsg("Zatrzymywanie...", "text-blue-400");
            const btn = document.getElementById('stopBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">Zatrzymywanie...</span>';

            try {
                const res = await fetch('/api/jobs/stop', { method: 'POST' });
                if (res.ok) {
                    // Optymistyczna aktualizacja UI - ustawiamy isRunning=false natychmiast
                    isRunning = false;
                    // Natychmiastowe od≈õwie≈ºanie + follow-up
                    updateStats();
                    setTimeout(updateStats, 100);
                    setActionMsg("Zatrzymano.", "text-gray-300");
                } else {
                    console.error("Stop failed status", res.status);
                    setActionMsg("B≈ÇƒÖd zatrzymywania (Status " + res.status + ")", "text-red-400");
                }
            } catch (e) {
                console.error("Stop failed net", e);
                setActionMsg("B≈ÇƒÖd sieci: " + e, "text-red-400");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function stopJob() {
            showStopModal();
        }

        async function restartApp() {
            const btn = document.getElementById('restartAppBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span><span>Restarting...</span>';

            try {
                const res = await fetch('/api/restart', { method: 'POST' });
                const data = await readJsonSafely(res);

                // Wait for server to restart, then reload
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } catch (e) {
                console.error('Restart failed:', e);
                btn.disabled = false;
                btn.innerHTML = originalText;
                setActionMsg('B≈ÇƒÖd podczas restartu: ' + e.message, "text-red-400");
            }
        }

        // --- File Browser ---
        const LAST_BROWSER_PATH_KEY = 'lastBrowserPath';
        const LAST_SOURCE_KEY = 'ocrLastSource';

        // Load persisted source path
        const savedSource = localStorage.getItem(LAST_SOURCE_KEY);
        const storedParams = loadStoredJobParams();
        const fallbackSource = (storedParams && storedParams.source_path) ? storedParams.source_path : '';
        if (savedSource || fallbackSource) {
            const el = document.getElementById('sourcePath');
            if (el && !el.value) {
                el.value = savedSource || fallbackSource;
            }
        }

        // Save on manual input
        const sourcePathEl = document.getElementById('sourcePath');
        if (sourcePathEl) {
            sourcePathEl.addEventListener('input', (e) => {
                localStorage.setItem(LAST_SOURCE_KEY, e.target.value);
            });
        }
        const browserCache = {};
        let browserRequestId = 0;

        function renderBrowserList(data) {
            const list = document.getElementById('fileList');
            const pathInput = document.getElementById('browserCurrentPath');
            if (!data) return;
            pathInput.value = data.current;
            localStorage.setItem(LAST_BROWSER_PATH_KEY, data.current);
            list.innerHTML = "";
            data.items.forEach(item => {
                const div = document.createElement('div');
                div.className = "p-2 hover:bg-gray-700 cursor-pointer flex items-center rounded text-sm text-gray-300";
                div.innerHTML = `<span class="mr-2 text-yellow-500">üìÅ</span> ${item.name}`;
                div.onclick = () => openBrowser(item.path);
                list.appendChild(div);
            });
        }

        function browserGoUp() {
            const current = document.getElementById('browserCurrentPath').value;
            if (!current) return;
            // Simple path manipulation for Linux paths
            const parts = current.split('/').filter(p => p);
            parts.pop();
            const parent = '/' + parts.join('/');
            openBrowser(parent);
        }

        function refreshBrowser() {
            const current = document.getElementById('browserCurrentPath').value;
            if (!current) return;
            if (browserCache[current]) {
                delete browserCache[current];
            }
            openBrowser(current);
        }

        async function openBrowser(path = null) {
            const modal = document.getElementById('fileBrowserModal');
            const list = document.getElementById('fileList');
            const pathInput = document.getElementById('browserCurrentPath');

            // Use provided path, or last saved path, or default NAS path
            if (!path) {
                path = localStorage.getItem(LAST_BROWSER_PATH_KEY) || '/mnt/nas_genealogy/Sources';
            }

            modal.classList.remove('hidden');
            document.getElementById('fileBrowserOverlay').classList.remove('hidden');

            // Render favorites list
            renderFavorites();

            // Center the modal if first open
            if (!modal.style.left || modal.style.left === '50%') {
                const vw = window.innerWidth;
                const vh = window.innerHeight;
                const modalWidth = Math.min(vw * 0.9, 1400);
                modal.style.left = ((vw - modalWidth) / 2) + 'px';
                modal.style.top = ((vh - 550) / 2) + 'px';
                modal.style.transform = '';
            }

            list.innerHTML = "<div class='p-2 text-gray-500'>≈Åadowanie...</div>";
            pathInput.value = path;

            const cacheEntry = browserCache[path];
            const now = Date.now();
            if (cacheEntry && now - cacheEntry.timestamp < 15000) {
                renderBrowserList(cacheEntry.data);
            }

            const requestId = ++browserRequestId;

            try {
                const res = await fetch(`/api/browse?path=${encodeURIComponent(path)}`);
                const data = await readJsonSafely(res);
                if (requestId !== browserRequestId) return;

                if (data.error) {
                    setActionMsg("B≈ÇƒÖd: " + data.error, "text-red-400");
                    return;
                }

                browserCache[path] = { data, timestamp: Date.now() };
                renderBrowserList(data);
            } catch (e) {
                if (requestId !== browserRequestId) return;
                list.innerHTML = `<div class='p-2 text-red-500'>Error: ${e}</div>`;
            }
        }

        function selectCurrentFolder() {
            const path = document.getElementById('browserCurrentPath').value;
            document.getElementById('sourcePath').value = path;

            // Save selected path
            localStorage.setItem(LAST_BROWSER_PATH_KEY, path);
            localStorage.setItem(LAST_SOURCE_KEY, path);

            closeBrowser();
        }

        function closeBrowser() {
            document.getElementById('fileBrowserModal').classList.add('hidden');
            document.getElementById('fileBrowserOverlay').classList.add('hidden');
        }

        // --- Minimize/Maximize ---
        const browserState = {
            isMaximized: false,
            isMinimized: false,
            savedPosition: null
        };

        function minimizeBrowser() {
            const modal = document.getElementById('fileBrowserModal');
            if (browserState.isMinimized) {
                // Restore
                modal.style.height = browserState.savedPosition?.height || '550px';
                modal.querySelector('.window-content').style.display = 'flex';
                browserState.isMinimized = false;
            } else {
                // Minimize - just show titlebar
                browserState.savedPosition = {
                    ...browserState.savedPosition,
                    height: modal.style.height || '550px'
                };
                modal.style.height = '32px';
                modal.querySelector('.window-content').style.display = 'none';
                browserState.isMinimized = true;
            }
        }

        function maximizeBrowser() {
            const modal = document.getElementById('fileBrowserModal');
            if (browserState.isMaximized) {
                // Restore
                modal.style.left = browserState.savedPosition.left;
                modal.style.top = browserState.savedPosition.top;
                modal.style.width = browserState.savedPosition.width;
                modal.style.height = browserState.savedPosition.height;
                browserState.isMaximized = false;
            } else {
                // Save current position
                browserState.savedPosition = {
                    left: modal.style.left,
                    top: modal.style.top,
                    width: modal.style.width,
                    height: modal.style.height
                };
                // Maximize
                modal.style.left = '20px';
                modal.style.top = '20px';
                modal.style.width = 'calc(100vw - 40px)';
                modal.style.height = 'calc(100vh - 40px)';
                browserState.isMaximized = true;
            }
            browserState.isMinimized = false;
            modal.querySelector('.window-content').style.display = 'flex';
        }

        // --- Favorites ---
        const FAVORITES_KEY = 'browserFavorites';
        let cachedFavorites = null;

        async function loadFavorites() {
            // Try server first, fallback to localStorage
            try {
                const res = await fetch('/api/favorites');
                const data = await readJsonSafely(res);
                if (data.favorites && data.favorites.length > 0) {
                    cachedFavorites = data.favorites;
                    // Sync to localStorage as backup
                    localStorage.setItem(FAVORITES_KEY, JSON.stringify(data.favorites));
                    return data.favorites;
                }
            } catch (e) {
                console.warn('Failed to load favorites from server:', e);
            }
            // Fallback to localStorage
            const saved = localStorage.getItem(FAVORITES_KEY);
            cachedFavorites = saved ? JSON.parse(saved) : [];
            return cachedFavorites;
        }

        async function saveFavorites(favorites) {
            cachedFavorites = favorites;
            // Save to localStorage immediately
            localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
            // Save to server
            try {
                await fetch('/api/favorites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ favorites })
                });
            } catch (e) {
                console.warn('Failed to save favorites to server:', e);
            }
        }

        async function renderFavorites() {
            const list = document.getElementById('favoritesList');
            const favorites = await loadFavorites();

            list.innerHTML = '';

            // Quick access locations (always visible)
            const quickAccess = [
                { path: 'HOME', icon: 'üè†', name: 'Home' },
                { path: '/home/tomaasz/ocr-stare-dokumenty', icon: 'üìÅ', name: 'Projekt OCR' },
                { path: '/tmp', icon: 'üìÇ', name: 'Temp' }
            ];

            // Quick access section
            quickAccess.forEach(loc => {
                const div = document.createElement('div');
                div.className = 'p-1.5 hover:bg-gray-700 cursor-pointer flex items-center rounded text-xs text-gray-400';
                div.innerHTML = `<span class="mr-1">${loc.icon}</span><span class="truncate">${loc.name}</span>`;
                div.onclick = () => openBrowser(loc.path);
                div.title = loc.path;
                list.appendChild(div);
            });

            // Separator if there are favorites
            if (favorites.length > 0) {
                const sep = document.createElement('div');
                sep.className = 'border-t border-gray-600 my-2';
                list.appendChild(sep);
            }

            // User favorites
            favorites.forEach((fav, index) => {
                const div = document.createElement('div');
                div.className = 'p-1.5 hover:bg-gray-700 cursor-pointer flex items-center justify-between rounded text-xs text-gray-300 group';
                const name = fav.split('/').pop() || fav;
                div.innerHTML = `
                    <span class="flex items-center truncate" title="${fav}" onclick="openBrowser('${fav}')">
                        <span class="mr-1 text-yellow-500">‚≠ê</span>
                        <span class="truncate">${name}</span>
                    </span>
                    <button onclick="event.stopPropagation(); removeFavorite(${index})" 
                            class="text-red-400 hover:text-red-300 opacity-0 group-hover:opacity-100 ml-1" 
                            title="Usu≈Ñ">‚úï</button>
                `;
                list.appendChild(div);
            });
        }

        async function addCurrentToFavorites() {
            const path = document.getElementById('browserCurrentPath').value;
            if (!path) return;

            const favorites = await loadFavorites();
            if (!favorites.includes(path)) {
                favorites.push(path);
                await saveFavorites(favorites);
                renderFavorites();
            }
        }

        async function removeFavorite(index) {
            const favorites = await loadFavorites();
            favorites.splice(index, 1);
            await saveFavorites(favorites);
            renderFavorites();
        }

        // Flag to prevent closing when drag/resize just ended
        let wasDraggingOrResizing = false;

        function handleOverlayClick(event) {
            // Don't close if we just finished dragging or resizing
            if (wasDraggingOrResizing) {
                wasDraggingOrResizing = false;
                return;
            }
            closeBrowser();
        }

        // --- File Browser Drag/Resize ---
        const fileBrowserDrag = {
            dragging: false,
            resizing: false,
            startX: 0,
            startY: 0,
            startLeft: 0,
            startTop: 0,
            startWidth: 0,
            startHeight: 0,
            direction: '',

            init() {
                const modal = document.getElementById('fileBrowserModal');
                const titlebar = document.getElementById('fileBrowserTitlebar');
                const browserTitleText = titlebar.querySelector('.window-title');
                if (browserTitleText) {
                    browserTitleText.addEventListener('mousedown', (event) => event.stopPropagation());
                }

                // Remove transform after first show to allow proper positioning
                modal.style.transform = '';

                titlebar.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.window-controls')) return;
                    this.dragging = true;
                    this.startX = e.clientX;
                    this.startY = e.clientY;
                    this.startLeft = modal.offsetLeft;
                    this.startTop = modal.offsetTop;
                });

                // Resize handles
                modal.querySelectorAll('.resize-handle').forEach(handle => {
                    handle.addEventListener('mousedown', (e) => {
                        e.stopPropagation();
                        this.resizing = true;
                        this.direction = handle.classList[1];
                        this.startX = e.clientX;
                        this.startY = e.clientY;
                        this.startLeft = modal.offsetLeft;
                        this.startTop = modal.offsetTop;
                        this.startWidth = modal.offsetWidth;
                        this.startHeight = modal.offsetHeight;
                    });
                });

                document.addEventListener('mousemove', (e) => this.onMouseMove(e));
                document.addEventListener('mouseup', () => {
                    if (this.dragging || this.resizing) {
                        wasDraggingOrResizing = true;
                    }
                    this.dragging = false;
                    this.resizing = false;
                });
            },

            onMouseMove(e) {
                const modal = document.getElementById('fileBrowserModal');
                const gridSize = 20;

                if (this.dragging) {
                    const dx = e.clientX - this.startX;
                    const dy = e.clientY - this.startY;
                    let newLeft = this.startLeft + dx;
                    let newTop = this.startTop + dy;

                    // Grid Snap
                    newLeft = Math.round(newLeft / gridSize) * gridSize;
                    newTop = Math.round(newTop / gridSize) * gridSize;

                    modal.style.left = newLeft + 'px';
                    modal.style.top = newTop + 'px';
                }

                if (this.resizing) {
                    const dx = e.clientX - this.startX;
                    const dy = e.clientY - this.startY;
                    const dir = this.direction;
                    const snap = (v) => Math.round(v / gridSize) * gridSize;

                    let newWidth = this.startWidth;
                    let newHeight = this.startHeight;
                    let newLeft = this.startLeft;
                    let newTop = this.startTop;

                    if (dir.includes('e')) {
                        newWidth = snap(this.startWidth + dx);
                    }
                    if (dir.includes('w')) {
                        const rightEdge = this.startLeft + this.startWidth;
                        newLeft = snap(this.startLeft + dx);
                        newWidth = rightEdge - newLeft;
                    }
                    if (dir.includes('s')) {
                        newHeight = snap(this.startHeight + dy);
                    }
                    if (dir.includes('n')) {
                        const bottomEdge = this.startTop + this.startHeight;
                        newTop = snap(this.startTop + dy);
                        newHeight = bottomEdge - newTop;
                    }

                    // Min size
                    newWidth = Math.max(400, newWidth);
                    newHeight = Math.max(300, newHeight);

                    modal.style.width = newWidth + 'px';
                    modal.style.height = newHeight + 'px';
                    if (dir.includes('w')) modal.style.left = newLeft + 'px';
                    if (dir.includes('n')) modal.style.top = newTop + 'px';
                }
            }
        };

        // --- Init ---
        windowManager.init();
        // Initialize mobile accordion if on mobile device
        if (windowManager.isMobile()) {
            windowManager.initMobileAccordion();
        }
        fileBrowserDrag.init();
        switchControlTab('basic');

        // ============================================
        // (Navigation is now horizontal tabs - no JS needed)
        // ============================================
        // -----------------------------------------------------------------------------
        // Post-Process Logic
        // -----------------------------------------------------------------------------
        let postProcInterval = null;

        async function runPostProcMigration() {
            const dsn = document.getElementById('postProcDsn').value;
            if (!dsn) {
                alert("Enter DSN first!");
                return;
            }
            localStorage.setItem('ocr_pg_dsn', dsn);

            setActionMsg("Running migration...", "text-blue-300");
            try {
                const resp = await fetch('/api/postprocess/migrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dsn: dsn })
                });
                const data = await readJsonSafely(resp);
                if (data.status === 'success') {
                    alert("Migration Success!\n" + (data.output || ""));
                    setActionMsg("Migration done.", "text-green-300");
                } else {
                    alert("Migration Failed:\n" + data.detail);
                    setActionMsg("Migration failed.", "text-red-400");
                }
            } catch (e) {
                alert("Error: " + e);
            }
        }

        async function togglePostProc() {
            const btn = document.getElementById('btnPostProcToggle');
            const isRunning = btn.innerText.includes('Stop');

            if (isRunning) {
                // STOP
                await fetch('/api/postprocess/stop', { method: 'POST' });
                btn.innerText = "‚ñ∂ Start Processing";
                btn.className = "bg-green-700 hover:bg-green-600 text-white text-xs py-1 px-2 rounded border border-green-600 transition font-bold";
            } else {
                // START
                // Use main DSN from Control Panel -> Baza/DB
                const dsnInput = document.getElementById('pgDsn');
                const dsn = dsnInput ? dsnInput.value : '';

                if (!dsn) {
                    alert("Proszƒô wpisaƒá DSN w zak≈Çadce Panel Kontrolny -> Baza/DB!");
                    return;
                }

                // No need to save manually, pgDsn saves itself on change usually, or we assume it's saved.

                // Get API Key
                const apiKey = document.getElementById('postProcApiKey').value;
                if (apiKey) {
                    localStorage.setItem('ocr_openrouter_key', apiKey);
                }

                const resp = await fetch('/api/postprocess/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dsn: dsn, api_key: apiKey })
                });
                if (resp.ok) {
                    btn.innerText = "‚èπ Stop Processing";
                    btn.className = "bg-red-700 hover:bg-red-600 text-white text-xs py-1 px-2 rounded border border-red-600 transition font-bold";
                } else {
                    const err = await readJsonSafely(resp);
                    alert("Failed to start: " + err.detail);
                }
            }
            updatePostProcStatus();
        }

        async function updatePostProcStatus() {
            // Poll regardless of tab visibility since it is a window now
            // Use main DSN
            const dsnInput = document.getElementById('pgDsn');
            const dsn = dsnInput ? dsnInput.value : null;

            // if (!dsn && !postProcInterval) return; 
            // We can poll status without DSN to check running, but need DSN for stats

            try {
                const url = `/api/postprocess/status` + (dsn ? `?dsn=${encodeURIComponent(dsn)}` : '');
                const resp = await fetch(url);
                const data = await readJsonSafely(resp);

                const statusEl = document.getElementById('postProcStatus');
                const btn = document.getElementById('btnPostProcToggle');

                if (data.running) {
                    statusEl.textContent = "RUNNING";
                    statusEl.className = "text-green-400 font-bold animate-pulse";
                    if (btn.innerText.includes('Start')) {
                        btn.innerText = "‚èπ Stop Processing";
                        btn.className = "bg-red-700 hover:bg-red-600 text-white text-xs py-1 px-2 rounded border border-red-600 transition font-bold";
                    }
                } else {
                    statusEl.textContent = "IDLE";
                    statusEl.className = "text-gray-400";
                    if (btn.innerText.includes('Stop')) {
                        btn.innerText = "‚ñ∂ Start Processing";
                        btn.className = "bg-green-700 hover:bg-green-600 text-white text-xs py-1 px-2 rounded border border-green-600 transition font-bold";
                    }
                }

                const detailsEl = document.getElementById('postProcDetails');
                if (detailsEl) {
                    const pid = data.pid ? `PID ${data.pid}` : "brak PID";
                    const state = data.running ? "aktywny" : "zatrzymany";
                    const extra = data.pids && data.pids.length > 1 ? `, procesy: ${data.pids.length}` : "";
                    detailsEl.textContent = `${state}, ${pid}${extra}`;
                }

                const lastLogEl = document.getElementById('postProcLastLog');
                if (lastLogEl) {
                    lastLogEl.textContent = data.last_log || "brak";
                    lastLogEl.title = data.last_log || "";
                }

                if (data.stats) {
                    document.getElementById('postProcCountNew').textContent = data.stats.new || 0;
                    document.getElementById('postProcCountDone').textContent = data.stats.processed || 0;

                    const total = (data.stats.total || 0);
                    const done = (data.stats.processed || 0);
                    const pct = total > 0 ? (done / total) * 100 : 0;
                    document.getElementById('postProcBar').style.width = `${pct}%`;
                }
            } catch (e) {
                console.warn("PostProc poll failed", e);
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // Restore DSN - handled by main panel logic for pgDsn
            // const savedDsn = localStorage.getItem('ocr_pg_dsn');
            // if (savedDsn) {
            //     const input = document.getElementById('postProcDsn');
            //     if (input) input.value = savedDsn;
            // }

            // Start poll loop
            setInterval(updatePostProcStatus, 2000);

            // Restore API Key
            const savedKey = localStorage.getItem('ocr_openrouter_key');
            if (savedKey) {
                const input = document.getElementById('postProcApiKey');
                if (input) input.value = savedKey;
            }
        });

        initLimitCheckHost();
        loadLogsPreferences();
        updateLogsTaskbarButton();
        updateStats();
        updateLivePreviews();
        loadProfiles();

        document.addEventListener('visibilitychange', () => {
            scheduleNextStatsPoll(document.hidden ? POLL_HIDDEN_MS : POLL_ACTIVE_MS);
        });

        window.addEventListener('load', () => {
            if (windowManager.locked) {
                windowManager.handleResize();
            }
        });

        if (document.fonts && document.fonts.ready) {
            document.fonts.ready.then(() => {
                if (windowManager.locked) {
                    windowManager.handleResize();
                }
            }).catch(() => { });
        }

        // Escape key closes modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Close image preview modal first if open
                const imageModal = document.getElementById('imagePreviewModal');
                if (!imageModal.classList.contains('hidden')) {
                    closeImageModal();
                    return;
                }
                // Then check folder browser
                const modal = document.getElementById('fileBrowserModal');
                if (!modal.classList.contains('hidden')) {
                    closeBrowser();
                }
            }
        });
    </script>
</body>

</html>