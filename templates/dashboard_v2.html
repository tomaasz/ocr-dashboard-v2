<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Farm Dashboard v2</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="stylesheet" href="/static/dashboard_v2.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        /* Force text selection globally */
        * {
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
        }

        /* Breadcrumb Styles */
        .breadcrumb-container {
            padding: var(--spacing-md) var(--spacing-lg);
            background-color: var(--color-bg-card);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            animation: fadeIn 0.3s ease-in-out;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
        }

        .breadcrumb-item:not(:last-child)::after {
            content: ">>";
            margin: 0 var(--spacing-sm);
            color: var(--color-text-tertiary);
            font-size: 0.8em;
        }

        .breadcrumb-item.active {
            color: var(--color-text-primary);
            font-weight: 500;
        }

        /* Make hero not overlap breadcrumb */
        .stats-hero {
            margin-top: 0;
            border-top: none;
        }
    </style>
    <script>
        // XSS Protection Helper
        function escapeHtml(text) {
            if (text == null) return '';
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        const LIMIT_WORKER_URL = JSON.parse('{{ limit_worker_url | tojson | safe }}') || "http://100.102.158.100:8001";
    </script>
</head>

<body>
    <div class="app-layout" id="appLayout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">OCR</div>
                <span class="sidebar-title">Farm Dashboard</span>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title" data-i18n="nav.menu">Menu</div>
                    <a class="nav-item active" data-tab="overview" onclick="switchTab('overview')">
                        <span class="nav-item-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="7" height="7" rx="1" />
                                <rect x="14" y="3" width="7" height="7" rx="1" />
                                <rect x="3" y="14" width="7" height="7" rx="1" />
                                <rect x="14" y="14" width="7" height="7" rx="1" />
                            </svg>
                        </span>
                        <span class="nav-item-text" data-i18n="nav.overview">Przegląd</span>
                    </a>
                    <a class="nav-item" data-tab="profiles" onclick="switchTab('profiles')">
                        <span class="nav-item-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                            </svg>
                        </span>
                        <span class="nav-item-text" data-i18n="nav.profiles">Profile</span>
                        <span class="nav-item-badge" id="profileCount">{{ profiles|length }}</span>
                    </a>
                    <a class="nav-item" data-tab="activity" onclick="switchTab('activity')">
                        <span class="nav-item-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                            </svg>
                        </span>
                        <span class="nav-item-text" data-i18n="nav.activity">Aktywność</span>
                    </a>
                    <a class="nav-item" data-tab="preview" onclick="switchTab('preview')">
                        <span class="nav-item-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                <circle cx="8.5" cy="8.5" r="1.5" />
                                <polyline points="21 15 16 10 5 21" />
                            </svg>
                        </span>
                        <span class="nav-item-text" data-i18n="nav.preview">Podgląd</span>
                    </a>
                    <a class="nav-item" data-tab="logs" onclick="switchTab('logs')">
                        <span class="nav-item-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                                <line x1="16" y1="13" x2="8" y2="13" />
                                <line x1="16" y1="17" x2="8" y2="17" />
                            </svg>
                        </span>
                        <span class="nav-item-text" data-i18n="nav.logs">Logi</span>
                    </a>
                    <a class="nav-item" data-tab="limits" onclick="switchTab('limits')">
                        <span class="nav-item-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83" />
                            </svg>
                        </span>
                        <span class="nav-item-text" data-i18n="nav.limits">Limity</span>
                    </a>
                    <a class="nav-item" data-tab="postprocess" onclick="switchTab('postprocess')">
                        <span class="nav-item-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
                            </svg>
                        </span>
                        <span class="nav-item-text" data-i18n="nav.postprocess">Post-Process</span>
                    </a>
                    <a class="nav-item" data-tab="jobconfig" onclick="switchTab('jobconfig')">
                        <span class="nav-item-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polygon points="12 2 2 7 12 12 22 7 12 2" />
                                <polyline points="2 17 12 22 22 17" />
                                <polyline points="2 12 12 17 22 12" />
                            </svg>
                        </span>
                        <span class="nav-item-text" data-i18n="nav.jobconfig">Konfiguracja Job</span>
                    </a>
                    <a class="nav-item" data-tab="settings" onclick="switchTab('settings')">
                        <span class="nav-item-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="3" />
                                <path
                                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                            </svg>
                        </span>
                        <span class="nav-item-text" data-i18n="nav.settings">Ustawienia</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title" data-i18n="nav.quickStatus">Szybki status</div>
                    <div class="quick-status">
                        <div class="quick-status-row mb-sm">
                            <span class="quick-status-icon quick-status-icon-success" aria-hidden="true"></span>
                            <span class="quick-status-label text-secondary" data-i18n="nav.active">Aktywne</span>
                            <span class="quick-status-count font-bold text-success" id="sidebarActiveCount">0</span>
                        </div>
                        <div class="quick-status-row mb-sm">
                            <span class="quick-status-icon quick-status-icon-warning" aria-hidden="true"></span>
                            <span class="quick-status-label text-secondary" data-i18n="nav.paused">Wstrzymane</span>
                            <span class="quick-status-count font-bold text-warning" id="sidebarPausedCount">0</span>
                        </div>
                        <div class="quick-status-row mb-sm">
                            <span class="quick-status-icon quick-status-icon-error" aria-hidden="true"></span>
                            <span class="quick-status-label text-secondary" data-i18n="nav.limit">Limit</span>
                            <span class="quick-status-count font-bold text-error" id="sidebarLimitCount">0</span>
                        </div>
                        <div class="quick-status-row">
                            <span class="quick-status-icon quick-status-icon-info" aria-hidden="true"></span>
                            <span class="quick-status-label text-secondary" data-i18n="nav.todayScans">Dzisiejsze
                                skany</span>
                            <span class="quick-status-count font-bold text-info" id="sidebarTodayScans">0</span>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="11 17 6 12 11 7" />
                        <polyline points="18 17 13 12 18 7" />
                    </svg>
                    <span class="nav-item-text" data-i18n="nav.collapse">Zwiń</span>
                </button>
            </div>
        </aside>

        <!-- Header -->
        <header class="header">
            <button class="btn btn-ghost btn-icon mobile-menu-btn" onclick="toggleSidebar()" style="display: none;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12" />
                    <line x1="3" y1="6" x2="21" y2="6" />
                    <line x1="3" y1="18" x2="21" y2="18" />
                </svg>
            </button>

            <!-- Connection Status Indicator -->
            <div class="connection-status" id="connectionStatus" title="Połączenie z serwerem">
                <span class="connection-dot connected"></span>
            </div>

            <!-- Stats removed from header -->

            <div class="header-actions">
                <button class="btn btn-success btn-sm" onclick="openStartJobModal()" data-i18n-title="startJob.title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3" />
                    </svg>
                    <span data-i18n="header.startJob">Start Job</span>
                </button>
                <button class="btn btn-danger btn-sm" onclick="stopAllProfiles()" title="Stop All">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="6" width="12" height="12" rx="1" />
                    </svg>
                    Stop All
                </button>
                <button class="btn btn-secondary btn-sm" onclick="refreshData()" title="Odśwież dane"
                    id="refreshDataBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        id="refreshIcon">
                        <polyline points="23 4 23 10 17 10" />
                        <polyline points="1 20 1 14 7 14" />
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                    </svg>
                </button>
                <div class="header-actions-divider"></div>
                <button class="btn btn-warning btn-sm" onclick="restartAppConfirm()" title="Zrestartuj aplikację">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 2v6h-6" />
                        <path d="M3 12a9 9 0 0 1 15-6.7L21 8" />
                        <path d="M3 22v-6h6" />
                        <path d="M21 12a9 9 0 0 1-15 6.7L3 16" />
                    </svg>
                    Restart
                </button>
                <button class="btn btn-secondary btn-sm" onclick="openCleanupModal()" title="Wyczyść foldery">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6" />
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                    </svg>
                    Cleanup
                </button>
                <div class="header-actions-divider"></div>
                <div class="lang-switcher">
                    <button class="lang-btn active" data-lang="pl" onclick="setLanguage('pl')"
                        title="Polski">PL</button>
                    <button class="lang-btn" data-lang="en" onclick="setLanguage('en')" title="English">EN</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Breadcrumb Navigation -->
            <div id="breadcrumb" class="breadcrumb-container">
                <span class="breadcrumb-item">Menu</span>
                <span class="breadcrumb-item active" id="breadcrumbCurrent">Przegląd</span>
            </div>
            <!-- Command Center Hero -->
            <div class="stats-hero">
                <div class="stats-hero-container">
                    <!-- Status Group -->
                    <div class="hero-group">
                        <div class="hero-card hero-card-success">
                            <div class="hero-label" data-i18n="header.active">AKTYWNYCH</div>
                            <div class="hero-value" id="headerActiveProfiles">0</div>
                        </div>
                        <div class="hero-card hero-card-warning">
                            <div class="hero-label" data-i18n="header.paused">WSTRZYMANYCH</div>
                            <div class="hero-value" id="headerPausedProfiles">0</div>
                        </div>
                        <div class="hero-card hero-card-error">
                            <div class="hero-label" data-i18n="header.limit">LIMIT</div>
                            <div class="hero-value" id="headerLimitProfiles">0</div>
                        </div>
                    </div>

                    <!-- Primary Metric (Center) -->
                    <div class="hero-group hero-group-main">
                        <div class="hero-card hero-card-primary">
                            <div class="hero-icon-wrapper">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                            </div>
                            <div class="hero-main-content">
                                <div class="hero-label" data-i18n="header.today">DZISIEJSZE SKANY</div>
                                <div class="hero-value hero-value-lg" id="headerTodayScans">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Info Group -->
                    <div class="hero-group">
                        <div class="hero-card hero-card-neutral">
                            <div class="hero-label" data-i18n="header.proEst">EST. CZAS</div>
                            <div class="hero-value" id="headerProRemaining">-</div>
                        </div>
                        <div class="hero-card hero-card-neutral">
                            <div class="hero-label" data-i18n="header.batch">BATCH</div>
                            <div class="hero-value code-font" id="headerBatchId">-</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Overview Tab -->
            <div class="tab-panel active" id="tab-overview">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Overview</h1>
                        <p class="page-subtitle">Podsumowanie stanu farmy OCR</p>
                    </div>
                    <div class="flex gap-sm">
                        <span class="text-secondary" style="font-size: 12px;">
                            Ostatnia aktualizacja: <span id="lastUpdate">-</span>
                        </span>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="statTotalProfiles">{{ profiles|length }}</div>
                            <div class="stat-label">Wszystkich profili</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon green">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="statActiveWorkers">0</div>
                            <div class="stat-label">Aktywnych workerów</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon cyan">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                <circle cx="8.5" cy="8.5" r="1.5" />
                                <polyline points="21 15 16 10 5 21" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="statTodayProcessed">0</div>
                            <div class="stat-label">Przetworzonych dziś</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon yellow">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <polyline points="12 6 12 12 16 14" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="statAvgTime">-</div>
                            <div class="stat-label">Śr. czas/skan</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon red">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                                <line x1="12" y1="9" x2="12" y2="13" />
                                <line x1="12" y1="17" x2="12.01" y2="17" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="statErrors">0</div>
                            <div class="stat-label">Błędów</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Overview Cards -->
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-md);">
                    <!-- Recent Activity -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Ostatnia aktywność</h3>
                            <button class="btn btn-ghost btn-sm" onclick="switchTab('activity')">Zobacz
                                wszystko</button>
                        </div>
                        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                            <div id="recentActivityList">
                                <div class="empty-state">
                                    <div class="empty-icon">...</div>
                                    <p class="empty-message">Brak ostatniej aktywności</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Status Summary -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Status profili</h3>
                            <button class="btn btn-ghost btn-sm" onclick="switchTab('profiles')">Zarządzaj</button>
                        </div>
                        <div class="card-body">
                            <div id="profileStatusSummary">
                                <div style="margin-bottom: var(--spacing-md);">
                                    <div class="flex justify-between mb-sm">
                                        <span class="text-secondary">Aktywne</span>
                                        <span class="font-bold" id="summaryActive">0</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar success" id="progressActive" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: var(--spacing-md);">
                                    <div class="flex justify-between mb-sm">
                                        <span class="text-secondary">Wstrzymane</span>
                                        <span class="font-bold" id="summaryPaused">0</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar warning" id="progressPaused" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: var(--spacing-md);">
                                    <div class="flex justify-between mb-sm">
                                        <span class="text-secondary">Limit osiągnięty</span>
                                        <span class="font-bold" id="summaryLimit">0</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar error" id="progressLimit" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-sm">
                                        <span class="text-secondary">Idle</span>
                                        <span class="font-bold" id="summaryIdle">0</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar" id="progressIdle"
                                            style="width: 0%; background: var(--color-idle);"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profiles Tab -->
            <div class="tab-panel" id="tab-profiles">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Profile</h1>
                        <p class="page-subtitle">Zarządzaj profilami OCR (<span id="profilesVisibleCount">0</span> z {{
                            profiles|length }})</p>
                    </div>
                </div>

                <!-- Toolbar -->
                <div class="profiles-toolbar">
                    <div class="search-box">
                        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8" />
                            <line x1="21" y1="21" x2="16.65" y2="16.65" />
                        </svg>
                        <input type="text" class="search-input" id="profileSearch" placeholder="Szukaj profilu..."
                            oninput="filterProfiles()">
                    </div>

                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">
                            Wszystkie <span class="count" id="filterAllCount">0</span>
                        </button>
                        <button class="filter-btn" data-filter="active" onclick="setFilter('active')">
                            Aktywne <span class="count" id="filterActiveCount">0</span>
                        </button>
                        <button class="filter-btn" data-filter="paused" onclick="setFilter('paused')">
                            Wstrzymane <span class="count" id="filterPausedCount">0</span>
                        </button>
                        <button class="filter-btn" data-filter="limit" onclick="setFilter('limit')">
                            Limit <span class="count" id="filterLimitCount">0</span>
                        </button>
                        <button class="filter-btn" data-filter="idle" onclick="setFilter('idle')">
                            Idle <span class="count" id="filterIdleCount">0</span>
                        </button>
                    </div>

                    <div style="margin-left: auto; display: flex; gap: var(--spacing-sm);">
                        <!-- View Toggle -->
                        <div class="view-toggle">
                            <button class="view-toggle-btn" data-view="grid" onclick="setViewMode('grid')"
                                title="Widok siatki">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7" />
                                    <rect x="14" y="3" width="7" height="7" />
                                    <rect x="3" y="14" width="7" height="7" />
                                    <rect x="14" y="14" width="7" height="7" />
                                </svg>
                            </button>
                            <button class="view-toggle-btn active" data-view="table" onclick="setViewMode('table')"
                                title="Widok tabeli">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <line x1="8" y1="6" x2="21" y2="6" />
                                    <line x1="8" y1="12" x2="21" y2="12" />
                                    <line x1="8" y1="18" x2="21" y2="18" />
                                    <line x1="3" y1="6" x2="3.01" y2="6" />
                                    <line x1="3" y1="12" x2="3.01" y2="12" />
                                    <line x1="3" y1="18" x2="3.01" y2="18" />
                                </svg>
                            </button>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="toggleSelectMode()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="9 11 12 14 22 4" />
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                            </svg>
                            <span id="selectModeText">Zaznacz</span>
                        </button>
                    </div>
                </div>

                <!-- Profiles Grid -->
                <div class="profiles-grid hidden" id="profilesGrid">
                    {% for profile in profiles %}
                    <div class="profile-card status-{{ profile.status or 'idle' }}" data-profile="{{ profile.name }}"
                        data-status="{{ profile.status or 'idle' }}">
                        <div class="profile-card-header">
                            <input type="checkbox" class="profile-checkbox hidden" data-profile="{{ profile.name }}">
                            <div class="profile-info">
                                <h4 class="profile-name" title="{{ profile.name }}">{{ profile.name }}</h4>
                                <div class="profile-status-row">
                                    <span class="profile-status {{ profile.status or 'idle' }}">
                                        {% if profile.status == 'active' %}
                                        <span
                                            style="width:6px;height:6px;background:currentColor;border-radius:50%;animation:pulse 2s infinite;"></span>
                                        {% endif %}
                                        {{ profile.status_label or profile.status or 'IDLE' }}
                                    </span>
                                    {% if profile.current_worker %}
                                    <span class="profile-worker">Worker {{ profile.current_worker }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="profile-card-body">
                            <div class="profile-stats">
                                <div class="profile-stat">
                                    <div class="profile-stat-value">{{ profile.processed or 0 }}</div>
                                    <div class="profile-stat-label">Przetw.</div>
                                </div>
                                <div class="profile-stat">
                                    <div class="profile-stat-value">{{ profile.tokens_k or 0 }}k</div>
                                    <div class="profile-stat-label">Tokeny</div>
                                </div>
                                <div class="profile-stat">
                                    <div class="profile-stat-value">{{ profile.errors or 0 }}</div>
                                    <div class="profile-stat-label">Błędy</div>
                                </div>
                            </div>
                            {% if profile.last_activity %}
                            <div class="profile-activity">
                                {% if profile.status == 'active' %}
                                <span class="profile-activity-dot"></span>
                                {% endif %}
                                <span>{{ profile.last_activity }}</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="profile-card-mode">
                            <select class="execution-mode-select" data-profile="{{ profile.name }}"
                                onchange="updateExecutionMode('{{ profile.name }}', this.value)">
                                <option value="local">ubuntuovh</option>
                                <option value="wsl_browser">WSL remote browser</option>
                                <option value="wsl_worker">WSL remote worker</option>
                                <option value="desktop_browser">Desktop remote browser</option>
                                <option value="desktop_worker">Desktop remote worker</option>
                            </select>
                        </div>
                        <div class="profile-card-actions">
                            {% if profile.status == 'active' %}
                            <button class="profile-action-btn danger" onclick="stopProfile('{{ profile.name }}')"
                                title="Zatrzymaj">Stop</button>
                            {% else %}
                            <button class="profile-action-btn primary" onclick="startProfile('{{ profile.name }}')"
                                title="Uruchom">Start</button>
                            {% endif %}
                            <button class="profile-action-btn" onclick="loginProfile('{{ profile.name }}')"
                                title="Zaloguj">Login</button>
                            <button class="profile-action-btn" onclick="showProfileDetails('{{ profile.name }}')"
                                title="Szczegóły">Info</button>
                            <button class="profile-action-btn danger"
                                onclick="deleteProfileConfirm('{{ profile.name }}')" title="Usuń">Del</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Profiles Table View -->
                <div class="table-container" id="profilesTable">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="selectAllTable"
                                        onchange="toggleSelectAll()"></th>
                                <th>Profil</th>
                                <th style="width: 90px;">Status</th>
                                <th style="width: 160px;">Tryb</th>
                                <th style="width: 65px;">Przetw.</th>
                                <th style="width: 70px;">Tokeny</th>
                                <th style="width: 60px;">Błędy</th>
                                <th style="width: 130px;">Ostatnia aktywność</th>
                                <th style="width: 180px;">Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for profile in profiles %}
                            <tr class="profile-row" data-profile="{{ profile.name }}"
                                data-status="{{ profile.status or 'idle' }}">
                                <td><input type="checkbox" class="profile-checkbox-table"
                                        data-profile="{{ profile.name }}"></td>
                                <td>
                                    <span class="font-medium">{{ profile.name }}</span>
                                </td>
                                <td>
                                    <span
                                        class="badge badge-{{ 'success' if profile.status == 'active' else 'warning' if profile.status == 'paused' else 'error' if profile.status == 'limit' else 'neutral' }}">
                                        {{ profile.status_label or profile.status or 'IDLE' }}
                                    </span>
                                </td>
                                <td>
                                    <select class="execution-mode-select" data-profile="{{ profile.name }}"
                                        onchange="updateExecutionMode('{{ profile.name }}', this.value)">
                                        <option value="local">ubuntuovh</option>
                                        <option value="wsl_browser">WSL remote browser</option>
                                        <option value="wsl_worker">WSL remote worker</option>
                                        <option value="desktop_browser">Desktop remote browser</option>
                                        <option value="desktop_worker">Desktop remote worker</option>
                                    </select>
                                </td>
                                <td>{{ profile.processed or 0 }}</td>
                                <td>{{ profile.tokens_k or 0 }}k</td>
                                <td>{{ profile.errors or 0 }}</td>
                                <td class="text-secondary">{{ profile.last_activity or '-' }}</td>
                                <td>
                                    <div class="flex gap-sm">
                                        {% if profile.status == 'active' %}
                                        <button class="btn btn-danger btn-sm"
                                            onclick="stopProfile('{{ profile.name }}')">Stop</button>
                                        {% else %}
                                        <button class="btn btn-success btn-sm"
                                            onclick="startProfile('{{ profile.name }}')">Start</button>
                                        {% endif %}
                                        <button class="btn btn-secondary btn-sm"
                                            onclick="loginProfile('{{ profile.name }}')" title="Zaloguj">Login</button>
                                        <button class="btn btn-ghost btn-sm"
                                            onclick="showProfileDetails('{{ profile.name }}')">Info</button>
                                        <button class="btn btn-ghost btn-sm text-error"
                                            onclick="deleteProfileConfirm('{{ profile.name }}')"
                                            title="Usuń">Del</button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if not profiles %}
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.5">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <line x1="17" y1="8" x2="23" y2="8" />
                        </svg>
                    </div>
                    <h3 class="empty-title">Brak profili</h3>
                    <p class="empty-message">Nie znaleziono żadnych profili OCR. Dodaj nowy profil aby rozpocząć.</p>
                </div>
                {% endif %}
            </div>

            <!-- Activity Tab -->
            <div class="tab-panel" id="tab-activity">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Live Activity</h1>
                        <p class="page-subtitle">Podgląd aktualnie przetwarzanych dokumentów</p>
                    </div>
                    <div class="flex gap-sm">
                        <label class="checkbox-label">
                            <input type="checkbox" id="autoRefreshActivity" checked onchange="toggleAutoRefresh()">
                            Auto-refresh
                        </label>
                    </div>
                </div>

                <div class="live-preview-container" id="livePreviewContainer">
                    <!-- Live preview cards will be populated here -->
                    <div class="empty-state" id="noActivityMessage">
                        <div class="empty-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                <circle cx="8.5" cy="8.5" r="1.5" />
                                <polyline points="21 15 16 10 5 21" />
                            </svg>
                        </div>
                        <h3 class="empty-title">Brak aktywności</h3>
                        <p class="empty-message">Aktualnie żaden profil nie przetwarza dokumentów.</p>
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div class="tab-panel" id="tab-logs">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Logi</h1>
                        <p class="page-subtitle">Logi systemowe i aktywność profili</p>
                    </div>
                    <div class="flex gap-sm">
                        <select class="form-select" id="logProfileFilter" onchange="filterLogs()" style="width: 200px;">
                            <option value="all">Wszystkie profile</option>
                            {% for profile in profiles %}
                            <option value="{{ profile.name }}">{{ profile.name }}</option>
                            {% endfor %}
                        </select>
                        <select class="form-select" id="logLevelFilter" onchange="filterLogs()" style="width: 150px;">
                            <option value="all">Wszystkie poziomy</option>
                            <option value="info">INFO</option>
                            <option value="warn">WARN</option>
                            <option value="error">ERROR</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="clearLogs()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="3 6 5 6 21 6" />
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                            </svg>
                            Wyczyść
                        </button>
                    </div>
                </div>

                <div class="log-container" id="logContainer">
                    <div class="empty-state" id="noLogsMessage">
                        <div class="empty-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                            </svg>
                        </div>
                        <h3 class="empty-title">Brak logów</h3>
                        <p class="empty-message">Logi pojawią się tutaj po rozpoczęciu przetwarzania.</p>
                    </div>
                </div>
            </div>

            <!-- Live Preview Tab -->
            <div class="tab-panel" id="tab-preview">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Live Preview</h1>
                        <p class="page-subtitle">Podgląd na żywo aktywnych workerów</p>
                    </div>
                    <div class="flex gap-sm">
                        <button class="btn btn-secondary btn-sm" onclick="refreshLivePreviewAll()"
                            id="previewRefreshBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="23 4 23 10 17 10" />
                                <polyline points="1 20 1 14 7 14" />
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                            </svg>
                            Odśwież wszystkie
                        </button>
                        <label class="checkbox-label" style="font-size: 12px;">
                            <input type="checkbox" id="previewAutoRefresh" onchange="togglePreviewAutoRefresh()">
                            Auto-odświeżanie (10s)
                        </label>
                    </div>
                </div>

                <div class="preview-grid" id="livePreviewGrid">
                    <div class="empty-state" id="previewEmptyState">
                        <div class="empty-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                <circle cx="8.5" cy="8.5" r="1.5" />
                                <polyline points="21 15 16 10 5 21" />
                            </svg>
                        </div>
                        <h3 class="empty-title">Brak aktywnych workerów</h3>
                        <p class="empty-message">Screenshoty pojawią się tutaj po uruchomieniu jobów.</p>
                    </div>
                </div>
            </div>

            <!-- Limits Tab -->
            <div class="tab-panel" id="tab-limits">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Limits Checker</h1>
                        <p class="page-subtitle">Sprawdzanie statusu limitów Pro dla profili</p>
                    </div>
                </div>

                <!-- Limits Status Cards -->
                <div class="stats-grid" style="margin-bottom: var(--spacing-lg);">
                    <div class="stat-card">
                        <div class="stat-icon cyan">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <polyline points="12 6 12 12 16 14" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="limitLastCheck">-</div>
                            <div class="stat-label">Ostatnie sprawdzenie</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="limitSessionRuns">0</div>
                            <div class="stat-label">Sprawdzeń w sesji</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                <polyline points="22 4 12 14.01 9 11.01" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="limitOkCount">0</div>
                            <div class="stat-label">Profile OK</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <line x1="15" y1="9" x2="9" y2="15" />
                                <line x1="9" y1="9" x2="15" y2="15" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="limitExceededCount">0</div>
                            <div class="stat-label">Profile z limitem</div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 350px 1fr; gap: var(--spacing-lg);">
                    <!-- Limit Check Config -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Konfiguracja</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="limitQuickMode" checked>
                                    Quick mode (szybsze sprawdzanie)
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Równoległe sprawdzenia</label>
                                <input type="number" class="form-input" id="limitParallel" value="4" min="1" max="8">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Host</label>
                                <select class="form-select" id="limitHost">
                                    <option value="local">Lokalny</option>
                                    <option value="remote">Zdalny (Limit Worker)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Profile do sprawdzenia</label>
                                <div class="flex gap-sm flex-wrap" style="margin-bottom: var(--spacing-sm);">
                                    <button class="btn btn-secondary btn-sm"
                                        onclick="selectAllLimitProfiles()">Wszystkie</button>
                                    <button class="btn btn-secondary btn-sm"
                                        onclick="selectActiveLimitProfiles()">Aktywne</button>
                                    <button class="btn btn-secondary btn-sm"
                                        onclick="selectPausedLimitProfiles()">Wstrzymane</button>
                                    <button class="btn btn-secondary btn-sm"
                                        onclick="clearLimitProfiles()">Wyczyść</button>
                                </div>
                                <div class="limit-profiles-list" id="limitProfilesList"
                                    style="max-height: 200px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--spacing-sm);">
                                    {% for profile in profiles %}
                                    <label class="checkbox-label" style="margin-bottom: 4px;">
                                        <input type="checkbox" class="limit-profile-cb" value="{{ profile.name }}">
                                        {{ profile.name }}
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="runLimitCheck()" id="limitRunBtn"
                                style="width: 100%;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3" />
                                </svg>
                                Uruchom sprawdzenie
                            </button>
                            <div id="limitProgress" class="hidden" style="margin-top: var(--spacing-md);">
                                <div class="progress" style="margin-bottom: var(--spacing-sm);">
                                    <div class="progress-bar" id="limitProgressBar" style="width: 0%"></div>
                                </div>
                                <p class="text-secondary" style="font-size: 12px;" id="limitProgressText">Sprawdzanie...
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Limit Results Table -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Wyniki sprawdzenia</h3>
                            <span class="text-secondary" style="font-size: 12px;" id="limitResultsTime"></span>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <div class="table-container" style="border: none; border-radius: 0;">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Profil</th>
                                            <th>Status</th>
                                            <th>Pro Remaining</th>
                                            <th>Reset</th>
                                            <th>Sprawdzono</th>
                                        </tr>
                                    </thead>
                                    <tbody id="limitResultsBody">
                                        <tr>
                                            <td colspan="5" class="text-center text-secondary"
                                                style="padding: var(--spacing-lg);">
                                                Brak wyników. Uruchom sprawdzenie limitów.
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Post-Process Tab -->
            <div class="tab-panel" id="tab-postprocess">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Post-Processing</h1>
                        <p class="page-subtitle">Strukturyzacja danych OCR</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 400px 1fr; gap: var(--spacing-lg);">
                    <!-- Post-Process Config -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Konfiguracja</h3>
                            <span class="badge" id="postProcStatusBadge">IDLE</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">OpenRouter API Key</label>
                                <input type="password" class="form-input" id="postProcApiKey" placeholder="sk-or-...">
                            </div>

                            <div class="flex gap-sm" style="margin-bottom: var(--spacing-md);">
                                <button class="btn btn-primary flex-1" onclick="togglePostProcess()"
                                    id="postProcToggleBtn">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polygon points="5 3 19 12 5 21 5 3" />
                                    </svg>
                                    Start
                                </button>
                                <button class="btn btn-secondary" onclick="migratePostProcess()"
                                    title="Utwórz tabele w bazie">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <ellipse cx="12" cy="5" rx="9" ry="3" />
                                        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" />
                                        <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
                                    </svg>
                                    Migrate
                                </button>
                            </div>

                            <!-- Stats -->
                            <div
                                style="background: var(--color-bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md);">
                                <div class="flex justify-between mb-sm">
                                    <span class="text-secondary">Nowych do przetworzenia</span>
                                    <span class="font-bold" id="postProcNew">0</span>
                                </div>
                                <div class="flex justify-between mb-sm">
                                    <span class="text-secondary">Przetworzonych</span>
                                    <span class="font-bold text-success" id="postProcDone">0</span>
                                </div>
                                <div class="progress" style="margin-top: var(--spacing-sm);">
                                    <div class="progress-bar success" id="postProcProgressBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Post-Process Logs -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Log</h3>
                        </div>
                        <div class="card-body">
                            <div class="log-container" id="postProcLogContainer" style="max-height: 400px;">
                                <div class="empty-state">
                                    <p class="empty-message">Logi post-processingu pojawią się tutaj.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Job Config Tab -->
            <div class="tab-panel" id="tab-jobconfig">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Konfiguracja Job OCR</h1>
                        <p class="page-subtitle">Parametry uruchomienia zadań OCR</p>
                    </div>
                </div>

                <!-- Job Config Tabs -->
                <div class="config-tabs" style="margin-bottom: var(--spacing-lg);">
                    <button class="config-tab active" data-config-tab="basic"
                        onclick="switchConfigTab('basic')">Basic</button>
                    <button class="config-tab" data-config-tab="performance"
                        onclick="switchConfigTab('performance')">Performance</button>
                    <button class="config-tab" data-config-tab="database"
                        onclick="switchConfigTab('database')">Database</button>
                    <button class="config-tab" data-config-tab="preprocess"
                        onclick="switchConfigTab('preprocess')">Preprocess</button>
                    <button class="config-tab" data-config-tab="advanced"
                        onclick="switchConfigTab('advanced')">Advanced</button>
                </div>

                <!-- Basic Tab -->
                <div class="config-panel active" id="config-basic">
                    <div class="card">
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Source Path</label>
                                <div class="flex gap-sm">
                                    <input type="text" class="form-input" id="jobSourcePath"
                                        placeholder="/path/to/images">
                                    <button class="btn btn-secondary" onclick="openFileBrowser()">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path
                                                d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Batch ID</label>
                                <input type="text" class="form-input" id="jobBatchId"
                                    placeholder="auto-generated if empty">
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="jobHeadedMode">
                                    Headed Mode (pokazuj przeglądarkę)
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Silnik OCR</label>
                                <select class="form-select" id="jobEngine">
                                    <option value="auto">Auto (domyślnie)</option>
                                    <option value="gemini">Gemini</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Profile do uruchomienia</label>
                                <div class="flex gap-sm flex-wrap" style="margin-bottom: var(--spacing-sm);">
                                    <button class="btn btn-secondary btn-sm"
                                        onclick="selectAllJobProfiles()">Wszystkie</button>
                                    <button class="btn btn-secondary btn-sm" onclick="selectOkLimitJobProfiles()">OK
                                        Limit</button>
                                    <button class="btn btn-secondary btn-sm"
                                        onclick="clearJobProfiles()">Wyczyść</button>
                                    <span
                                        style="border-left: 1px solid var(--color-border); margin: 0 var(--spacing-xs);"></span>
                                    <button class="btn btn-secondary btn-sm"
                                        onclick="sortJobProfiles('asc')">A→Z</button>
                                    <button class="btn btn-secondary btn-sm"
                                        onclick="sortJobProfiles('desc')">Z→A</button>
                                    <span
                                        style="border-left: 1px solid var(--color-border); margin: 0 var(--spacing-xs);"></span>
                                    <button class="btn btn-primary btn-sm" onclick="openAddProfileModal()">+
                                        Dodaj</button>
                                </div>
                                <div class="job-profiles-list" id="jobProfilesList"
                                    style="max-height: 300px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--spacing-sm);">
                                    {% for profile in profiles %}
                                    <label class="checkbox-label" style="margin-bottom: 4px;">
                                        <input type="checkbox" class="job-profile-cb" value="{{ profile.name }}"
                                            checked>
                                        {{ profile.name }}
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Tab -->
                <div class="config-panel" id="config-performance">
                    <div class="card">
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Workers</label>
                                    <input type="number" class="form-input" id="jobWorkers" value="2" min="1" max="10">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Scans per Worker</label>
                                    <input type="number" class="form-input" id="jobScansPerWorker" value="2" min="1"
                                        max="100">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Collect Timeout (sec)</label>
                                <input type="number" class="form-input" id="jobCollectTimeout" value="400" min="60"
                                    max="1200">
                            </div>
                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">Karty
                                przeglądarki</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="jobCloseIdleTabs" checked>
                                        Auto zamykaj nieużywane karty
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Max kart / kontekst (0=bez)</label>
                                    <input type="number" class="form-input" id="jobMaxTabsPerContext" value="0" min="0">
                                </div>
                            </div>
                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">
                                Konteksty</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="jobIsolatedContexts">
                                        Izolowane konteksty (więcej stabilności)
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Pula kontekstów (0=1/worker)</label>
                                    <input type="number" class="form-input" id="jobContextPoolSize" value="0" min="0">
                                </div>
                            </div>
                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">Profil
                                UI</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Viewport Width</label>
                                    <input type="number" class="form-input" id="jobViewportWidth" value="1200">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Viewport Height</label>
                                    <input type="number" class="form-input" id="jobViewportHeight" value="800">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="jobReducedMotion" checked>
                                    Ogranicz animacje (reduced motion)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Database Tab -->
                <div class="config-panel" id="config-database">
                    <div class="card">
                        <div class="card-body">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="jobPgEnabled" checked>
                                    PostgreSQL Enabled
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">PostgreSQL DSN</label>
                                <input type="text" class="form-input" id="jobPgDsn"
                                    value="postgresql://tomaasz:123Karinka!%40%23@127.0.0.1:5432/ocr"
                                    placeholder="postgresql://user:pass@host:5432/db">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Table</label>
                                <input type="text" class="form-input" id="jobPgTable" value="public.ocr_raw_texts">
                            </div>
                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <p class="text-secondary"
                                style="font-size: 11px; margin-bottom: var(--spacing-sm); text-transform: uppercase;">
                                Synchronizacja</p>
                            <button class="btn btn-primary" onclick="syncProfiles()" style="width: 100%;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M21 2v6h-6" />
                                    <path d="M3 12a9 9 0 0 1 15-6.7L21 8" />
                                    <path d="M3 22v-6h6" />
                                    <path d="M21 12a9 9 0 0 1-15 6.7L3 16" />
                                </svg>
                                Synchronizuj profile (Remote)
                            </button>
                            <p class="text-secondary"
                                style="font-size: 11px; margin-top: var(--spacing-xs); text-align: center;">
                                Kopiuje lokalne profile (Gemini) na zdalnego workera
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Preprocess Tab -->
                <div class="config-panel" id="config-preprocess">
                    <div class="card">
                        <div class="card-body">
                            <p class="text-secondary" style="margin-bottom: var(--spacing-md); font-size: 12px;">
                                Parametry przetwarzania obrazu. Domyślne wartości są optymalne dla większości
                                dokumentów.
                            </p>

                            <!-- Skalowanie i szum -->
                            <p class="text-secondary"
                                style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;">
                                Skalowanie
                                i szum</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Max Dimension</label>
                                    <input type="number" class="form-input" id="jobPreprocMaxDim" value="2500">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Median Kernel</label>
                                    <input type="number" class="form-input" id="jobPreprocMedianKernel" value="3">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Denoise Strength</label>
                                    <input type="number" class="form-input" id="jobPreprocDenoise" value="8">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Morph Kernel</label>
                                    <input type="number" class="form-input" id="jobPreprocMorph" value="2">
                                </div>
                            </div>

                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <p class="text-secondary"
                                style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;">
                                Kontrast i
                                kontury</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">CLAHE Clip Limit</label>
                                    <input type="number" class="form-input" id="jobPreprocClahe" value="2.0" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">CLAHE Grid Size</label>
                                    <input type="text" class="form-input" id="jobPreprocClaheGrid" value="8,8"
                                        placeholder="8,8">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Local Contrast Sigma</label>
                                    <input type="number" class="form-input" id="jobPreprocLocalSigma" value="12.0"
                                        step="0.1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Local Contrast Amount</label>
                                    <input type="number" class="form-input" id="jobPreprocLocalAmount" value="0.35"
                                        step="0.05">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Blackhat Kernel</label>
                                    <input type="number" class="form-input" id="jobPreprocBlackhatKernel" value="5">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Blackhat Strength</label>
                                    <input type="number" class="form-input" id="jobPreprocBlackhatStrength" value="0.45"
                                        step="0.05">
                                </div>
                            </div>

                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <p class="text-secondary"
                                style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;">
                                Wyostrzenie</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Unsharp Amount</label>
                                    <input type="number" class="form-input" id="jobPreprocUnsharpAmount" value="1.2"
                                        step="0.1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Unsharp Radius</label>
                                    <input type="number" class="form-input" id="jobPreprocUnsharpRadius" value="1">
                                </div>
                            </div>

                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <p class="text-secondary"
                                style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;">
                                Marginesy
                                i tło</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Margin Percent</label>
                                    <input type="number" class="form-input" id="jobPreprocMarginPercent" value="0.05"
                                        step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Dark Threshold</label>
                                    <input type="number" class="form-input" id="jobPreprocDarkThreshold" value="60">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Margin Ink Ratio Max</label>
                                    <input type="number" class="form-input" id="jobPreprocMarginInkRatio" value="0.01"
                                        step="0.001">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Margin Shadow Mean Max</label>
                                    <input type="number" class="form-input" id="jobPreprocMarginShadow" value="200">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Background Kernel Ratio</label>
                                    <input type="number" class="form-input" id="jobPreprocBgKernelRatio" value="0.025"
                                        step="0.001">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Background Kernel Min</label>
                                    <input type="number" class="form-input" id="jobPreprocBgKernelMin" value="31">
                                </div>
                            </div>

                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <p class="text-secondary"
                                style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;">
                                Binaryzacja (Sauvola)</p>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="jobPreprocBinarization">
                                    Włącz binaryzację adaptacyjną (Sauvola)
                                </label>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Sauvola Window</label>
                                    <input type="number" class="form-input" id="jobPreprocSauvolaW" value="31">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Sauvola K</label>
                                    <input type="number" class="form-input" id="jobPreprocSauvolaK" value="0.2"
                                        step="0.05">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sauvola R</label>
                                <input type="number" class="form-input" id="jobPreprocSauvolaR" value="128.0"
                                    step="0.5">
                            </div>

                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <p class="text-secondary"
                                style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;">
                                Maska
                                tekstu</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Block Size</label>
                                    <input type="number" class="form-input" id="jobPreprocTextMaskBlock" value="31">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">C</label>
                                    <input type="number" class="form-input" id="jobPreprocTextMaskC" value="12">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Open Kernel</label>
                                    <input type="number" class="form-input" id="jobPreprocTextMaskOpenK" value="3">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Close Kernel</label>
                                    <input type="number" class="form-input" id="jobPreprocTextMaskCloseK" value="9">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Close Iters</label>
                                    <input type="number" class="form-input" id="jobPreprocTextMaskCloseI" value="2">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Dilate Iters</label>
                                    <input type="number" class="form-input" id="jobPreprocTextMaskDilateI" value="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Min Area Ratio</label>
                                <input type="number" class="form-input" id="jobPreprocTextMaskMinArea" value="0.0005"
                                    step="0.0001">
                            </div>

                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <p class="text-secondary"
                                style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;">
                                Trim
                                brzegów</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Trim Band Ratio</label>
                                    <input type="number" class="form-input" id="jobPreprocTrimBand" value="0.02"
                                        step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Trim Ink Ratio Max</label>
                                    <input type="number" class="form-input" id="jobPreprocTrimInk" value="0.02"
                                        step="0.01">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Trim Max Ratio</label>
                                    <input type="number" class="form-input" id="jobPreprocTrimMax" value="0.15"
                                        step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Trim Min Dimension</label>
                                    <input type="number" class="form-input" id="jobPreprocTrimMinDim" value="200">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Tab -->
                <div class="config-panel" id="config-advanced">
                    <div class="card">
                        <div class="card-body">
                            <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">Tryb
                                pracy</p>
                            <div class="form-group">
                                <label class="checkbox-label"><input type="checkbox" id="jobContinueMode" checked>
                                    Continue Mode
                                    (wznów od miejsca przerwania)</label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label"><input type="checkbox" id="jobProOnly" checked> Pro Only
                                    (tylko
                                    model Pro)</label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label"><input type="checkbox" id="jobCleanTemp" checked> Clean
                                    Temp
                                    Images</label>
                            </div>

                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">
                                Diagnostyka</p>
                            <div class="form-group">
                                <label class="checkbox-label"><input type="checkbox" id="jobDebugArtifacts"> Debug
                                    Artifacts
                                    (screenshoty błędów)</label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label"><input type="checkbox" id="jobCaptureVideo"> Capture
                                    Video</label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tracing Mode</label>
                                <select class="form-select" id="jobTracingMode">
                                    <option value="off">Wyłączony</option>
                                    <option value="on_failure">Tylko na błąd</option>
                                    <option value="continuous">Ciągły</option>
                                </select>
                            </div>

                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">Sesja
                            </p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="checkbox-label"><input type="checkbox" id="jobAuthEnsure" checked>
                                        Auto-ensure
                                        sesji</label>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Interwał (sek)</label>
                                    <input type="number" class="form-input" id="jobAuthEnsureInterval" value="900"
                                        min="60">
                                </div>
                            </div>

                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">Model
                                Pro</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Retry (ilość)</label>
                                    <input type="number" class="form-input" id="jobModelSwitchRetries" value="3"
                                        min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Cooldown (ms)</label>
                                    <input type="number" class="form-input" id="jobModelSwitchCooldown" value="1200"
                                        min="0">
                                </div>
                            </div>

                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">Limit
                                Pro</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Sprawdzaj co (sek)</label>
                                    <input type="number" class="form-input" id="jobLimitCheckInterval" value="1800"
                                        min="60">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bufor pauzy (sek)</label>
                                    <input type="number" class="form-input" id="jobProPauseBuffer" value="180" min="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fallback pauzy (min)</label>
                                <input type="number" class="form-input" id="jobProFallbackPause" value="60" min="1">
                            </div>

                            <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                            <div class="form-group">
                                <label class="form-label">Browser ID (opcjonalne)</label>
                                <input type="text" class="form-input" id="jobBrowserId" placeholder="np. pw_custom_01">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card" style="margin-top: var(--spacing-lg);">
                    <div class="card-body">
                        <div class="flex gap-md">
                            <button class="btn btn-success flex-1" onclick="startJobFromConfig()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3" />
                                </svg>
                                Uruchom Job
                            </button>
                            <button class="btn btn-secondary" onclick="saveJobConfig()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                                    <polyline points="17 21 17 13 7 13 7 21" />
                                    <polyline points="7 3 7 8 15 8" />
                                </svg>
                                Zapisz konfigurację
                            </button>
                            <button class="btn btn-secondary" onclick="loadJobConfig()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                    <polyline points="7 10 12 15 17 10" />
                                    <line x1="12" y1="15" x2="12" y2="3" />
                                </svg>
                                Wczytaj konfigurację
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-panel" id="tab-settings">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Ustawienia</h1>
                        <p class="page-subtitle">Konfiguracja i zarządzanie farmą</p>
                    </div>
                </div>

                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-lg);">
                    <!-- Auto-Restart -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Auto-Restart</h3>
                        </div>
                        <div class="card-body">
                            <label class="checkbox-label" style="margin-bottom: var(--spacing-md);">
                                <input type="checkbox" id="autoRestartEnabled" onchange="toggleAutoRestart()">
                                Włącz automatyczny restart po zatrzymaniu
                            </label>
                            <p class="text-secondary" style="font-size: 12px;">
                                Gdy włączone, farma automatycznie wznowi pracę po zatrzymaniu z powodu błędu lub limitu.
                            </p>
                        </div>
                    </div>

                    <!-- Cleanup -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Czyszczenie</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="checkbox-label"><input type="checkbox" id="cleanupJobs" checked>
                                    Jobs</label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label"><input type="checkbox" id="cleanupLogs" checked>
                                    Logs</label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label"><input type="checkbox" id="cleanupArtifacts">
                                    Artifacts</label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label"><input type="checkbox" id="cleanupTestResults"> Test
                                    Results</label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label"><input type="checkbox" id="cleanupPycache">
                                    __pycache__</label>
                            </div>
                            <button class="btn btn-danger" onclick="runCleanup()"
                                style="margin-top: var(--spacing-sm);">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="3 6 5 6 21 6" />
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                                </svg>
                                Wyczyść wybrane foldery
                            </button>
                            <p class="text-secondary" style="font-size: 12px; margin-top: var(--spacing-sm);"
                                id="cleanupStatus"></p>
                        </div>
                    </div>

                    <!-- Sync Profiles -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Synchronizacja profili</h3>
                        </div>
                        <div class="card-body">
                            <p class="text-secondary" style="font-size: 13px; margin-bottom: var(--spacing-md);">
                                Synchronizuj profile między maszynami lub utwórz nowy profil.
                            </p>
                            <div class="form-group">
                                <label class="form-label">Nowy profil</label>
                                <div class="flex gap-sm">
                                    <input type="text" class="form-input" id="newProfileName"
                                        placeholder="nazwa_profilu">
                                    <button class="btn btn-primary" onclick="createProfile()">Dodaj</button>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="syncProfiles()" style="width: 100%;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="23 4 23 10 17 10" />
                                    <polyline points="1 20 1 14 7 14" />
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                                </svg>
                                Sync Profiles
                            </button>
                        </div>
                    </div>

                    <!-- System -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">System</h3>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-danger" onclick="restartApp()" style="width: 100%;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M21 2v6h-6" />
                                    <path d="M3 12a9 9 0 0 1 15-6.7L21 8" />
                                    <path d="M3 22v-6h6" />
                                    <path d="M21 12a9 9 0 0 1-15 6.7L3 16" />
                                </svg>
                                Restart Aplikacji
                            </button>
                            <p class="text-secondary" style="font-size: 12px; margin-top: var(--spacing-sm);">
                                Zrestartuje dashboard i limit worker.
                            </p>
                        </div>
                    </div>

                    <!-- X11 Display -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">X11 Display (Logowanie)</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">DISPLAY dla okna logowania</label>
                                <div class="flex gap-sm">
                                    <input type="text" class="form-input" id="x11Display"
                                        placeholder="np. 192.168.1.100:0 lub :0">
                                    <button class="btn btn-primary" onclick="saveX11Display()">Zapisz</button>
                                </div>
                            </div>
                            <p class="text-secondary" style="font-size: 12px; margin-top: var(--spacing-sm);">
                                Adres X serwera (VcXsrv/Xming) dla otwierania okna przeglądarki. Format: IP:0 lub :0 dla
                                lokalnego.
                            </p>
                            <p class="text-secondary" style="font-size: 12px;" id="x11DisplayStatus"></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Session Expired Banner -->
    <div class="session-banner hidden" id="sessionExpiredBanner">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
            <line x1="12" y1="9" x2="12" y2="13" />
            <line x1="12" y1="17" x2="12.01" y2="17" />
        </svg>
        <span>Sesja wygasła dla profili: <strong id="expiredProfilesList"></strong></span>
        <button class="btn btn-sm btn-ghost" onclick="hideSessionBanner()">×</button>
    </div>

    <!-- Bulk Actions Bar -->
    <div class="bulk-actions-bar" id="bulkActionsBar">
        <span class="bulk-count">Zaznaczono: <strong id="selectedCount">0</strong></span>
        <button class="btn btn-success btn-sm" onclick="startSelected()">Start zaznaczonych</button>
        <button class="btn btn-danger btn-sm" onclick="stopSelected()">Stop zaznaczonych</button>
        <button class="btn btn-ghost btn-sm" onclick="clearSelection()">Odznacz</button>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Profile Details Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalProfileName">Szczegóły profilu</h3>
                <button class="btn btn-ghost btn-icon" onclick="closeModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- Profile details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Zamknij</button>
            </div>
        </div>
    </div>

    <!-- Start Job Modal -->
    <div class="modal-overlay" id="startJobModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Uruchom Job OCR</h3>
                <button class="btn btn-ghost btn-icon" onclick="closeStartJobModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Job Config Tabs -->
                <div class="config-tabs">
                    <button class="config-tab active" data-config-tab="basic"
                        onclick="switchConfigTab('basic')">Basic</button>
                    <button class="config-tab" data-config-tab="performance"
                        onclick="switchConfigTab('performance')">Performance</button>
                    <button class="config-tab" data-config-tab="database"
                        onclick="switchConfigTab('database')">Database</button>
                    <button class="config-tab" data-config-tab="preprocess"
                        onclick="switchConfigTab('preprocess')">Preprocess</button>
                    <button class="config-tab" data-config-tab="advanced"
                        onclick="switchConfigTab('advanced')">Advanced</button>
                </div>

                <!-- Basic Tab -->
                <div class="config-panel active" id="config-basic">
                    <div class="form-group">
                        <label class="form-label">Source Path</label>
                        <div class="flex gap-sm">
                            <input type="text" class="form-input" id="jobSourcePath" placeholder="/path/to/images">
                            <button class="btn btn-secondary" onclick="openFileBrowser()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path
                                        d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Batch ID</label>
                        <input type="text" class="form-input" id="jobBatchId" placeholder="auto-generated if empty">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="jobHeadedMode">
                            Headed Mode (pokazuj przeglądarkę)
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Silnik OCR</label>
                        <select class="form-select" id="jobEngine">
                            <option value="auto">Auto (domyślnie)</option>
                            <option value="gemini">Gemini</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Profile do uruchomienia</label>
                        <div class="flex gap-sm flex-wrap" style="margin-bottom: var(--spacing-sm);">
                            <button class="btn btn-secondary btn-sm" onclick="selectAllJobProfiles()">Wszystkie</button>
                            <button class="btn btn-secondary btn-sm" onclick="selectOkLimitJobProfiles()">OK
                                Limit</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearJobProfiles()">Wyczyść</button>
                            <span
                                style="border-left: 1px solid var(--color-border); margin: 0 var(--spacing-xs);"></span>
                            <button class="btn btn-secondary btn-sm" onclick="sortJobProfiles('asc')">A→Z</button>
                            <button class="btn btn-secondary btn-sm" onclick="sortJobProfiles('desc')">Z→A</button>
                            <span
                                style="border-left: 1px solid var(--color-border); margin: 0 var(--spacing-xs);"></span>
                            <button class="btn btn-primary btn-sm" onclick="openAddProfileModal()">+ Dodaj</button>
                        </div>
                        <div class="job-profiles-list" id="jobProfilesList"
                            style="max-height: 150px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--spacing-sm);">
                            {% for profile in profiles %}
                            <label class="checkbox-label" style="margin-bottom: 4px;">
                                <input type="checkbox" class="job-profile-cb" value="{{ profile.name }}" checked>
                                {{ profile.name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Performance Tab -->
                <div class="config-panel" id="config-performance">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Workers</label>
                            <input type="number" class="form-input" id="jobWorkers" value="2" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Scans per Worker</label>
                            <input type="number" class="form-input" id="jobScansPerWorker" value="2" min="1" max="100">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Collect Timeout (sec)</label>
                        <input type="number" class="form-input" id="jobCollectTimeout" value="400" min="60" max="1200">
                    </div>
                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">Karty
                        przeglądarki</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="jobCloseIdleTabs" checked>
                                Auto zamykaj nieużywane karty
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Max kart / kontekst (0=bez)</label>
                            <input type="number" class="form-input" id="jobMaxTabsPerContext" value="0" min="0">
                        </div>
                    </div>
                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">Konteksty</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="jobIsolatedContexts">
                                Izolowane konteksty (więcej stabilności)
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pula kontekstów (0=1/worker)</label>
                            <input type="number" class="form-input" id="jobContextPoolSize" value="0" min="0">
                        </div>
                    </div>
                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">Profil UI</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Viewport Width</label>
                            <input type="number" class="form-input" id="jobViewportWidth" value="1200">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Viewport Height</label>
                            <input type="number" class="form-input" id="jobViewportHeight" value="800">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="jobReducedMotion" checked>
                            Ogranicz animacje (reduced motion)
                        </label>
                    </div>
                </div>

                <!-- Database Tab -->
                <div class="config-panel" id="config-database">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="jobPgEnabled" checked>
                            PostgreSQL Enabled
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">PostgreSQL DSN</label>
                        <input type="text" class="form-input" id="jobPgDsn"
                            value="postgresql://tomaasz:123Karinka!%40%23@127.0.0.1:5432/ocr"
                            placeholder="postgresql://user:pass@host:5432/db">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Table</label>
                        <input type="text" class="form-input" id="jobPgTable" value="public.ocr_raw_texts">
                    </div>
                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary"
                        style="font-size: 11px; margin-bottom: var(--spacing-sm); text-transform: uppercase;">
                        Synchronizacja</p>
                    <button class="btn btn-primary" onclick="syncProfiles()" style="width: 100%;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 2v6h-6" />
                            <path d="M3 12a9 9 0 0 1 15-6.7L21 8" />
                            <path d="M3 22v-6h6" />
                            <path d="M21 12a9 9 0 0 1-15 6.7L3 16" />
                        </svg>
                        Synchronizuj profile (Remote)
                    </button>
                    <p class="text-secondary"
                        style="font-size: 11px; margin-top: var(--spacing-xs); text-align: center;">
                        Kopiuje lokalne profile (Gemini) na zdalnego workera
                    </p>
                </div>

                <!-- Preprocess Tab -->
                <div class="config-panel" id="config-preprocess">
                    <p class="text-secondary" style="margin-bottom: var(--spacing-md); font-size: 12px;">
                        Parametry przetwarzania obrazu. Domyślne wartości są optymalne dla większości dokumentów.
                    </p>

                    <!-- Skalowanie i szum -->
                    <p class="text-secondary"
                        style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;">Skalowanie
                        i szum</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Max Dimension</label>
                            <input type="number" class="form-input" id="jobPreprocMaxDim" value="2500">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Median Kernel</label>
                            <input type="number" class="form-input" id="jobPreprocMedianKernel" value="3">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Denoise Strength</label>
                            <input type="number" class="form-input" id="jobPreprocDenoise" value="8">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Morph Kernel</label>
                            <input type="number" class="form-input" id="jobPreprocMorph" value="2">
                        </div>
                    </div>

                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary"
                        style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;">Kontrast i
                        kontury</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">CLAHE Clip Limit</label>
                            <input type="number" class="form-input" id="jobPreprocClahe" value="2.0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CLAHE Grid Size</label>
                            <input type="text" class="form-input" id="jobPreprocClaheGrid" value="8,8"
                                placeholder="8,8">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Local Contrast Sigma</label>
                            <input type="number" class="form-input" id="jobPreprocLocalSigma" value="12.0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Local Contrast Amount</label>
                            <input type="number" class="form-input" id="jobPreprocLocalAmount" value="0.35" step="0.05">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Blackhat Kernel</label>
                            <input type="number" class="form-input" id="jobPreprocBlackhatKernel" value="5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Blackhat Strength</label>
                            <input type="number" class="form-input" id="jobPreprocBlackhatStrength" value="0.45"
                                step="0.05">
                        </div>
                    </div>

                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary"
                        style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;">
                        Wyostrzenie</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Unsharp Amount</label>
                            <input type="number" class="form-input" id="jobPreprocUnsharpAmount" value="1.2" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Unsharp Radius</label>
                            <input type="number" class="form-input" id="jobPreprocUnsharpRadius" value="1">
                        </div>
                    </div>

                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary"
                        style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;">Marginesy
                        i tło</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Margin Percent</label>
                            <input type="number" class="form-input" id="jobPreprocMarginPercent" value="0.05"
                                step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dark Threshold</label>
                            <input type="number" class="form-input" id="jobPreprocDarkThreshold" value="60">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Margin Ink Ratio Max</label>
                            <input type="number" class="form-input" id="jobPreprocMarginInkRatio" value="0.01"
                                step="0.001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Margin Shadow Mean Max</label>
                            <input type="number" class="form-input" id="jobPreprocMarginShadow" value="200">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Background Kernel Ratio</label>
                            <input type="number" class="form-input" id="jobPreprocBgKernelRatio" value="0.025"
                                step="0.001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Background Kernel Min</label>
                            <input type="number" class="form-input" id="jobPreprocBgKernelMin" value="31">
                        </div>
                    </div>

                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary"
                        style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;">
                        Binaryzacja (Sauvola)</p>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="jobPreprocBinarization">
                            Włącz binaryzację adaptacyjną (Sauvola)
                        </label>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Sauvola Window</label>
                            <input type="number" class="form-input" id="jobPreprocSauvolaW" value="31">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sauvola K</label>
                            <input type="number" class="form-input" id="jobPreprocSauvolaK" value="0.2" step="0.05">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sauvola R</label>
                        <input type="number" class="form-input" id="jobPreprocSauvolaR" value="128.0" step="0.5">
                    </div>

                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary"
                        style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;">Maska
                        tekstu</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Block Size</label>
                            <input type="number" class="form-input" id="jobPreprocTextMaskBlock" value="31">
                        </div>
                        <div class="form-group">
                            <label class="form-label">C</label>
                            <input type="number" class="form-input" id="jobPreprocTextMaskC" value="12">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Open Kernel</label>
                            <input type="number" class="form-input" id="jobPreprocTextMaskOpenK" value="3">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Close Kernel</label>
                            <input type="number" class="form-input" id="jobPreprocTextMaskCloseK" value="9">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Close Iters</label>
                            <input type="number" class="form-input" id="jobPreprocTextMaskCloseI" value="2">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dilate Iters</label>
                            <input type="number" class="form-input" id="jobPreprocTextMaskDilateI" value="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Min Area Ratio</label>
                        <input type="number" class="form-input" id="jobPreprocTextMaskMinArea" value="0.0005"
                            step="0.0001">
                    </div>

                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary"
                        style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;">Trim
                        brzegów</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Trim Band Ratio</label>
                            <input type="number" class="form-input" id="jobPreprocTrimBand" value="0.02" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Trim Ink Ratio Max</label>
                            <input type="number" class="form-input" id="jobPreprocTrimInk" value="0.02" step="0.01">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Trim Max Ratio</label>
                            <input type="number" class="form-input" id="jobPreprocTrimMax" value="0.15" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Trim Min Dimension</label>
                            <input type="number" class="form-input" id="jobPreprocTrimMinDim" value="200">
                        </div>
                    </div>
                </div>

                <!-- Advanced Tab -->
                <div class="config-panel" id="config-advanced">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">Tryb pracy</p>
                    <div class="form-group">
                        <label class="checkbox-label"><input type="checkbox" id="jobContinueMode" checked> Continue Mode
                            (wznów od miejsca przerwania)</label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label"><input type="checkbox" id="jobProOnly" checked> Pro Only (tylko
                            model Pro)</label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label"><input type="checkbox" id="jobCleanTemp" checked> Clean Temp
                            Images</label>
                    </div>

                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">Diagnostyka</p>
                    <div class="form-group">
                        <label class="checkbox-label"><input type="checkbox" id="jobDebugArtifacts"> Debug Artifacts
                            (screenshoty błędów)</label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label"><input type="checkbox" id="jobCaptureVideo"> Capture Video</label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tracing Mode</label>
                        <select class="form-select" id="jobTracingMode">
                            <option value="off">Wyłączony</option>
                            <option value="on_failure">Tylko na błąd</option>
                            <option value="continuous">Ciągły</option>
                        </select>
                    </div>

                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">Sesja</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="checkbox-label"><input type="checkbox" id="jobAuthEnsure" checked> Auto-ensure
                                sesji</label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Interwał (sek)</label>
                            <input type="number" class="form-input" id="jobAuthEnsureInterval" value="900" min="60">
                        </div>
                    </div>

                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">Model Pro</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Retry (ilość)</label>
                            <input type="number" class="form-input" id="jobModelSwitchRetries" value="3" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cooldown (ms)</label>
                            <input type="number" class="form-input" id="jobModelSwitchCooldown" value="1200" min="0">
                        </div>
                    </div>

                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);">Limit Pro</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Sprawdzaj co (sek)</label>
                            <input type="number" class="form-input" id="jobLimitCheckInterval" value="1800" min="60">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bufor pauzy (sek)</label>
                            <input type="number" class="form-input" id="jobProPauseBuffer" value="180" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fallback pauzy (min)</label>
                        <input type="number" class="form-input" id="jobProFallbackPause" value="60" min="1">
                    </div>

                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <div class="form-group">
                        <label class="form-label">Browser ID (opcjonalne)</label>
                        <input type="text" class="form-input" id="jobBrowserId" placeholder="np. pw_custom_01">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStartJobModal()">Anuluj</button>
                <button class="btn btn-success" onclick="startJob()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3" />
                    </svg>
                    Uruchom Job
                </button>
            </div>
        </div>
    </div>

    <!-- File Browser Modal -->
    <div class="modal-overlay" id="fileBrowserModal">
        <div class="modal" style="max-width: 800px; height: 80vh;">
            <div class="modal-header">
                <h3 class="modal-title">Wybierz folder</h3>
                <button class="btn btn-ghost btn-icon" onclick="closeFileBrowser()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body"
                style="display: flex; gap: var(--spacing-md); height: calc(100% - 130px); padding: 0;">
                <!-- Favorites Sidebar -->
                <div class="file-browser-favorites"
                    style="width: 200px; border-right: 1px solid var(--color-border); padding: var(--spacing-md); overflow-y: auto;">
                    <div class="flex justify-between items-center mb-sm">
                        <span class="font-medium" style="font-size: 12px;">Ulubione</span>
                        <button class="btn btn-ghost btn-sm" onclick="addToFavorites()"
                            title="Dodaj aktualny folder">+</button>
                    </div>
                    <div id="favoritesList">
                        <!-- Favorites will be loaded here -->
                    </div>
                </div>
                <!-- File List -->
                <div style="flex: 1; display: flex; flex-direction: column; padding: var(--spacing-md);">
                    <div class="flex gap-sm mb-md">
                        <button class="btn btn-secondary btn-sm" onclick="browserGoUp()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M17 11l-5-5-5 5M12 6v12" />
                            </svg>
                            W górę
                        </button>
                        <input type="text" class="form-input" id="browserCurrentPath" readonly style="flex: 1;">
                    </div>
                    <div class="file-list" id="fileList"
                        style="flex: 1; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                        <!-- Files will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeFileBrowser()">Anuluj</button>
                <button class="btn btn-primary" onclick="selectFolder()">Wybierz ten folder</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Usuń profil</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Czy na pewno chcesz usunąć profil <strong id="deleteProfileName"></strong>?</p>
                <p class="text-danger">Ta operacja jest nieodwracalna. Usunięte zostaną:</p>
                <ul class="text-secondary" style="margin-left: 20px;">
                    <li>Katalog profilu</li>
                    <li>Pliki konfiguracyjne</li>
                    <li>Historia lokalna</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Anuluj</button>
                <button class="btn btn-danger" onclick="confirmDeleteProfile()">Usuń</button>
            </div>
        </div>
    </div>

    <!-- Login Logs Modal -->
    <div class="modal-overlay" id="loginLogModal">
        <div class="modal" style="max-width: 800px; width: 90%;">
            <div class="modal-header">
                <h3>Logowanie: <span id="loginLogProfileName"></span></h3>
                <button class="modal-close" onclick="closeLoginLogModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-banner" style="margin-bottom: 10px;">
                    <i class="fas fa-info-circle"></i> To okno pokazuje logi z procesu logowania HEADED.
                    Jeśli widzisz błąd "Brak serwera X / DISPLAY", upewnij się, że masz uruchomiony X Server (np.
                    Xming/VcXsrv) i skonfigurowany DISPLAY w Ustawieniach.
                </div>
                <div class="log-viewer" id="loginLogContent"
                    style="height: 400px; background: #0f172a; color: #e2e8f0; padding: 15px; overflow: auto; font-family: 'JetBrains Mono', monospace; font-size: 13px; border-radius: 6px; border: 1px solid var(--border-color);">
                    Inicjalizacja procesu logowania...
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLoginLogModal()">Zamknij</button>
            </div>
        </div>
    </div>

    <!-- Cleanup Modal -->
    <div class="modal-overlay" id="cleanupModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">Wyczyść foldery</h3>
                <button class="modal-close" onclick="closeCleanupModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="text-secondary" style="font-size: 13px; margin-bottom: var(--spacing-md);">Wybierz foldery do
                    wyczyszczenia:</p>
                <div class="cleanup-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="cleanupJobs" checked>
                        <span>jobs/</span>
                        <span class="text-secondary" style="font-size: 11px; margin-left: auto;">Dane jobów</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="cleanupLogs" checked>
                        <span>logs/</span>
                        <span class="text-secondary" style="font-size: 11px; margin-left: auto;">Logi</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="cleanupArtifacts" checked>
                        <span>artifacts/</span>
                        <span class="text-secondary" style="font-size: 11px; margin-left: auto;">Screenshoty
                            debug</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="cleanupTestResults">
                        <span>test-results/</span>
                        <span class="text-secondary" style="font-size: 11px; margin-left: auto;">Wyniki testów</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="cleanupPycache">
                        <span>__pycache__/</span>
                        <span class="text-secondary" style="font-size: 11px; margin-left: auto;">Cache Pythona</span>
                    </label>
                </div>
                <div
                    style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-border);">
                    <label class="checkbox-label">
                        <input type="checkbox" id="cleanupForce">
                        <span>Force</span>
                        <span class="text-secondary" style="font-size: 11px; margin-left: auto;">Wymuś nawet gdy joby
                            działają</span>
                    </label>
                </div>
                <div id="cleanupStatus" class="text-secondary" style="font-size: 12px; margin-top: var(--spacing-sm);">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCleanupModal()">Anuluj</button>
                <button class="btn btn-danger" onclick="executeCleanup()" id="cleanupExecuteBtn">Wyczyść</button>
            </div>
        </div>
    </div>

    <!-- Restart Confirmation Modal -->
    <div class="modal-overlay" id="restartModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Zrestartuj aplikację</h3>
                <button class="modal-close" onclick="closeRestartModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Czy na pewno chcesz zrestartować aplikację?</p>
                <p class="text-secondary" style="font-size: 12px; margin-top: var(--spacing-sm);">Wszystkie aktywne joby
                    zostaną zatrzymane. Strona zostanie automatycznie odświeżona po restarcie.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRestartModal()">Anuluj</button>
                <button class="btn btn-warning" onclick="confirmRestartApp()">Restartuj</button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div class="modal-overlay" id="imagePreviewModal" onclick="closeImagePreview()"
        style="background: rgba(0,0,0,0.9);">
        <div class="image-preview-container" onclick="event.stopPropagation();">
            <button class="image-preview-close" onclick="closeImagePreview()">&times;</button>
            <img id="imagePreviewImg" src="" alt="Preview">
            <div class="image-preview-info" id="imagePreviewInfo"></div>
        </div>
    </div>

    <!-- Non-Pro Banner (sticky warning) -->
    <div id="nonProBanner" class="alert-banner warning hidden">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
            <line x1="12" y1="9" x2="12" y2="13" />
            <line x1="12" y1="17" x2="12.01" y2="17" />
        </svg>
        <span>Odrzucone wyniki nie-Pro w sesji: <strong id="nonProCount">0</strong></span>
        <span class="text-secondary" style="margin-left: var(--spacing-sm);">Profil(e): <span
                id="nonProProfiles">-</span></span>
        <button class="btn btn-ghost btn-sm" onclick="hideNonProBanner()">×</button>
    </div>

    <!-- Add Profile Modal -->
    <div class="modal-overlay" id="addProfileModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Dodaj nowy profil</h3>
                <button class="modal-close" onclick="closeAddProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nazwa profilu</label>
                    <input type="text" class="form-input" id="newProfileName" placeholder="np. user123">
                    <p class="text-secondary" style="font-size: 11px; margin-top: var(--spacing-xs);">Nazwa będzie użyta
                        jako suffix: gemini-profile-[nazwa]</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddProfileModal()">Anuluj</button>
                <button class="btn btn-primary" onclick="confirmAddProfile()">Dodaj profil</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Internationalization (i18n)
        // ============================================

        const translations = {
            pl: {
                // Sidebar
                'nav.menu': 'Menu',
                'nav.overview': 'Przegląd',
                'nav.profiles': 'Profile',
                'nav.activity': 'Aktywność',
                'nav.preview': 'Podgląd',
                'nav.logs': 'Logi',
                'nav.limits': 'Limity',
                'nav.postprocess': 'Post-Process',
                'nav.settings': 'Ustawienia',
                'nav.quickStatus': 'Szybki status',
                'nav.active': 'Aktywne',
                'nav.paused': 'Wstrzymane',
                'nav.limit': 'Limit',
                'nav.todayScans': 'Dzisiejsze skany',
                'nav.collapse': 'Zwiń',

                // Header
                'header.active': 'Aktywnych',
                'header.paused': 'Wstrzymanych',
                'header.limit': 'Limit',
                'header.today': 'Dzisiaj',
                'header.proEst': 'Pro Est.',
                'header.batch': 'Batch',
                'header.startJob': 'Start Job',
                'header.stopAll': 'Stop All',
                'header.restart': 'Restart',
                'header.cleanup': 'Cleanup',

                // Overview
                'overview.title': 'Przegląd',
                'overview.subtitle': 'Podsumowanie stanu farmy OCR',
                'overview.lastUpdate': 'Ostatnia aktualizacja',
                'overview.totalProfiles': 'Wszystkich profili',
                'overview.activeWorkers': 'Aktywnych workerów',
                'overview.processedToday': 'Przetworzonych dziś',
                'overview.errorRate': 'Błędów',
                'overview.recentActivity': 'Ostatnia aktywność',
                'overview.noActivity': 'Brak aktywności',
                'overview.activityWillAppear': 'Aktywność pojawi się tutaj po rozpoczęciu przetwarzania.',

                // Profiles
                'profiles.title': 'Profile',
                'profiles.subtitle': 'Zarządzanie profilami Gemini',
                'profiles.search': 'Szukaj profilu...',
                'profiles.all': 'Wszystkie',
                'profiles.active': 'Aktywne',
                'profiles.idle': 'Bezczynne',
                'profiles.error': 'Błąd',
                'profiles.select': 'Zaznacz',
                'profiles.cancel': 'Anuluj',
                'profiles.processed': 'Przetw.',
                'profiles.tokens': 'Tokeny',
                'profiles.errors': 'Błędy',
                'profiles.mode': 'Tryb',
                'profiles.lastActivity': 'Ostatnia aktywność',
                'profiles.actions': 'Akcje',
                'profiles.start': 'Start',
                'profiles.stop': 'Stop',
                'profiles.login': 'Login',
                'profiles.info': 'Info',
                'profiles.delete': 'Usuń',

                // Activity
                'activity.title': 'Aktywność',
                'activity.subtitle': 'Historia ostatnich operacji',
                'activity.noActivity': 'Brak aktywności',
                'activity.willAppear': 'Historia operacji pojawi się tutaj.',

                // Live Preview
                'preview.title': 'Podgląd na żywo',
                'preview.subtitle': 'Podgląd na żywo aktywnych workerów',
                'preview.refreshAll': 'Odśwież wszystkie',
                'preview.autoRefresh': 'Auto-odświeżanie (10s)',
                'preview.noWorkers': 'Brak aktywnych workerów',
                'preview.screenshotsWillAppear': 'Screenshoty pojawią się tutaj po uruchomieniu jobów.',

                // Logs
                'logs.title': 'Logi',
                'logs.subtitle': 'Logi systemowe i błędy',
                'logs.noLogs': 'Brak logów',
                'logs.willAppear': 'Logi pojawią się tutaj po rozpoczęciu przetwarzania.',

                // Limits
                'limits.title': 'Limits Checker',
                'limits.subtitle': 'Sprawdzanie statusu limitów Pro dla profili',
                'limits.lastCheck': 'Ostatni check',
                'limits.okProfiles': 'Profile OK',
                'limits.limitedProfiles': 'Z limitem',
                'limits.sessionRuns': 'Checki w sesji',
                'limits.selectProfiles': 'Wybierz profile do sprawdzenia',
                'limits.selectAll': 'Wszystkie',
                'limits.selectNone': 'Żadne',
                'limits.quickMode': 'Quick Mode',
                'limits.parallel': 'Równolegle',
                'limits.host': 'Host',
                'limits.runCheck': 'Sprawdź limity',
                'limits.results': 'Wyniki',
                'limits.profile': 'Profil',
                'limits.status': 'Status',
                'limits.proRemaining': 'Pro pozostało',
                'limits.resetTime': 'Reset',
                'limits.checkedAt': 'Sprawdzono',
                'limits.noResults': 'Brak wyników',
                'limits.runCheckFirst': 'Uruchom sprawdzanie aby zobaczyć wyniki.',

                // Post-Process
                'postprocess.title': 'Post-Processing',
                'postprocess.subtitle': 'Strukturyzacja danych OCR',
                'postprocess.status': 'Status',
                'postprocess.startProcessing': 'Start Processing',
                'postprocess.stopProcessing': 'Stop Processing',
                'postprocess.apiKey': 'API Key (OpenRouter)',
                'postprocess.apiKeyHint': 'Opcjonalne. Zostaw puste aby używać przeglądarki (darmowe).',
                'postprocess.stats': 'Statystyki',
                'postprocess.newToProcess': 'Nowe do przetworzenia',
                'postprocess.processed': 'Przetworzone',
                'postprocess.tools': 'Narzędzia',
                'postprocess.createTables': 'Utwórz tabele (normalizacja DB)',
                'postprocess.createTablesHint': 'Tworzy tabele documents i entries zamiast kolumn JSON.',

                // Settings
                'settings.title': 'Ustawienia',
                'settings.subtitle': 'Konfiguracja systemu',
                'settings.general': 'Ogólne',
                'settings.autoRestart': 'Auto-restart workerów po błędzie',
                'settings.display': 'Wyświetlanie',
                'settings.x11Display': 'X11 DISPLAY',
                'settings.maintenance': 'Konserwacja',
                'settings.cleanupFolders': 'Wyczyść foldery tymczasowe',
                'settings.syncProfiles': 'Synchronizuj profile z remote',
                'settings.language': 'Język',

                // Start Job Modal
                'startJob.title': 'Uruchom Job OCR',
                'startJob.basic': 'Podstawowe',
                'startJob.performance': 'Wydajność',
                'startJob.database': 'Baza danych',
                'startJob.preprocess': 'Preprocess',
                'startJob.advanced': 'Zaawansowane',
                'startJob.sourcePath': 'Folder źródłowy',
                'startJob.batchId': 'Batch ID',
                'startJob.headedMode': 'Tryb okienkowy (pokazuj przeglądarkę)',
                'startJob.engine': 'Silnik OCR',
                'startJob.profilesToRun': 'Profile do uruchomienia',
                'startJob.all': 'Wszystkie',
                'startJob.okLimit': 'OK Limit',
                'startJob.clear': 'Wyczyść',
                'startJob.addProfile': 'Dodaj',
                'startJob.cancel': 'Anuluj',
                'startJob.run': 'Uruchom Job',

                // Cleanup Modal
                'cleanup.title': 'Wyczyść foldery',
                'cleanup.selectFolders': 'Wybierz foldery do wyczyszczenia:',
                'cleanup.jobs': 'Dane jobów',
                'cleanup.logs': 'Logi',
                'cleanup.artifacts': 'Screenshoty debug',
                'cleanup.testResults': 'Wyniki testów',
                'cleanup.pycache': 'Cache Pythona',
                'cleanup.force': 'Wymuś nawet gdy joby działają',
                'cleanup.cancel': 'Anuluj',
                'cleanup.clean': 'Wyczyść',

                // Restart Modal
                'restart.title': 'Zrestartuj aplikację',
                'restart.confirm': 'Czy na pewno chcesz zrestartować aplikację?',
                'restart.warning': 'Wszystkie aktywne joby zostaną zatrzymane. Strona zostanie automatycznie odświeżona po restarcie.',
                'restart.cancel': 'Anuluj',
                'restart.restart': 'Restartuj',

                // Delete Modal
                'delete.title': 'Potwierdź usunięcie',
                'delete.confirm': 'Czy na pewno chcesz usunąć profil',
                'delete.warning': 'Ta operacja jest nieodwracalna.',
                'delete.cancel': 'Anuluj',
                'delete.delete': 'Usuń',

                // Add Profile Modal
                'addProfile.title': 'Dodaj nowy profil',
                'addProfile.name': 'Nazwa profilu',
                'addProfile.hint': 'Nazwa będzie użyta jako suffix: gemini-profile-[nazwa]',
                'addProfile.cancel': 'Anuluj',
                'addProfile.add': 'Dodaj profil',

                // File Browser
                'fileBrowser.title': 'Wybierz folder',
                'fileBrowser.favorites': 'Ulubione',
                'fileBrowser.up': 'W górę',
                'fileBrowser.cancel': 'Anuluj',
                'fileBrowser.select': 'Wybierz',

                // Common
                'common.loading': 'Ładowanie...',
                'common.error': 'Błąd',
                'common.success': 'Sukces',
                'common.save': 'Zapisz',
                'common.cancel': 'Anuluj',
                'common.close': 'Zamknij',
                'common.refresh': 'Odśwież',
                'common.actions': 'Akcje',
            },

            en: {
                // Sidebar
                'nav.menu': 'Menu',
                'nav.overview': 'Overview',
                'nav.profiles': 'Profiles',
                'nav.activity': 'Activity',
                'nav.preview': 'Preview',
                'nav.logs': 'Logs',
                'nav.limits': 'Limits',
                'nav.postprocess': 'Post-Process',
                'nav.settings': 'Settings',
                'nav.quickStatus': 'Quick Status',
                'nav.active': 'Active',
                'nav.paused': 'Paused',
                'nav.limit': 'Limit',
                'nav.todayScans': 'Today\'s scans',
                'nav.collapse': 'Collapse',

                // Header
                'header.active': 'Active',
                'header.paused': 'Paused',
                'header.limit': 'Limit',
                'header.today': 'Today',
                'header.proEst': 'Pro Est.',
                'header.batch': 'Batch',
                'header.startJob': 'Start Job',
                'header.stopAll': 'Stop All',
                'header.restart': 'Restart',
                'header.cleanup': 'Cleanup',

                // Overview
                'overview.title': 'Overview',
                'overview.subtitle': 'OCR Farm status summary',
                'overview.lastUpdate': 'Last update',
                'overview.totalProfiles': 'Total profiles',
                'overview.activeWorkers': 'Active workers',
                'overview.processedToday': 'Processed today',
                'overview.errorRate': 'Errors',
                'overview.recentActivity': 'Recent Activity',
                'overview.noActivity': 'No activity',
                'overview.activityWillAppear': 'Activity will appear here once processing starts.',

                // Profiles
                'profiles.title': 'Profiles',
                'profiles.subtitle': 'Gemini profile management',
                'profiles.search': 'Search profile...',
                'profiles.all': 'All',
                'profiles.active': 'Active',
                'profiles.idle': 'Idle',
                'profiles.error': 'Error',
                'profiles.select': 'Select',
                'profiles.cancel': 'Cancel',
                'profiles.processed': 'Proc.',
                'profiles.tokens': 'Tokens',
                'profiles.errors': 'Errors',
                'profiles.mode': 'Mode',
                'profiles.lastActivity': 'Last Activity',
                'profiles.actions': 'Actions',
                'profiles.start': 'Start',
                'profiles.stop': 'Stop',
                'profiles.login': 'Login',
                'profiles.info': 'Info',
                'profiles.delete': 'Del',

                // Activity
                'activity.title': 'Activity',
                'activity.subtitle': 'Recent operations history',
                'activity.noActivity': 'No activity',
                'activity.willAppear': 'Operations history will appear here.',

                // Live Preview
                'preview.title': 'Live Preview',
                'preview.subtitle': 'Live preview of active workers',
                'preview.refreshAll': 'Refresh all',
                'preview.autoRefresh': 'Auto-refresh (10s)',
                'preview.noWorkers': 'No active workers',
                'preview.screenshotsWillAppear': 'Screenshots will appear here when jobs are running.',

                // Logs
                'logs.title': 'Logs',
                'logs.subtitle': 'System logs and errors',
                'logs.noLogs': 'No logs',
                'logs.willAppear': 'Logs will appear here once processing starts.',

                // Limits
                'limits.title': 'Limits Checker',
                'limits.subtitle': 'Check Pro limits status for profiles',
                'limits.lastCheck': 'Last check',
                'limits.okProfiles': 'OK Profiles',
                'limits.limitedProfiles': 'Limited',
                'limits.sessionRuns': 'Session checks',
                'limits.selectProfiles': 'Select profiles to check',
                'limits.selectAll': 'All',
                'limits.selectNone': 'None',
                'limits.quickMode': 'Quick Mode',
                'limits.parallel': 'Parallel',
                'limits.host': 'Host',
                'limits.runCheck': 'Check limits',
                'limits.results': 'Results',
                'limits.profile': 'Profile',
                'limits.status': 'Status',
                'limits.proRemaining': 'Pro remaining',
                'limits.resetTime': 'Reset',
                'limits.checkedAt': 'Checked at',
                'limits.noResults': 'No results',
                'limits.runCheckFirst': 'Run a check to see results.',

                // Post-Process
                'postprocess.title': 'Post-Processing',
                'postprocess.subtitle': 'OCR data structuring',
                'postprocess.status': 'Status',
                'postprocess.startProcessing': 'Start Processing',
                'postprocess.stopProcessing': 'Stop Processing',
                'postprocess.apiKey': 'API Key (OpenRouter)',
                'postprocess.apiKeyHint': 'Optional. Leave empty to use browser (free).',
                'postprocess.stats': 'Statistics',
                'postprocess.newToProcess': 'New to process',
                'postprocess.processed': 'Processed',
                'postprocess.tools': 'Tools',
                'postprocess.createTables': 'Create tables (DB normalization)',
                'postprocess.createTablesHint': 'Creates documents and entries tables instead of JSON columns.',

                // Settings
                'settings.title': 'Settings',
                'settings.subtitle': 'System configuration',
                'settings.general': 'General',
                'settings.autoRestart': 'Auto-restart workers on error',
                'settings.display': 'Display',
                'settings.x11Display': 'X11 DISPLAY',
                'settings.maintenance': 'Maintenance',
                'settings.cleanupFolders': 'Clean temporary folders',
                'settings.syncProfiles': 'Sync profiles with remote',
                'settings.language': 'Language',

                // Start Job Modal
                'startJob.title': 'Start OCR Job',
                'startJob.basic': 'Basic',
                'startJob.performance': 'Performance',
                'startJob.database': 'Database',
                'startJob.preprocess': 'Preprocess',
                'startJob.advanced': 'Advanced',
                'startJob.sourcePath': 'Source folder',
                'startJob.batchId': 'Batch ID',
                'startJob.headedMode': 'Headed mode (show browser)',
                'startJob.engine': 'OCR Engine',
                'startJob.profilesToRun': 'Profiles to run',
                'startJob.all': 'All',
                'startJob.okLimit': 'OK Limit',
                'startJob.clear': 'Clear',
                'startJob.addProfile': 'Add',
                'startJob.cancel': 'Cancel',
                'startJob.run': 'Run Job',

                // Cleanup Modal
                'cleanup.title': 'Clean folders',
                'cleanup.selectFolders': 'Select folders to clean:',
                'cleanup.jobs': 'Job data',
                'cleanup.logs': 'Logs',
                'cleanup.artifacts': 'Debug screenshots',
                'cleanup.testResults': 'Test results',
                'cleanup.pycache': 'Python cache',
                'cleanup.force': 'Force even when jobs are running',
                'cleanup.cancel': 'Cancel',
                'cleanup.clean': 'Clean',

                // Restart Modal
                'restart.title': 'Restart application',
                'restart.confirm': 'Are you sure you want to restart the application?',
                'restart.warning': 'All active jobs will be stopped. The page will automatically refresh after restart.',
                'restart.cancel': 'Cancel',
                'restart.restart': 'Restart',

                // Delete Modal
                'delete.title': 'Confirm deletion',
                'delete.confirm': 'Are you sure you want to delete profile',
                'delete.warning': 'This operation is irreversible.',
                'delete.cancel': 'Cancel',
                'delete.delete': 'Delete',

                // Add Profile Modal
                'addProfile.title': 'Add new profile',
                'addProfile.name': 'Profile name',
                'addProfile.hint': 'Name will be used as suffix: gemini-profile-[name]',
                'addProfile.cancel': 'Cancel',
                'addProfile.add': 'Add profile',

                // File Browser
                'fileBrowser.title': 'Select folder',
                'fileBrowser.favorites': 'Favorites',
                'fileBrowser.up': 'Up',
                'fileBrowser.cancel': 'Cancel',
                'fileBrowser.select': 'Select',

                // Common
                'common.loading': 'Loading...',
                'common.error': 'Error',
                'common.success': 'Success',
                'common.save': 'Save',
                'common.cancel': 'Cancel',
                'common.close': 'Close',
                'common.refresh': 'Refresh',
                'common.actions': 'Actions',
            }
        };

        let currentLang = localStorage.getItem('ocr-dashboard-lang') || 'pl';

        function t(key) {
            return translations[currentLang]?.[key] || translations['pl']?.[key] || key;
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('ocr-dashboard-lang', lang);
            document.documentElement.lang = lang;
            applyTranslations();
            updateLanguageButtons();
        }

        function updateLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === currentLang);
            });
        }

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                const text = t(key);
                if (el.tagName === 'INPUT' && el.type === 'text') {
                    el.placeholder = text;
                } else {
                    el.textContent = text;
                }
            });
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                el.title = t(el.dataset.i18nTitle);
            });
        }

        // ============================================
        // State Management
        // ============================================

        let currentTab = 'overview';
        let currentFilter = 'all';
        let currentViewMode = 'table';
        let selectMode = false;
        let selectedProfiles = new Set();
        let autoRefreshInterval = null;
        let profilesData = [];

        // ============================================
        // Tab Navigation
        // ============================================

        function switchTab(tabId) {
            // Update hash (will trigger handleHashChange if changed by user, but here we set it to push state)
            // But if we just click, we want to update the view immediately for responsiveness, 
            // then update hash. However, updating hash triggers hashchange.
            // Best pattern: Update hash, let hashchange handle the view switch?
            // Or: View switch, then silent update? 
            // Simple approach: Update hash, allow router to handle it?
            // No, the user might want immediate feedback.
            // Let's go with: Update UI, then update hash (silently if possible, or just standard).
            // Actually, setting hash handles history. Let's rely on HashChange for the logic source of truth?
            // If I set hash, it triggers hashchange. So I should put the logic in handleHashChange.
            // BUT existing onclicks call switchTab directly.
            // So: switchTab updates UI, THEN updates Hash. To avoid loop, check if hash matches.

            const currentHashTab = window.location.hash.slice(1).split('/')[0] || 'overview';
            if (currentHashTab !== tabId) {
                window.location.hash = tabId;
                return; // Let hashchange event handle the rest to ensure internal consistency?
                // If I return here, there might be a lag. 
                // Let's execute UI update immediately, and manage the flag.
            }

            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.tab === tabId);
            });

            // Update tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === 'tab-' + tabId);
            });

            currentTab = tabId;

            // Trigger specific tab actions
            if (tabId === 'activity') {
                refreshLivePreview();
            } else if (tabId === 'logs') {
                refreshLogs();
            }

            updateBreadcrumb(tabId);
        }

        // ============================================
        // Sidebar
        // ============================================

        function toggleSidebar() {
            const layout = document.getElementById('appLayout');
            layout.classList.toggle('sidebar-collapsed');

            // Update toggle button text
            const toggleBtn = document.querySelector('.sidebar-toggle');
            const isCollapsed = layout.classList.contains('sidebar-collapsed');
            toggleBtn.innerHTML = isCollapsed
                ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>'
                : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="11 17 6 12 11 7"/><polyline points="18 17 13 12 18 7"/></svg><span class="nav-item-text">Zwiń</span>';
        }

        // ============================================
        // Profile Filtering & Search
        // ============================================

        function filterProfiles() {
            const searchTerm = document.getElementById('profileSearch').value.toLowerCase();
            let visibleCount = 0;

            // Filter grid cards
            const cards = document.querySelectorAll('.profile-card');
            cards.forEach(card => {
                const profileName = card.dataset.profile.toLowerCase();
                const status = card.dataset.status;

                const matchesSearch = profileName.includes(searchTerm);
                const matchesFilter = currentFilter === 'all' || status === currentFilter;

                const isVisible = matchesSearch && matchesFilter;
                card.style.display = isVisible ? '' : 'none';

                if (isVisible) visibleCount++;
            });

            // Filter table rows
            const rows = document.querySelectorAll('.profile-row');
            rows.forEach(row => {
                const profileName = row.dataset.profile.toLowerCase();
                const status = row.dataset.status;

                const matchesSearch = profileName.includes(searchTerm);
                const matchesFilter = currentFilter === 'all' || status === currentFilter;

                const isVisible = matchesSearch && matchesFilter;
                row.style.display = isVisible ? '' : 'none';
            });

            document.getElementById('profilesVisibleCount').textContent = visibleCount;
        }

        function setFilter(filter) {
            currentFilter = filter;

            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });

            filterProfiles();
        }

        // ============================================
        // View Mode (Grid/Table)
        // ============================================

        function setViewMode(mode) {
            currentViewMode = mode;

            // Update toggle buttons
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === mode);
            });

            // Show/hide views
            const grid = document.getElementById('profilesGrid');
            const table = document.getElementById('profilesTable');

            if (mode === 'grid') {
                grid.classList.remove('hidden');
                table.classList.add('hidden');
            } else {
                grid.classList.add('hidden');
                table.classList.remove('hidden');
            }

            // Re-apply filters
            filterProfiles();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllTable');
            const checkboxes = document.querySelectorAll('.profile-checkbox-table');

            checkboxes.forEach(cb => {
                const row = cb.closest('.profile-row');
                if (row && row.style.display !== 'none') {
                    cb.checked = selectAll.checked;
                }
            });

            updateSelectionFromTable();
        }

        function updateSelectionFromTable() {
            const checkboxes = document.querySelectorAll('.profile-checkbox-table:checked');
            selectedProfiles = new Set([...checkboxes].map(cb => cb.dataset.profile));

            document.getElementById('selectedCount').textContent = selectedProfiles.size;

            const bulkBar = document.getElementById('bulkActionsBar');
            bulkBar.classList.toggle('visible', selectedProfiles.size > 0);
        }

        // ============================================
        // Selection Mode
        // ============================================

        function toggleSelectMode() {
            selectMode = !selectMode;

            const checkboxes = document.querySelectorAll('.profile-checkbox');
            checkboxes.forEach(cb => {
                cb.classList.toggle('hidden', !selectMode);
            });

            document.getElementById('selectModeText').textContent = selectMode ? 'Anuluj' : 'Zaznacz';

            if (!selectMode) {
                clearSelection();
            }
        }

        function updateSelection() {
            const checkboxes = document.querySelectorAll('.profile-checkbox:checked');
            selectedProfiles = new Set([...checkboxes].map(cb => cb.dataset.profile));

            document.getElementById('selectedCount').textContent = selectedProfiles.size;

            const bulkBar = document.getElementById('bulkActionsBar');
            bulkBar.classList.toggle('visible', selectedProfiles.size > 0);
        }

        function clearSelection() {
            document.querySelectorAll('.profile-checkbox').forEach(cb => {
                cb.checked = false;
            });
            selectedProfiles.clear();
            updateSelection();
        }

        // ============================================
        // Profile Actions
        // ============================================

        async function startProfile(profileName) {
            // Optimistic UI Update
            const profile = profilesData.find(p => p.name === profileName);
            if (profile) {
                profile.status = 'starting';
                profile.status_label = 'STARTING...';
                filterProfiles(); // Re-render table
            }

            showToast('info', 'Uruchamianie...', `Uruchamianie profilu ${profileName}`);
            try {
                const response = await fetch(`/api/profile/${profileName}/start`, { method: 'POST' });
                if (response.ok) {
                    showToast('success', 'Uruchomiono', `Profil ${profileName} został uruchomiony`);

                    // Optimistic Success Update
                    if (profile) {
                        profile.status = 'active';
                        profile.status_label = 'ACTIVE';
                        filterProfiles();
                    }

                    setTimeout(refreshData, 100); // Fast refresh
                } else {
                    showToast('error', 'Błąd', 'Nie udało się uruchomić profilu');
                    refreshData(); // Revert on error
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
                refreshData(); // Revert on error
            }
        }

        async function stopProfile(profileName) {
            // Optimistic UI Update
            const profile = profilesData.find(p => p.name === profileName);
            if (profile) {
                profile.status = 'stopping';
                profile.status_label = 'STOPPING...';
                filterProfiles(); // Re-render table
            }

            showToast('info', 'Zatrzymywanie...', `Zatrzymywanie profilu ${profileName}`);
            try {
                const response = await fetch(`/api/profile/${profileName}/stop`, { method: 'POST' });
                if (response.ok) {
                    showToast('success', 'Zatrzymano', `Profil ${profileName} został zatrzymany`);

                    // Optimistic Success Update
                    if (profile) {
                        profile.status = 'idle'; // or whatever the stopped status is, usually 'idle' or 'terminated'
                        profile.status_label = 'IDLE';
                        filterProfiles();
                    }

                    setTimeout(refreshData, 100); // Fast refresh
                } else {
                    showToast('error', 'Błąd', 'Nie udało się zatrzymać profilu');
                    refreshData(); // Revert
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
                refreshData(); // Revert
            }
        }

        // ============================================
        // Execution Mode Management
        // ============================================

        const executionModes = {};

        function updateExecutionMode(profileName, mode) {
            executionModes[profileName] = mode;
            localStorage.setItem('ocr-execution-modes', JSON.stringify(executionModes));

            // Sync all selects for this profile (grid and table)
            document.querySelectorAll(`select.execution-mode-select[data-profile="${profileName}"]`).forEach(select => {
                if (select.value !== mode) {
                    select.value = mode;
                }
            });
        }

        function loadExecutionModes() {
            const stored = localStorage.getItem('ocr-execution-modes');
            if (stored) {
                try {
                    const modes = JSON.parse(stored);
                    Object.assign(executionModes, modes);

                    // Apply to all selects
                    Object.entries(modes).forEach(([profileName, mode]) => {
                        document.querySelectorAll(`select.execution-mode-select[data-profile="${profileName}"]`).forEach(select => {
                            select.value = mode;
                        });
                    });
                } catch (e) {
                    console.error('Failed to load execution modes:', e);
                }
            }
        }

        function getExecutionMode(profileName) {
            return executionModes[profileName] || 'local';
        }

        function getProfilesByExecutionMode() {
            const result = {
                profiles: [],
                remote_browser_profiles: [],
                remote_ssh_profiles: [],
                remote_desktop_profiles: [],
                remote_desktop_browser_profiles: []
            };

            const selectedProfiles = getSelectedProfiles();

            selectedProfiles.forEach(profileName => {
                const mode = getExecutionMode(profileName);
                switch (mode) {
                    case 'local':
                        result.profiles.push(profileName);
                        break;
                    case 'wsl_browser':
                        result.remote_browser_profiles.push(profileName);
                        break;
                    case 'wsl_worker':
                        result.remote_ssh_profiles.push(profileName);
                        break;
                    case 'desktop_browser':
                        result.remote_desktop_browser_profiles.push(profileName);
                        break;
                    case 'desktop_worker':
                        result.remote_desktop_profiles.push(profileName);
                        break;
                }
            });

            return result;
        }

        async function restartProfile(profileName) {
            await stopProfile(profileName);
            setTimeout(() => startProfile(profileName), 1000);
        }

        async function startAllProfiles() {
            showToast('info', 'Uruchamianie...', 'Uruchamianie wszystkich profili');
            try {
                const response = await fetch('/api/farm/start', { method: 'POST' });
                if (response.ok) {
                    showToast('success', 'Uruchomiono', 'Wszystkie profile zostały uruchomione');
                    refreshData();
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        async function stopAllProfiles() {
            showToast('info', 'Zatrzymywanie...', 'Zatrzymywanie wszystkich profili');
            try {
                const response = await fetch('/api/farm/stop', { method: 'POST' });
                if (response.ok) {
                    showToast('success', 'Zatrzymano', 'Wszystkie profile zostały zatrzymane');
                    refreshData();
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        async function startSelected() {
            for (const profile of selectedProfiles) {
                await startProfile(profile);
            }
            clearSelection();
        }

        async function stopSelected() {
            for (const profile of selectedProfiles) {
                await stopProfile(profile);
            }
            clearSelection();
        }

        // ============================================
        // Data Refresh
        // ============================================

        async function refreshData() {
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.style.animation = 'spin 1s linear infinite';

            try {
                const response = await fetch('/api/stats/v2');
                const data = await response.json();

                updateStats(data);
                updateProfiles(data.profiles || []);
                updateLastUpdate();

            } catch (e) {
                console.error('Failed to refresh data:', e);
            } finally {
                refreshIcon.style.animation = '';
            }
        }

        function updateStats(data) {
            const stats = data.stats || {};
            const profiles = data.profiles || [];

            // Count statuses
            const activeCount = profiles.filter(p => p.status === 'active').length;
            const pausedCount = profiles.filter(p => p.status === 'paused').length;
            const limitCount = profiles.filter(p => p.status === 'limit').length;
            const idleCount = profiles.filter(p => !p.status || p.status === 'idle' || p.status === 'error').length;
            const totalProfiles = profiles.length;

            // Header stats
            document.getElementById('headerActiveProfiles').textContent = activeCount;
            document.getElementById('headerPausedProfiles').textContent = pausedCount;
            document.getElementById('headerLimitProfiles').textContent = limitCount;
            document.getElementById('headerTodayScans').textContent = stats.today_scans || 0;
            document.getElementById('headerTotalProcessed').textContent = stats.total_processed || 0;

            // Sidebar stats
            document.getElementById('sidebarActiveCount').textContent = activeCount;
            document.getElementById('sidebarPausedCount').textContent = pausedCount;
            document.getElementById('sidebarLimitCount').textContent = limitCount;
            document.getElementById('sidebarTodayScans').textContent = stats.today_scans || 0;

            // Overview stats
            document.getElementById('statTotalProfiles').textContent = totalProfiles;
            document.getElementById('statActiveWorkers').textContent = stats.active_workers || activeCount;
            document.getElementById('statTodayProcessed').textContent = stats.today_scans || 0;
            document.getElementById('statErrors').textContent = stats.errors || 0;

            // Summary progress bars
            document.getElementById('summaryActive').textContent = activeCount;
            document.getElementById('summaryPaused').textContent = pausedCount;
            document.getElementById('summaryLimit').textContent = limitCount;
            document.getElementById('summaryIdle').textContent = idleCount;

            const total = totalProfiles || 1;
            document.getElementById('progressActive').style.width = (activeCount / total * 100) + '%';
            document.getElementById('progressPaused').style.width = (pausedCount / total * 100) + '%';
            document.getElementById('progressLimit').style.width = (limitCount / total * 100) + '%';
            document.getElementById('progressIdle').style.width = (idleCount / total * 100) + '%';

            // Filter counts
            document.getElementById('filterAllCount').textContent = totalProfiles;
            document.getElementById('filterActiveCount').textContent = activeCount;
            document.getElementById('filterPausedCount').textContent = pausedCount;
            document.getElementById('filterLimitCount').textContent = limitCount;
            document.getElementById('filterIdleCount').textContent = idleCount;
        }

        function updateProfiles(profiles) {
            profilesData = profiles;

            profiles.forEach(profile => {
                const statusValue = profile.status || 'idle';
                const statusLabel = profile.status_label || statusValue || 'IDLE';
                const labelUpper = statusLabel.toUpperCase();

                const card = document.querySelector(`.profile-card[data-profile="${profile.name}"]`);
                if (card) {
                    // Update status
                    card.className = `profile-card status-${statusValue}`;
                    card.dataset.status = statusValue;

                    // Update status badge
                    const statusBadge = card.querySelector('.profile-status');
                    if (statusBadge) {
                        statusBadge.className = `profile-status ${escapeHtml(statusValue)}`;
                        statusBadge.innerHTML = statusValue === 'active'
                            ? `<span style="width:6px;height:6px;background:currentColor;border-radius:50%;animation:pulse 2s infinite;"></span> ${escapeHtml(statusLabel)}`
                            : escapeHtml(statusLabel);
                    }

                    // Update stats
                    const statValues = card.querySelectorAll('.profile-stat-value');
                    if (statValues.length >= 3) {
                        statValues[0].textContent = profile.processed || 0;
                        statValues[1].textContent = (profile.tokens_k || 0) + 'k';
                        statValues[2].textContent = profile.errors || 0;
                    }

                    // Update actions
                    const actionsContainer = card.querySelector('.profile-card-actions');
                    if (actionsContainer) {
                        const isActive = statusValue === 'active';
                        actionsContainer.innerHTML = `
                            ${isActive
                                ? `<button class="profile-action-btn danger" onclick="stopProfile(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="Zatrzymaj">Stop</button>`
                                : `<button class="profile-action-btn primary" onclick="startProfile(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="Uruchom">Start</button>`
                            }
                            <button class="profile-action-btn" onclick="restartProfile(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="Restart">Restart</button>
                            <button class="profile-action-btn" onclick="showProfileDetails(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="Szczegóły">Info</button>
                        `;
                    }
                }

                // NEW: Update List View (Table Rows)
                const row = document.querySelector(`.profile-row[data-profile="${profile.name}"]`);
                if (row) {
                    row.dataset.status = statusValue;

                    // Update Status Badge (Column 3)
                    const badge = row.querySelector('.badge');
                    if (badge) {
                        let badgeClass = 'neutral';
                        if (statusValue === 'active') badgeClass = 'success';
                        else if (statusValue === 'paused') badgeClass = 'warning';
                        else if (statusValue === 'limit') badgeClass = 'error';
                        else if (statusValue === 'error') badgeClass = 'error';

                        if (labelUpper.includes('START') || labelUpper.includes('PONAWIANIE')) {
                            badgeClass = 'info';
                        }

                        badge.className = `badge badge-${badgeClass}`;
                        badge.textContent = statusLabel;
                    }

                    // Update Stats (Cols 4,5,6,7)
                    // Col index: 0=check, 1=name, 2=status, 3=mode, 4=proc, 5=tok, 6=err, 7=last, 8=act
                    if (row.cells.length > 8) {
                        row.cells[4].textContent = profile.processed || 0;
                        row.cells[5].textContent = (profile.tokens_k || 0) + 'k';
                        row.cells[6].textContent = profile.errors || 0;
                        row.cells[7].textContent = profile.last_activity || '-';

                        // Update Actions (Col 8)
                        const actionsDiv = row.cells[8].querySelector('div');
                        if (actionsDiv) {
                            const isActive = statusValue === 'active' || labelUpper.includes('START') || labelUpper.includes('PONAWIANIE');
                            // If starting/retrying, we usually want to show Stop too, or at least disable Start

                            actionsDiv.innerHTML = `
                                ${isActive
                                    ? `<button class="btn btn-danger btn-sm" onclick="stopProfile(this.dataset.name)" data-name="${escapeHtml(profile.name)}">Stop</button>`
                                    : `<button class="btn btn-success btn-sm" onclick="startProfile(this.dataset.name)" data-name="${escapeHtml(profile.name)}">Start</button>`
                                }
                                <button class="btn btn-secondary btn-sm" onclick="loginProfile(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="Zaloguj">Login</button>
                                <button class="btn btn-ghost btn-sm" onclick="showProfileDetails(this.dataset.name)" data-name="${escapeHtml(profile.name)}">Info</button>
                                <button class="btn btn-ghost btn-sm text-error" onclick="deleteProfileConfirm(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="Usuń">Del</button>
                            `;
                        }
                    }
                }
            });

            filterProfiles();
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('pl-PL');
        }

        // ============================================
        // Live Preview
        // ============================================

        async function refreshLivePreview() {
            try {
                const response = await fetch('/api/live-preview');
                const data = await response.json();

                const container = document.getElementById('livePreviewContainer');
                const noActivity = document.getElementById('noActivityMessage');

                if (!data.previews || data.previews.length === 0) {
                    noActivity.style.display = '';
                    return;
                }

                noActivity.style.display = 'none';

                // Update preview cards
                container.innerHTML = data.previews.map(preview => `
                    <div class="preview-card">
                        <div class="preview-card-header">
                            <span class="preview-title">${escapeHtml(preview.profile)} - Worker ${escapeHtml(preview.worker)}</span>
                            <span class="badge badge-${preview.status === 'processing' ? 'info' : 'success'}">
                                ${escapeHtml(preview.status)}
                            </span>
                        </div>
                        <div class="preview-image-container">
                            ${preview.image_url
                        ? `<img class="preview-image" src="${escapeHtml(preview.image_url)}" alt="Preview">`
                        : '<span class="preview-placeholder">Ładowanie...</span>'
                    }
                        </div>
                        <div class="preview-footer">
                            ${escapeHtml(preview.filename || 'Przetwarzanie...')}
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                console.error('Failed to refresh live preview:', e);
            }
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefreshActivity');

            if (checkbox.checked) {
                autoRefreshInterval = setInterval(() => {
                    if (currentTab === 'activity') {
                        refreshLivePreview();
                    }
                }, 3000);
            } else {
                clearInterval(autoRefreshInterval);
            }
        }

        // ============================================
        // Logs
        // ============================================

        async function refreshLogs() {
            try {
                const profileFilter = document.getElementById('logProfileFilter').value;
                const levelFilter = document.getElementById('logLevelFilter').value;

                const params = new URLSearchParams();
                if (profileFilter !== 'all') params.set('profile', profileFilter);
                if (levelFilter !== 'all') params.set('level', levelFilter);

                const response = await fetch(`/api/logs?${params}`);
                const data = await response.json();

                const container = document.getElementById('logContainer');
                const noLogs = document.getElementById('noLogsMessage');

                if (!data.logs || data.logs.length === 0) {
                    container.innerHTML = '';
                    container.appendChild(noLogs);
                    noLogs.style.display = '';
                    return;
                }

                noLogs.style.display = 'none';

                container.innerHTML = data.logs.map(log => `
                    <div class="log-entry">
                        <span class="log-time">${escapeHtml(log.time)}</span>
                        <span class="log-level ${escapeHtml(log.level.toLowerCase())}">${escapeHtml(log.level)}</span>
                        <span class="log-message">${escapeHtml(log.message)}</span>
                    </div>
                `).join('');

            } catch (e) {
                console.error('Failed to refresh logs:', e);
            }
        }

        function filterLogs() {
            refreshLogs();
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = `
                <div class="empty-state" id="noLogsMessage">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                    </div>
                    <h3 class="empty-title">Brak logów</h3>
                    <p class="empty-message">Logi pojawią się tutaj po rozpoczęciu przetwarzania.</p>
                </div>
            `;
        }

        // ============================================
        // Modal
        // ============================================

        function showProfileDetails(profileName) {
            const modal = document.getElementById('profileModal');
            document.getElementById('modalProfileName').textContent = profileName;

            const profile = profilesData.find(p => p.name === profileName) || {};

            document.getElementById('modalContent').innerHTML = `
                <div style="display: grid; gap: var(--spacing-md);">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <span class="badge badge-${profile.status === 'active' ? 'success' : profile.status === 'paused' ? 'warning' : profile.status === 'limit' ? 'error' : 'neutral'}">
                            ${escapeHtml(profile.status || 'idle')}
                        </span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Przetworzonych</label>
                        <div class="text-primary font-bold">${escapeHtml(profile.processed || 0)}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tokeny</label>
                        <div class="text-primary font-bold">${escapeHtml(profile.tokens_k || 0)}k</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Błędy</label>
                        <div class="text-primary font-bold">${escapeHtml(profile.errors || 0)}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ostatnia aktywność</label>
                        <div class="text-secondary">${escapeHtml(profile.last_activity || '-')}</div>
                    </div>
                    ${profile.current_file ? `
                    <div class="form-group">
                        <label class="form-label">Aktualny plik</label>
                        <div class="text-secondary font-mono" style="font-size: 12px; word-break: break-all;">${escapeHtml(profile.current_file)}</div>
                    </div>
                    ` : ''}
                </div>
            `;

            modal.classList.add('visible');
        }

        function closeModal() {
            document.getElementById('profileModal').classList.remove('visible');
        }

        // Close modal on overlay click
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') closeModal();
        });

        // ============================================
        // Routing & Breadcrumbs
        // ============================================

        const TAB_NAMES = {
            'overview': 'Przegląd',
            'profiles': 'Profile',
            'activity': 'Aktywność',
            'preview': 'Podgląd',
            'logs': 'Logi',
            'limits': 'Limity',
            'postprocess': 'Post-Process',
            'jobconfig': 'nav.jobconfig', // Using the exact key/text requested or from data-i18n
            'settings': 'Ustawienia'
        };

        const CONFIG_TAB_NAMES = {
            'basic': 'Podstawowe',
            'performance': 'Wydajność',
            'database': 'Database',
            'preprocessing': 'Preprocessing',
            'advanced': 'Zaawansowane'
        };

        function updateBreadcrumb(mainTab, subTab = null) {
            const container = document.getElementById('breadcrumb');
            let html = '<span class="breadcrumb-item">Menu</span>';

            // Resolve Main Tab Name safely
            let mainName = TAB_NAMES[mainTab];
            if (!mainName) {
                try {
                    // Safe selector construction
                    const safeSelector = mainTab.replace(/["\\]/g, '\\$&');
                    const navItem = document.querySelector(`.nav-item[data-tab="${safeSelector}"] .nav-item-text`);
                    if (navItem) mainName = navItem.innerText;
                } catch (e) { }
            }
            if (!mainName) mainName = mainTab;

            const safeMainTab = escapeHtml(mainTab);
            const safeMainName = escapeHtml(mainName);

            if (subTab) {
                // Use href="#" for navigation, removed unsafe onclick
                html += `<span class="breadcrumb-item"><a href="#${safeMainTab}" style="color: inherit; text-decoration: none;">${safeMainName}</a></span>`;

                // Resolve Sub Tab Name safely
                let subName = CONFIG_TAB_NAMES[subTab];
                if (!subName) {
                    try {
                        const safeSelector = subTab.replace(/["\\]/g, '\\$&');
                        const configTabBtn = document.querySelector(`.config-tab[data-config-tab="${safeSelector}"]`);
                        if (configTabBtn) subName = configTabBtn.innerText;
                    } catch (e) { }
                }
                if (!subName) subName = subTab;

                const safeSubName = escapeHtml(subName);

                html += `<span class="breadcrumb-item active">${safeSubName}</span>`;
            } else {
                html += `<span class="breadcrumb-item active">${safeMainName}</span>`;
            }

            container.innerHTML = html;
        }

        function handleHashChange() {
            const hash = window.location.hash.slice(1); // Remove #
            if (!hash) {
                switchTab('overview');
                return;
            }

            const parts = hash.split('/');
            const mainTab = parts[0];
            const subTab = parts[1];

            // 1. Switch Main Tab
            // We call the internal logic of switchTab directly to avoid loop or just use it
            // Code of switchTab updates UI.
            // We need to bypass hash update in switchTab if it comes from here?
            // Actually, if we set hash to what it already is, it's fine.

            // Manually switch Main Tab UI
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.tab === mainTab);
            });
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === 'tab-' + mainTab);
            });
            currentTab = mainTab;
            if (mainTab === 'activity') refreshLivePreview();
            if (mainTab === 'logs') refreshLogs();

            // 2. Switch Sub Tab if applicable
            if (mainTab === 'jobconfig' && subTab) {
                // Manually switch Config Tab UI
                document.querySelectorAll('.config-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.config-panel').forEach(panel => panel.classList.remove('active'));

                const selectedTab = document.querySelector(`.config-tab[data-config-tab="${subTab}"]`);
                const selectedPanel = document.getElementById(`config-${subTab}`);

                if (selectedTab) selectedTab.classList.add('active');
                if (selectedPanel) selectedPanel.classList.add('active');
            }

            updateBreadcrumb(mainTab, subTab);
        }

        // Initialize Router
        window.addEventListener('hashchange', handleHashChange);
        window.addEventListener('DOMContentLoaded', () => {
            handleHashChange();
            startConnectionCheck();
            refreshData();
        });



        // ============================================
        // Toast Notifications
        // ============================================

        function showToast(type, title, message) {
            const container = document.getElementById('toastContainer');

            const icons = {
                success: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
                error: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
                warning: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
                info: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${escapeHtml(title)}</div>
                    <div class="toast-message">${escapeHtml(message)}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;

            container.appendChild(toast);

            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // ============================================
        // Checkbox Event Listeners
        // ============================================

        document.querySelectorAll('.profile-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelection);
        });

        document.querySelectorAll('.profile-checkbox-table').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectionFromTable);
        });

        // ============================================
        // Initialize
        // ============================================

        document.addEventListener('DOMContentLoaded', function () {
            // Load execution modes from localStorage
            loadExecutionModes();

            // Load default source path from API
            loadDefaultSourcePath();

            // Initial data refresh
            refreshData();

            // Auto refresh every 1 second (was 10s)
            setInterval(refreshData, 1000);

            // Start activity auto-refresh
            toggleAutoRefresh();

            // Update filter counts initially
            filterProfiles();
        });

        // ============================================
        // Start Job Modal
        // ============================================

        function openStartJobModal() {
            document.getElementById('startJobModal').classList.add('visible');
            // Load saved source path if available
            const savedPath = localStorage.getItem('lastSourcePath');
            if (savedPath) {
                document.getElementById('jobSourcePath').value = savedPath;
            }
        }

        function closeStartJobModal() {
            document.getElementById('startJobModal').classList.remove('visible');
        }

        // Removed duplicate switchConfigTab function


        function selectAllJobProfiles() {
            document.querySelectorAll('.job-profile-cb').forEach(cb => cb.checked = true);
        }

        function selectOkLimitProfiles() {
            // Select only profiles that don't have limit status
            document.querySelectorAll('.job-profile-cb').forEach(cb => {
                const profile = profilesData.find(p => p.name === cb.value);
                cb.checked = profile && profile.status !== 'limit';
            });
        }

        function clearJobProfiles() {
            document.querySelectorAll('.job-profile-cb').forEach(cb => cb.checked = false);
        }

        async function startJob() {
            const sourcePath = document.getElementById('jobSourcePath').value;
            if (!sourcePath) {
                showToast('error', 'Błąd', 'Podaj ścieżkę źródłową');
                return;
            }

            const selectedProfiles = [...document.querySelectorAll('.job-profile-cb:checked')].map(cb => cb.value);
            if (selectedProfiles.length === 0) {
                showToast('error', 'Błąd', 'Wybierz przynajmniej jeden profil');
                return;
            }

            localStorage.setItem('lastSourcePath', sourcePath);

            // Split profiles by execution mode
            const profilesByMode = {
                profiles: [],
                remote_browser_profiles: [],
                remote_ssh_profiles: [],
                remote_desktop_profiles: [],
                remote_desktop_browser_profiles: []
            };

            selectedProfiles.forEach(profileName => {
                const mode = getExecutionMode(profileName);
                switch (mode) {
                    case 'local':
                        profilesByMode.profiles.push(profileName);
                        break;
                    case 'wsl_browser':
                        profilesByMode.remote_browser_profiles.push(profileName);
                        break;
                    case 'wsl_worker':
                        profilesByMode.remote_ssh_profiles.push(profileName);
                        break;
                    case 'desktop_browser':
                        profilesByMode.remote_desktop_browser_profiles.push(profileName);
                        break;
                    case 'desktop_worker':
                        profilesByMode.remote_desktop_profiles.push(profileName);
                        break;
                }
            });

            const jobParams = {
                source_dir: sourcePath,
                batch_id: document.getElementById('jobBatchId').value || null,
                ...profilesByMode,
                headed: document.getElementById('jobHeadedMode').checked,
                workers: parseInt(document.getElementById('jobWorkers').value) || 2,
                scans_per_worker: parseInt(document.getElementById('jobScansPerWorker').value) || 2,
                collect_timeout_sec: parseInt(document.getElementById('jobCollectTimeout').value) || 400,
                pg_enabled: document.getElementById('jobPgEnabled').checked,
                pg_dsn: document.getElementById('jobPgDsn').value || null,
                pg_table: document.getElementById('jobPgTable').value || 'public.ocr_raw_texts',
                continue_mode: document.getElementById('jobContinueMode').checked,
                pro_only: document.getElementById('jobProOnly').checked,
                preproc_max_dimension: parseInt(document.getElementById('jobPreprocMaxDim').value) || 2500,
                debug_artifacts: document.getElementById('jobDebugArtifacts').checked,
                capture_video: document.getElementById('jobCaptureVideo').checked,
            };

            showToast('info', 'Uruchamianie...', 'Uruchamianie joba OCR');
            closeStartJobModal();

            try {
                const response = await fetch('/api/jobs/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jobParams)
                });

                if (response.ok) {
                    showToast('success', 'Uruchomiono', 'Job OCR został uruchomiony');
                    refreshData();
                } else {
                    const data = await response.json();
                    showToast('error', 'Błąd', data.detail || 'Nie udało się uruchomić joba');
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        // ============================================
        // Job Config Tab Functions
        // ============================================

        function switchConfigTab(tabName) {
            // Update URL hash to include subtab
            // Format: #jobconfig/subtab
            const hashParts = window.location.hash.slice(1).split('/');
            const mainTab = hashParts[0] || 'jobconfig';
            if (mainTab === 'jobconfig') {
                const newHash = `${mainTab}/${tabName}`;
                if (window.location.hash.slice(1) !== newHash) {
                    window.location.hash = newHash;
                    // Hash change will finalize if needed, but we update UI strictly here for speed
                }
            }

            // Remove active class from all tabs and panels
            document.querySelectorAll('.config-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.config-panel').forEach(panel => panel.classList.remove('active'));

            // Add active class to selected tab and panel
            const selectedTab = document.querySelector(`.config-tab[data-config-tab="${tabName}"]`);
            const selectedPanel = document.getElementById(`config-${tabName}`);

            if (selectedTab) selectedTab.classList.add('active');
            if (selectedPanel) selectedPanel.classList.add('active');

            updateBreadcrumb('jobconfig', tabName);
        }

        async function startJobFromConfig() {
            const sourcePath = document.getElementById('jobSourcePath').value;
            if (!sourcePath) {
                showToast('error', 'Błąd', 'Podaj ścieżkę źródłową');
                return;
            }

            const selectedProfiles = [...document.querySelectorAll('.job-profile-cb:checked')].map(cb => cb.value);
            if (selectedProfiles.length === 0) {
                showToast('error', 'Błąd', 'Wybierz przynajmniej jeden profil');
                return;
            }

            localStorage.setItem('lastSourcePath', sourcePath);

            // Split profiles by execution mode
            const profilesByMode = {
                profiles: [],
                remote_browser_profiles: [],
                remote_ssh_profiles: [],
                remote_desktop_profiles: [],
                remote_desktop_browser_profiles: []
            };

            selectedProfiles.forEach(profileName => {
                const mode = getExecutionMode(profileName);
                switch (mode) {
                    case 'local':
                        profilesByMode.profiles.push(profileName);
                        break;
                    case 'wsl_browser':
                        profilesByMode.remote_browser_profiles.push(profileName);
                        break;
                    case 'wsl_worker':
                        profilesByMode.remote_ssh_profiles.push(profileName);
                        break;
                    case 'desktop_browser':
                        profilesByMode.remote_desktop_browser_profiles.push(profileName);
                        break;
                    case 'desktop_worker':
                        profilesByMode.remote_desktop_profiles.push(profileName);
                        break;
                }
            });

            // Collect all job parameters from the form
            const jobParams = {
                source_dir: sourcePath,
                batch_id: document.getElementById('jobBatchId').value || null,
                ...profilesByMode,

                // Basic
                headed: document.getElementById('jobHeadedMode').checked,
                engine: document.getElementById('jobEngine').value,

                // Performance
                workers: parseInt(document.getElementById('jobWorkers').value) || 2,
                scans_per_worker: parseInt(document.getElementById('jobScansPerWorker').value) || 2,
                collect_timeout_sec: parseInt(document.getElementById('jobCollectTimeout').value) || 400,
                close_idle_tabs: document.getElementById('jobCloseIdleTabs').checked,
                max_tabs_per_context: parseInt(document.getElementById('jobMaxTabsPerContext').value) || 0,
                isolated_contexts: document.getElementById('jobIsolatedContexts').checked,
                context_pool_size: parseInt(document.getElementById('jobContextPoolSize').value) || 0,
                viewport_width: parseInt(document.getElementById('jobViewportWidth').value) || 1200,
                viewport_height: parseInt(document.getElementById('jobViewportHeight').value) || 800,
                reduced_motion: document.getElementById('jobReducedMotion').checked,

                // Database
                pg_enabled: document.getElementById('jobPgEnabled').checked,
                pg_dsn: document.getElementById('jobPgDsn').value || null,
                pg_table: document.getElementById('jobPgTable').value || 'public.ocr_raw_texts',

                // Preprocess
                preproc_max_dimension: parseInt(document.getElementById('jobPreprocMaxDim').value) || 2500,
                preproc_median_kernel: parseInt(document.getElementById('jobPreprocMedianKernel').value) || 3,
                preproc_denoise: parseInt(document.getElementById('jobPreprocDenoise').value) || 8,
                preproc_morph: parseInt(document.getElementById('jobPreprocMorph').value) || 2,
                preproc_clahe: parseFloat(document.getElementById('jobPreprocClahe').value) || 2.0,
                preproc_clahe_grid: document.getElementById('jobPreprocClaheGrid').value || '8,8',
                preproc_local_sigma: parseFloat(document.getElementById('jobPreprocLocalSigma').value) || 12.0,
                preproc_local_amount: parseFloat(document.getElementById('jobPreprocLocalAmount').value) || 0.35,
                preproc_blackhat_kernel: parseInt(document.getElementById('jobPreprocBlackhatKernel').value) || 5,
                preproc_blackhat_strength: parseFloat(document.getElementById('jobPreprocBlackhatStrength').value) || 0.45,
                preproc_unsharp_amount: parseFloat(document.getElementById('jobPreprocUnsharpAmount').value) || 1.2,
                preproc_unsharp_radius: parseInt(document.getElementById('jobPreprocUnsharpRadius').value) || 1,
                preproc_margin_percent: parseFloat(document.getElementById('jobPreprocMarginPercent').value) || 0.05,
                preproc_dark_threshold: parseInt(document.getElementById('jobPreprocDarkThreshold').value) || 60,
                preproc_margin_ink_ratio: parseFloat(document.getElementById('jobPreprocMarginInkRatio').value) || 0.01,
                preproc_margin_shadow: parseInt(document.getElementById('jobPreprocMarginShadow').value) || 200,
                preproc_bg_kernel_ratio: parseFloat(document.getElementById('jobPreprocBgKernelRatio').value) || 0.025,
                preproc_bg_kernel_min: parseInt(document.getElementById('jobPreprocBgKernelMin').value) || 31,
                preproc_binarization: document.getElementById('jobPreprocBinarization').checked,
                preproc_sauvola_w: parseInt(document.getElementById('jobPreprocSauvolaW').value) || 31,
                preproc_sauvola_k: parseFloat(document.getElementById('jobPreprocSauvolaK').value) || 0.2,
                preproc_sauvola_r: parseFloat(document.getElementById('jobPreprocSauvolaR').value) || 128.0,
                preproc_text_mask_block: parseInt(document.getElementById('jobPreprocTextMaskBlock').value) || 31,
                preproc_text_mask_c: parseInt(document.getElementById('jobPreprocTextMaskC').value) || 12,
                preproc_text_mask_open_k: parseInt(document.getElementById('jobPreprocTextMaskOpenK').value) || 3,
                preproc_text_mask_close_k: parseInt(document.getElementById('jobPreprocTextMaskCloseK').value) || 9,
                preproc_text_mask_close_i: parseInt(document.getElementById('jobPreprocTextMaskCloseI').value) || 2,
                preproc_text_mask_dilate_i: parseInt(document.getElementById('jobPreprocTextMaskDilateI').value) || 1,
                preproc_text_mask_min_area: parseFloat(document.getElementById('jobPreprocTextMaskMinArea').value) || 0.0005,
                preproc_trim_band: parseFloat(document.getElementById('jobPreprocTrimBand').value) || 0.02,
                preproc_trim_ink: parseFloat(document.getElementById('jobPreprocTrimInk').value) || 0.02,
                preproc_trim_max: parseFloat(document.getElementById('jobPreprocTrimMax').value) || 0.15,
                preproc_trim_min_dim: parseInt(document.getElementById('jobPreprocTrimMinDim').value) || 200,

                // Advanced
                continue_mode: document.getElementById('jobContinueMode').checked,
                pro_only: document.getElementById('jobProOnly').checked,
                clean_temp: document.getElementById('jobCleanTemp').checked,
                debug_artifacts: document.getElementById('jobDebugArtifacts').checked,
                capture_video: document.getElementById('jobCaptureVideo').checked,
                tracing_mode: document.getElementById('jobTracingMode').value,
                auth_ensure: document.getElementById('jobAuthEnsure').checked,
                auth_ensure_interval: parseInt(document.getElementById('jobAuthEnsureInterval').value) || 900,
                model_switch_retries: parseInt(document.getElementById('jobModelSwitchRetries').value) || 3,
                model_switch_cooldown: parseInt(document.getElementById('jobModelSwitchCooldown').value) || 1200,
                limit_check_interval: parseInt(document.getElementById('jobLimitCheckInterval').value) || 1800,
                pro_pause_buffer: parseInt(document.getElementById('jobProPauseBuffer').value) || 180,
                pro_fallback_pause: parseInt(document.getElementById('jobProFallbackPause').value) || 60,
                browser_id: document.getElementById('jobBrowserId').value || null,
            };

            showToast('info', 'Uruchamianie...', 'Uruchamianie joba OCR');

            try {
                const response = await fetch('/api/jobs/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jobParams)
                });

                if (response.ok) {
                    showToast('success', 'Uruchomiono', 'Job OCR został uruchomiony');
                    refreshData();
                } else {
                    const data = await response.json();
                    showToast('error', 'Błąd', data.detail || 'Nie udało się uruchomić joba');
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        function saveJobConfig() {
            const config = {
                sourcePath: document.getElementById('jobSourcePath').value,
                batchId: document.getElementById('jobBatchId').value,
                headedMode: document.getElementById('jobHeadedMode').checked,
                engine: document.getElementById('jobEngine').value,
                workers: document.getElementById('jobWorkers').value,
                scansPerWorker: document.getElementById('jobScansPerWorker').value,
                collectTimeout: document.getElementById('jobCollectTimeout').value,
                closeIdleTabs: document.getElementById('jobCloseIdleTabs').checked,
                maxTabsPerContext: document.getElementById('jobMaxTabsPerContext').value,
                isolatedContexts: document.getElementById('jobIsolatedContexts').checked,
                contextPoolSize: document.getElementById('jobContextPoolSize').value,
                viewportWidth: document.getElementById('jobViewportWidth').value,
                viewportHeight: document.getElementById('jobViewportHeight').value,
                reducedMotion: document.getElementById('jobReducedMotion').checked,
                pgEnabled: document.getElementById('jobPgEnabled').checked,
                pgDsn: document.getElementById('jobPgDsn').value,
                pgTable: document.getElementById('jobPgTable').value,
                preprocMaxDim: document.getElementById('jobPreprocMaxDim').value,
                preprocMedianKernel: document.getElementById('jobPreprocMedianKernel').value,
                preprocDenoise: document.getElementById('jobPreprocDenoise').value,
                preprocMorph: document.getElementById('jobPreprocMorph').value,
                preprocClahe: document.getElementById('jobPreprocClahe').value,
                preprocClaheGrid: document.getElementById('jobPreprocClaheGrid').value,
                preprocLocalSigma: document.getElementById('jobPreprocLocalSigma').value,
                preprocLocalAmount: document.getElementById('jobPreprocLocalAmount').value,
                preprocBlackhatKernel: document.getElementById('jobPreprocBlackhatKernel').value,
                preprocBlackhatStrength: document.getElementById('jobPreprocBlackhatStrength').value,
                preprocUnsharpAmount: document.getElementById('jobPreprocUnsharpAmount').value,
                preprocUnsharpRadius: document.getElementById('jobPreprocUnsharpRadius').value,
                preprocMarginPercent: document.getElementById('jobPreprocMarginPercent').value,
                preprocDarkThreshold: document.getElementById('jobPreprocDarkThreshold').value,
                preprocMarginInkRatio: document.getElementById('jobPreprocMarginInkRatio').value,
                preprocMarginShadow: document.getElementById('jobPreprocMarginShadow').value,
                preprocBgKernelRatio: document.getElementById('jobPreprocBgKernelRatio').value,
                preprocBgKernelMin: document.getElementById('jobPreprocBgKernelMin').value,
                preprocBinarization: document.getElementById('jobPreprocBinarization').checked,
                preprocSauvolaW: document.getElementById('jobPreprocSauvolaW').value,
                preprocSauvolaK: document.getElementById('jobPreprocSauvolaK').value,
                preprocSauvolaR: document.getElementById('jobPreprocSauvolaR').value,
                preprocTextMaskBlock: document.getElementById('jobPreprocTextMaskBlock').value,
                preprocTextMaskC: document.getElementById('jobPreprocTextMaskC').value,
                preprocTextMaskOpenK: document.getElementById('jobPreprocTextMaskOpenK').value,
                preprocTextMaskCloseK: document.getElementById('jobPreprocTextMaskCloseK').value,
                preprocTextMaskCloseI: document.getElementById('jobPreprocTextMaskCloseI').value,
                preprocTextMaskDilateI: document.getElementById('jobPreprocTextMaskDilateI').value,
                preprocTextMaskMinArea: document.getElementById('jobPreprocTextMaskMinArea').value,
                preprocTrimBand: document.getElementById('jobPreprocTrimBand').value,
                preprocTrimInk: document.getElementById('jobPreprocTrimInk').value,
                preprocTrimMax: document.getElementById('jobPreprocTrimMax').value,
                preprocTrimMinDim: document.getElementById('jobPreprocTrimMinDim').value,
                continueMode: document.getElementById('jobContinueMode').checked,
                proOnly: document.getElementById('jobProOnly').checked,
                cleanTemp: document.getElementById('jobCleanTemp').checked,
                debugArtifacts: document.getElementById('jobDebugArtifacts').checked,
                captureVideo: document.getElementById('jobCaptureVideo').checked,
                tracingMode: document.getElementById('jobTracingMode').value,
                authEnsure: document.getElementById('jobAuthEnsure').checked,
                authEnsureInterval: document.getElementById('jobAuthEnsureInterval').value,
                modelSwitchRetries: document.getElementById('jobModelSwitchRetries').value,
                modelSwitchCooldown: document.getElementById('jobModelSwitchCooldown').value,
                limitCheckInterval: document.getElementById('jobLimitCheckInterval').value,
                proPauseBuffer: document.getElementById('jobProPauseBuffer').value,
                proFallbackPause: document.getElementById('jobProFallbackPause').value,
                browserId: document.getElementById('jobBrowserId').value,
            };

            localStorage.setItem('jobConfig', JSON.stringify(config));
            showToast('success', 'Zapisano', 'Konfiguracja została zapisana');
        }

        function loadJobConfig() {
            const savedConfig = localStorage.getItem('jobConfig');
            if (!savedConfig) {
                showToast('info', 'Brak konfiguracji', 'Nie znaleziono zapisanej konfiguracji');
                return;
            }

            try {
                const config = JSON.parse(savedConfig);

                // Basic
                if (config.sourcePath) document.getElementById('jobSourcePath').value = config.sourcePath;
                if (config.batchId) document.getElementById('jobBatchId').value = config.batchId;
                if (config.headedMode !== undefined) document.getElementById('jobHeadedMode').checked = config.headedMode;
                if (config.engine) document.getElementById('jobEngine').value = config.engine;

                // Performance
                if (config.workers) document.getElementById('jobWorkers').value = config.workers;
                if (config.scansPerWorker) document.getElementById('jobScansPerWorker').value = config.scansPerWorker;
                if (config.collectTimeout) document.getElementById('jobCollectTimeout').value = config.collectTimeout;
                if (config.closeIdleTabs !== undefined) document.getElementById('jobCloseIdleTabs').checked = config.closeIdleTabs;
                if (config.maxTabsPerContext) document.getElementById('jobMaxTabsPerContext').value = config.maxTabsPerContext;
                if (config.isolatedContexts !== undefined) document.getElementById('jobIsolatedContexts').checked = config.isolatedContexts;
                if (config.contextPoolSize) document.getElementById('jobContextPoolSize').value = config.contextPoolSize;
                if (config.viewportWidth) document.getElementById('jobViewportWidth').value = config.viewportWidth;
                if (config.viewportHeight) document.getElementById('jobViewportHeight').value = config.viewportHeight;
                if (config.reducedMotion !== undefined) document.getElementById('jobReducedMotion').checked = config.reducedMotion;

                // Database
                if (config.pgEnabled !== undefined) document.getElementById('jobPgEnabled').checked = config.pgEnabled;
                if (config.pgDsn) document.getElementById('jobPgDsn').value = config.pgDsn;
                if (config.pgTable) document.getElementById('jobPgTable').value = config.pgTable;

                // Preprocess
                if (config.preprocMaxDim) document.getElementById('jobPreprocMaxDim').value = config.preprocMaxDim;
                if (config.preprocMedianKernel) document.getElementById('jobPreprocMedianKernel').value = config.preprocMedianKernel;
                if (config.preprocDenoise) document.getElementById('jobPreprocDenoise').value = config.preprocDenoise;
                if (config.preprocMorph) document.getElementById('jobPreprocMorph').value = config.preprocMorph;
                if (config.preprocClahe) document.getElementById('jobPreprocClahe').value = config.preprocClahe;
                if (config.preprocClaheGrid) document.getElementById('jobPreprocClaheGrid').value = config.preprocClaheGrid;
                if (config.preprocLocalSigma) document.getElementById('jobPreprocLocalSigma').value = config.preprocLocalSigma;
                if (config.preprocLocalAmount) document.getElementById('jobPreprocLocalAmount').value = config.preprocLocalAmount;
                if (config.preprocBlackhatKernel) document.getElementById('jobPreprocBlackhatKernel').value = config.preprocBlackhatKernel;
                if (config.preprocBlackhatStrength) document.getElementById('jobPreprocBlackhatStrength').value = config.preprocBlackhatStrength;
                if (config.preprocUnsharpAmount) document.getElementById('jobPreprocUnsharpAmount').value = config.preprocUnsharpAmount;
                if (config.preprocUnsharpRadius) document.getElementById('jobPreprocUnsharpRadius').value = config.preprocUnsharpRadius;
                if (config.preprocMarginPercent) document.getElementById('jobPreprocMarginPercent').value = config.preprocMarginPercent;
                if (config.preprocDarkThreshold) document.getElementById('jobPreprocDarkThreshold').value = config.preprocDarkThreshold;
                if (config.preprocMarginInkRatio) document.getElementById('jobPreprocMarginInkRatio').value = config.preprocMarginInkRatio;
                if (config.preprocMarginShadow) document.getElementById('jobPreprocMarginShadow').value = config.preprocMarginShadow;
                if (config.preprocBgKernelRatio) document.getElementById('jobPreprocBgKernelRatio').value = config.preprocBgKernelRatio;
                if (config.preprocBgKernelMin) document.getElementById('jobPreprocBgKernelMin').value = config.preprocBgKernelMin;
                if (config.preprocBinarization !== undefined) document.getElementById('jobPreprocBinarization').checked = config.preprocBinarization;
                if (config.preprocSauvolaW) document.getElementById('jobPreprocSauvolaW').value = config.preprocSauvolaW;
                if (config.preprocSauvolaK) document.getElementById('jobPreprocSauvolaK').value = config.preprocSauvolaK;
                if (config.preprocSauvolaR) document.getElementById('jobPreprocSauvolaR').value = config.preprocSauvolaR;
                if (config.preprocTextMaskBlock) document.getElementById('jobPreprocTextMaskBlock').value = config.preprocTextMaskBlock;
                if (config.preprocTextMaskC) document.getElementById('jobPreprocTextMaskC').value = config.preprocTextMaskC;
                if (config.preprocTextMaskOpenK) document.getElementById('jobPreprocTextMaskOpenK').value = config.preprocTextMaskOpenK;
                if (config.preprocTextMaskCloseK) document.getElementById('jobPreprocTextMaskCloseK').value = config.preprocTextMaskCloseK;
                if (config.preprocTextMaskCloseI) document.getElementById('jobPreprocTextMaskCloseI').value = config.preprocTextMaskCloseI;
                if (config.preprocTextMaskDilateI) document.getElementById('jobPreprocTextMaskDilateI').value = config.preprocTextMaskDilateI;
                if (config.preprocTextMaskMinArea) document.getElementById('jobPreprocTextMaskMinArea').value = config.preprocTextMaskMinArea;
                if (config.preprocTrimBand) document.getElementById('jobPreprocTrimBand').value = config.preprocTrimBand;
                if (config.preprocTrimInk) document.getElementById('jobPreprocTrimInk').value = config.preprocTrimInk;
                if (config.preprocTrimMax) document.getElementById('jobPreprocTrimMax').value = config.preprocTrimMax;
                if (config.preprocTrimMinDim) document.getElementById('jobPreprocTrimMinDim').value = config.preprocTrimMinDim;

                // Advanced
                if (config.continueMode !== undefined) document.getElementById('jobContinueMode').checked = config.continueMode;
                if (config.proOnly !== undefined) document.getElementById('jobProOnly').checked = config.proOnly;
                if (config.cleanTemp !== undefined) document.getElementById('jobCleanTemp').checked = config.cleanTemp;
                if (config.debugArtifacts !== undefined) document.getElementById('jobDebugArtifacts').checked = config.debugArtifacts;
                if (config.captureVideo !== undefined) document.getElementById('jobCaptureVideo').checked = config.captureVideo;
                if (config.tracingMode) document.getElementById('jobTracingMode').value = config.tracingMode;
                if (config.authEnsure !== undefined) document.getElementById('jobAuthEnsure').checked = config.authEnsure;
                if (config.authEnsureInterval) document.getElementById('jobAuthEnsureInterval').value = config.authEnsureInterval;
                if (config.modelSwitchRetries) document.getElementById('jobModelSwitchRetries').value = config.modelSwitchRetries;
                if (config.modelSwitchCooldown) document.getElementById('jobModelSwitchCooldown').value = config.modelSwitchCooldown;
                if (config.limitCheckInterval) document.getElementById('jobLimitCheckInterval').value = config.limitCheckInterval;
                if (config.proPauseBuffer) document.getElementById('jobProPauseBuffer').value = config.proPauseBuffer;
                if (config.proFallbackPause) document.getElementById('jobProFallbackPause').value = config.proFallbackPause;
                if (config.browserId) document.getElementById('jobBrowserId').value = config.browserId;

                showToast('success', 'Wczytano', 'Konfiguracja została wczytana');
            } catch (e) {
                showToast('error', 'Błąd', 'Nie udało się wczytać konfiguracji');
            }
        }

        // ============================================
        // File Browser
        // ============================================

        let currentBrowserPath = '/';
        let browserTargetInput = null;

        function openFileBrowser(targetInputId = 'jobSourcePath') {
            browserTargetInput = targetInputId;
            document.getElementById('fileBrowserModal').classList.add('visible');
            loadFavorites();
            loadFolder(currentBrowserPath);
        }

        function closeFileBrowser() {
            document.getElementById('fileBrowserModal').classList.remove('visible');
        }

        async function loadFolder(path) {
            try {
                const response = await fetch(`/api/browse?path=${encodeURIComponent(path)}`);
                const data = await response.json();

                currentBrowserPath = data.current_path || path;
                document.getElementById('browserCurrentPath').value = currentBrowserPath;

                const fileList = document.getElementById('fileList');
                if (!data.items || data.items.length === 0) {
                    fileList.innerHTML = '<div class="text-center text-secondary" style="padding: var(--spacing-lg);">Folder pusty</div>';
                    return;
                }

                fileList.innerHTML = data.items.map(item => `
                    <div class="file-item ${item.is_dir ? 'folder' : 'file'}" 
                         ${item.is_dir ? `data-path="${escapeHtml(item.path)}" onclick="loadFolder(this.dataset.path)"` : ''}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            ${item.is_dir
                        ? '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>'
                        : '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>'
                    }
                        </svg>
                        <span>${escapeHtml(item.name)}</span>
                    </div>
                `).join('');
            } catch (e) {
                showToast('error', 'Błąd', 'Nie można załadować folderu');
            }
        }

        function browserGoUp() {
            const parts = currentBrowserPath.split('/').filter(p => p);
            parts.pop();
            loadFolder('/' + parts.join('/'));
        }

        function selectFolder() {
            if (browserTargetInput) {
                document.getElementById(browserTargetInput).value = currentBrowserPath;
            }
            closeFileBrowser();
        }

        async function loadFavorites() {
            try {
                const response = await fetch('/api/favorites');
                const data = await response.json();
                const list = document.getElementById('favoritesList');

                if (!data.favorites || data.favorites.length === 0) {
                    list.innerHTML = '<div class="text-secondary" style="font-size: 11px;">Brak ulubionych</div>';
                    return;
                }

                // Backend returns array of strings (paths), convert to display format
                list.innerHTML = data.favorites.map(favPath => {
                    // Extract folder name from path
                    const folderName = favPath.split('/').filter(p => p).pop() || favPath;
                    return `
                    <div class="favorite-item" data-path="${escapeHtml(favPath)}" onclick="loadFolder(this.dataset.path)" title="${escapeHtml(favPath)}">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        </svg>
                        <span style="font-size: 11px;">${escapeHtml(folderName)}</span>
                    </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to load favorites:', e);
            }
        }

        async function addToFavorites() {
            try {
                await fetch('/api/favorites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: currentBrowserPath })
                });
                showToast('success', 'Dodano', 'Folder dodany do ulubionych');
                loadFavorites();
            } catch (e) {
                showToast('error', 'Błąd', 'Nie można dodać do ulubionych');
            }
        }

        async function loadDefaultSourcePath() {
            try {
                const response = await fetch('/api/default-source-path');
                const data = await response.json();

                if (data.source_path) {
                    const input = document.getElementById('jobSourcePath');
                    if (input && !input.value) {  // Only set if empty
                        input.value = data.source_path;
                    }
                }
            } catch (e) {
                console.error('Failed to load default source path:', e);
            }
        }

        // ============================================
        // Limits Checker
        // ============================================

        function selectAllLimitProfiles() {
            document.querySelectorAll('.limit-profile-cb').forEach(cb => cb.checked = true);
        }

        function selectActiveLimitProfiles() {
            document.querySelectorAll('.limit-profile-cb').forEach(cb => {
                const profile = profilesData.find(p => p.name === cb.value);
                cb.checked = profile && profile.status === 'active';
            });
        }

        function selectPausedLimitProfiles() {
            document.querySelectorAll('.limit-profile-cb').forEach(cb => {
                const profile = profilesData.find(p => p.name === cb.value);
                cb.checked = profile && profile.status === 'paused';
            });
        }

        function clearLimitProfiles() {
            document.querySelectorAll('.limit-profile-cb').forEach(cb => cb.checked = false);
        }

        async function runLimitCheck() {
            const selectedProfiles = [...document.querySelectorAll('.limit-profile-cb:checked')].map(cb => cb.value);
            if (selectedProfiles.length === 0) {
                showToast('error', 'Błąd', 'Wybierz przynajmniej jeden profil');
                return;
            }

            const params = {
                profiles: selectedProfiles,
                quick: document.getElementById('limitQuickMode').checked,
                parallel: parseInt(document.getElementById('limitParallel').value) || 4,
                host: document.getElementById('limitHost').value
            };

            document.getElementById('limitRunBtn').disabled = true;
            document.getElementById('limitProgress').classList.remove('hidden');
            document.getElementById('limitProgressBar').style.width = '0%';
            document.getElementById('limitProgressText').textContent = 'Rozpoczynanie...';

            try {
                const response = await fetch('/api/limits/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });

                if (response.ok) {
                    const data = await response.json();

                    // Remote worker returns results immediately
                    if (data.status === 'completed' && data.results) {
                        document.getElementById('limitProgress').classList.add('hidden');
                        document.getElementById('limitRunBtn').disabled = false;

                        // Convert remote results to display format
                        const results = (data.results.results || []).map(r => ({
                            profile: r.profile,
                            ok: !r.limited && !r.error,
                            pro_remaining: r.pro_remaining || '-',
                            reset_time: r.reset_time || '-',
                            checked_at: new Date().toLocaleTimeString()
                        }));
                        updateLimitResults(results);
                        updateLimitStats(results);
                        showToast('success', 'Zakończono', `Sprawdzono ${results.length} profili`);
                    } else {
                        // Local process - need to poll
                        showToast('info', 'Uruchomiono', 'Sprawdzanie limitów rozpoczęte');
                        pollLimitStatus();
                    }
                } else {
                    const data = await response.json();
                    showToast('error', 'Błąd', data.detail || 'Nie udało się uruchomić');
                    document.getElementById('limitProgress').classList.add('hidden');
                    document.getElementById('limitRunBtn').disabled = false;
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
                document.getElementById('limitProgress').classList.add('hidden');
                document.getElementById('limitRunBtn').disabled = false;
            }
        }

        async function pollLimitStatus() {
            try {
                const response = await fetch(`/api/limits/status?session_start=${limitCheckSessionStart}`);
                const data = await response.json();

                if (data.running) {
                    // Still running - show progress
                    document.getElementById('limitProgressBar').style.width = '50%';
                    document.getElementById('limitProgressText').textContent = 'Sprawdzanie w toku...';
                    setTimeout(pollLimitStatus, 2000);
                } else {
                    document.getElementById('limitProgress').classList.add('hidden');
                    document.getElementById('limitRunBtn').disabled = false;

                    // Get results from status.results
                    const rawResults = data.status?.results || [];
                    const results = rawResults.map(r => ({
                        profile: r.profile,
                        ok: r.status === 'OK' || (r.status && !r.status.includes('LIMIT') && !r.status.includes('ERROR')),
                        pro_remaining: '-',
                        reset_time: r.status?.includes('LIMIT') ? r.status.replace('LIMIT until ', '') : '-',
                        checked_at: data.status?.run_at ? new Date(data.status.run_at).toLocaleTimeString() : '-'
                    }));

                    if (results.length > 0) {
                        updateLimitResults(results);
                        updateLimitStats(results);
                        showToast('success', 'Zakończono', `Sprawdzono ${results.length} profili`);
                    } else {
                        showToast('info', 'Zakończono', 'Brak nowych wyników');
                    }
                }
            } catch (e) {
                document.getElementById('limitProgress').classList.add('hidden');
                document.getElementById('limitRunBtn').disabled = false;
                showToast('error', 'Błąd', 'Nie udało się pobrać statusu');
            }
        }

        // Session start timestamp for limit checks
        let limitCheckSessionStart = Date.now();

        function updateLimitResults(results) {
            const tbody = document.getElementById('limitResultsBody');
            if (!results || results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-secondary" style="padding: var(--spacing-lg);">Brak wyników</td></tr>';
                return;
            }

            tbody.innerHTML = results.map(r => `
                <tr>
                    <td>${escapeHtml(r.profile)}</td>
                    <td><span class="badge badge-${r.ok ? 'success' : 'error'}">${r.ok ? 'OK' : 'LIMIT'}</span></td>
                    <td>${escapeHtml(r.pro_remaining || '-')}</td>
                    <td>${escapeHtml(r.reset_time || '-')}</td>
                    <td class="text-secondary">${escapeHtml(r.checked_at || '-')}</td>
                </tr>
            `).join('');

            document.getElementById('limitResultsTime').textContent = 'Zaktualizowano: ' + new Date().toLocaleTimeString();
        }

        function updateLimitStats(results) {
            if (!results || results.length === 0) return;

            const okCount = results.filter(r => r.ok).length;
            const limitCount = results.filter(r => !r.ok).length;

            document.getElementById('limitOkCount').textContent = okCount;
            document.getElementById('limitExceededCount').textContent = limitCount;
            document.getElementById('limitLastCheck').textContent = new Date().toLocaleTimeString();

            // Increment session runs
            const currentRuns = parseInt(document.getElementById('limitSessionRuns').textContent) || 0;
            document.getElementById('limitSessionRuns').textContent = currentRuns + 1;
        }

        // ============================================
        // Post-Processing
        // ============================================

        let postProcRunning = false;

        async function togglePostProcess() {
            const apiKey = document.getElementById('postProcApiKey').value;
            // Use the DSN from the main Job Config
            const dsn = document.getElementById('jobPgDsn').value;

            if (!postProcRunning) {
                if (!apiKey || !dsn) {
                    showToast('error', 'Błąd', 'Podaj API Key i upewnij się, że PostgreSQL DSN jest ustawiony w konfiguracji joba');
                    return;
                }

                try {
                    const response = await fetch('/api/postprocess/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ api_key: apiKey, dsn: dsn })
                    });

                    if (response.ok) {
                        postProcRunning = true;
                        document.getElementById('postProcToggleBtn').innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12"/></svg> Stop';
                        document.getElementById('postProcStatusBadge').textContent = 'RUNNING';
                        document.getElementById('postProcStatusBadge').className = 'badge badge-success';
                        showToast('success', 'Uruchomiono', 'Post-processing rozpoczęty');
                        pollPostProcStatus();
                    } else {
                        const data = await response.json();
                        showToast('error', 'Błąd', data.detail || 'Nie udało się uruchomić post-processingu');
                    }
                } catch (e) {
                    showToast('error', 'Błąd', e.message);
                }
            } else {
                try {
                    await fetch('/api/postprocess/stop', { method: 'POST' });
                    postProcRunning = false;
                    document.getElementById('postProcToggleBtn').innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg> Start';
                    document.getElementById('postProcStatusBadge').textContent = 'IDLE';
                    document.getElementById('postProcStatusBadge').className = 'badge badge-neutral';
                    showToast('info', 'Zatrzymano', 'Post-processing zatrzymany');
                } catch (e) {
                    showToast('error', 'Błąd', e.message);
                }
            }
        }

        async function pollPostProcStatus() {
            if (!postProcRunning) return;

            try {
                // Use DSN from main config
                const dsn = document.getElementById('jobPgDsn').value;
                const response = await fetch(`/api/postprocess/status?dsn=${encodeURIComponent(dsn)}`);
                const data = await response.json();

                document.getElementById('postProcNew').textContent = data.new_count || 0;
                document.getElementById('postProcDone').textContent = data.done_count || 0;

                const total = (data.new_count || 0) + (data.done_count || 0);
                const progress = total > 0 ? (data.done_count / total * 100) : 0;
                document.getElementById('postProcProgressBar').style.width = progress + '%';

                if (data.running) {
                    setTimeout(pollPostProcStatus, 2000);
                } else {
                    postProcRunning = false;
                    document.getElementById('postProcToggleBtn').innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg> Start';
                    document.getElementById('postProcStatusBadge').textContent = 'IDLE';
                    document.getElementById('postProcStatusBadge').className = 'badge badge-neutral';
                }
            } catch (e) {
                console.error('Post-proc status error:', e);
            }
        }

        async function migratePostProcess() {
            // Use DSN from main config
            const dsn = document.getElementById('jobPgDsn').value;
            if (!dsn) {
                showToast('error', 'Błąd', 'Brak DSN w konfiguracji joba');
                return;
            }

            try {
                const response = await fetch('/api/postprocess/migrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dsn: dsn })
                });

                if (response.ok) {
                    showToast('success', 'Sukces', 'Tabele utworzone pomyślnie');
                } else {
                    const data = await response.json();
                    showToast('error', 'Błąd', data.detail || 'Migracja nie powiodła się');
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        // ============================================
        // Settings
        // ============================================

        async function toggleAutoRestart() {
            const enabled = document.getElementById('autoRestartEnabled').checked;
            try {
                await fetch('/api/autorestart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: enabled })
                });
                showToast('info', 'Zapisano', `Auto-restart ${enabled ? 'włączony' : 'wyłączony'}`);
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        async function runCleanup() {
            const targets = [];
            if (document.getElementById('cleanupJobs').checked) targets.push('jobs');
            if (document.getElementById('cleanupLogs').checked) targets.push('logs');
            if (document.getElementById('cleanupArtifacts').checked) targets.push('artifacts');
            if (document.getElementById('cleanupTestResults').checked) targets.push('test-results');
            if (document.getElementById('cleanupPycache').checked) targets.push('__pycache__');

            if (targets.length === 0) {
                showToast('error', 'Błąd', 'Wybierz co najmniej jeden folder');
                return;
            }

            try {
                const response = await fetch('/api/cleanup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targets: targets })
                });

                const data = await response.json();
                document.getElementById('cleanupStatus').textContent = `Usunięto: ${data.removed || 0} plików`;
                showToast('success', 'Wyczyszczono', `Usunięto ${data.removed || 0} plików`);
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        async function createProfile() {
            const name = document.getElementById('newProfileName').value.trim();
            if (!name) {
                showToast('error', 'Błąd', 'Podaj nazwę profilu');
                return;
            }

            try {
                const response = await fetch('/api/profiles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });

                if (response.ok) {
                    showToast('success', 'Utworzono', `Profil ${name} został utworzony`);
                    document.getElementById('newProfileName').value = '';
                    location.reload();
                } else {
                    const data = await response.json();
                    showToast('error', 'Błąd', data.detail || 'Nie można utworzyć profilu');
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        async function syncProfiles() {
            showToast('info', 'Synchronizacja...', 'Synchronizowanie profili');
            try {
                const response = await fetch('/api/profiles/sync', { method: 'POST' });
                if (response.ok) {
                    showToast('success', 'Zsynchronizowano', 'Profile zostały zsynchronizowane');
                    location.reload();
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        async function restartApp() {
            if (!confirm('Czy na pewno chcesz zrestartować aplikację?')) return;

            showToast('info', 'Restartowanie...', 'Aplikacja jest restartowana');
            try {
                await fetch('/api/restart', { method: 'POST' });
                setTimeout(() => location.reload(), 3000);
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        // ============================================
        // X11 Display Settings
        // ============================================

        async function loadX11Display() {
            try {
                const response = await fetch('/api/settings/x11-display');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('x11Display').value = data.display || '';
                }
            } catch (e) {
                console.error('Failed to load X11 display setting:', e);
            }
        }

        async function saveX11Display() {
            const display = document.getElementById('x11Display').value.trim();
            try {
                const response = await fetch('/api/settings/x11-display', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ display: display })
                });
                if (response.ok) {
                    showToast('success', 'Zapisano', 'Ustawienie DISPLAY zostało zapisane');
                    document.getElementById('x11DisplayStatus').textContent = `Aktualnie: ${display || '(nie ustawiono)'}`;
                } else {
                    const data = await response.json();
                    showToast('error', 'Błąd', data.detail || 'Nie można zapisać');
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        // ============================================
        // Profile Actions (Login, Delete)
        // ============================================

        let loginLogInterval = null;

        async function loginProfile(profileName) {
            showToast('info', 'Logowanie...', `Otwieranie logowania dla ${profileName}`);

            // Open Modal
            document.getElementById('loginLogProfileName').textContent = profileName;
            const logContent = document.getElementById('loginLogContent');
            logContent.textContent = "Inicjalizacja procesu logowania...\nOczekiwanie na uruchomienie procesu...";
            document.getElementById('loginLogModal').classList.add('visible');

            // Start polling logs immediately
            if (loginLogInterval) clearInterval(loginLogInterval);
            loginLogInterval = setInterval(() => fetchLoginLog(profileName), 1000);

            try {
                const response = await fetch('/api/profiles/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: profileName })
                });

                if (response.ok) {
                    showToast('success', 'Uruchomiono', 'Proces logowania wystartował');
                } else {
                    const data = await response.json();
                    showToast('error', 'Błąd', data.detail || 'Nie można uruchomić procesu logowania');
                    logContent.textContent += `\n\n[BŁĄD API]: ${data.detail}`;
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
                logContent.textContent += `\n\n[BŁĄD SIECI]: ${e.message}`;
            }
        }

        async function fetchLoginLog(profileName) {
            try {
                const res = await fetch(`/api/profiles/login/log?name=${profileName}&tail=200`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.log) {
                        const el = document.getElementById('loginLogContent');
                        // Only update/scroll if content changed substantially or first load
                        if (el.textContent.length !== data.log.length) {
                            el.textContent = data.log;
                            el.scrollTop = el.scrollHeight;
                        }
                    }
                }
            } catch (e) {
                console.warn("Failed to poll login log", e);
            }
        }

        function closeLoginLogModal() {
            document.getElementById('loginLogModal').classList.remove('visible');
            if (loginLogInterval) {
                clearInterval(loginLogInterval);
                loginLogInterval = null;
            }
        }

        let profileToDelete = null;

        function deleteProfileConfirm(profileName) {
            profileToDelete = profileName;
            document.getElementById('deleteProfileName').textContent = profileName;
            document.getElementById('deleteModal').classList.add('visible');
        }

        function closeDeleteModal() {
            profileToDelete = null;
            document.getElementById('deleteModal').classList.remove('visible');
        }

        async function confirmDeleteProfile() {
            if (!profileToDelete) return;

            try {
                const response = await fetch(`/api/profiles/${profileToDelete}`, { method: 'DELETE' });
                if (response.ok) {
                    showToast('success', 'Usunięto', `Profil ${profileToDelete} został usunięty`);
                    closeDeleteModal();
                    location.reload();
                } else {
                    const data = await response.json();
                    showToast('error', 'Błąd', data.detail || 'Nie można usunąć profilu');
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        // ============================================
        // Session Expired Banner
        // ============================================

        function hideSessionBanner() {
            document.getElementById('sessionExpiredBanner').classList.add('hidden');
        }

        function showSessionExpired(profiles) {
            if (profiles && profiles.length > 0) {
                document.getElementById('expiredProfilesList').textContent = profiles.join(', ');
                document.getElementById('sessionExpiredBanner').classList.remove('hidden');
            }
        }

        // ============================================
        // Load Auto-Restart State
        // ============================================

        async function loadAutoRestartState() {
            try {
                const response = await fetch('/api/autorestart');
                const data = await response.json();
                document.getElementById('autoRestartEnabled').checked = data.enabled || false;
            } catch (e) {
                console.error('Failed to load auto-restart state:', e);
            }
        }

        // ============================================
        // Live Preview
        // ============================================

        let previewAutoRefreshInterval = null;

        async function refreshLivePreviewAll() {
            const btn = document.getElementById('previewRefreshBtn');
            btn.disabled = true;

            try {
                const response = await fetch('/api/live-preview');
                const data = await response.json();

                const grid = document.getElementById('livePreviewGrid');
                const emptyState = document.getElementById('previewEmptyState');

                if (!data.previews || data.previews.length === 0) {
                    grid.innerHTML = '';
                    grid.appendChild(emptyState);
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                grid.innerHTML = data.previews.map(p => `
                    <div class="preview-card">
                        <div class="preview-header">
                            <span class="preview-profile">${escapeHtml(p.profile)}</span>
                            <span class="badge badge-${p.status === 'active' ? 'success' : 'neutral'}">${escapeHtml(p.status)}</span>
                        </div>
                        <div class="preview-image-container" onclick="openImagePreview(this.dataset.url, this.dataset.profile)" data-url="${escapeHtml(p.image_url)}" data-profile="${escapeHtml(p.profile)}">
                            <img src="${escapeHtml(p.image_url)}?t=${Date.now()}" alt="${escapeHtml(p.profile)}" class="preview-image" onerror="this.src='/static/placeholder.png'">
                        </div>
                        <div class="preview-footer">
                            <span class="text-secondary" style="font-size: 11px;">${escapeHtml(p.updated_at || '-')}</span>
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                console.error('Failed to refresh live preview:', e);
            } finally {
                btn.disabled = false;
            }
        }

        function togglePreviewAutoRefresh() {
            const enabled = document.getElementById('previewAutoRefresh').checked;
            if (enabled) {
                refreshLivePreviewAll();
                previewAutoRefreshInterval = setInterval(refreshLivePreviewAll, 10000);
            } else {
                if (previewAutoRefreshInterval) {
                    clearInterval(previewAutoRefreshInterval);
                    previewAutoRefreshInterval = null;
                }
            }
        }

        function openImagePreview(url, profile) {
            document.getElementById('imagePreviewImg').src = url;
            document.getElementById('imagePreviewInfo').textContent = profile;
            document.getElementById('imagePreviewModal').classList.add('visible');
        }

        function closeImagePreview() {
            document.getElementById('imagePreviewModal').classList.remove('visible');
        }

        // ============================================
        // Cleanup Modal
        // ============================================

        function openCleanupModal() {
            document.getElementById('cleanupModal').classList.add('visible');
            document.getElementById('cleanupStatus').textContent = '';
        }

        function closeCleanupModal() {
            document.getElementById('cleanupModal').classList.remove('visible');
        }

        async function executeCleanup() {
            const btn = document.getElementById('cleanupExecuteBtn');
            const status = document.getElementById('cleanupStatus');
            btn.disabled = true;
            status.textContent = 'Czyszczenie...';

            const targets = [];
            if (document.getElementById('cleanupJobs').checked) targets.push('jobs');
            if (document.getElementById('cleanupLogs').checked) targets.push('logs');
            if (document.getElementById('cleanupArtifacts').checked) targets.push('artifacts');
            if (document.getElementById('cleanupTestResults').checked) targets.push('test-results');
            if (document.getElementById('cleanupPycache').checked) targets.push('pycache');

            const force = document.getElementById('cleanupForce').checked;

            try {
                const response = await fetch('/api/cleanup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targets, force })
                });

                const data = await response.json();
                if (response.ok) {
                    status.textContent = `Wyczyszczono: ${data.cleaned?.join(', ') || 'brak'}`;
                    showToast('success', 'Wyczyszczono', 'Foldery zostały wyczyszczone');
                    setTimeout(closeCleanupModal, 1500);
                } else {
                    status.textContent = data.detail || 'Błąd';
                    showToast('error', 'Błąd', data.detail || 'Nie udało się wyczyścić');
                }
            } catch (e) {
                status.textContent = e.message;
                showToast('error', 'Błąd', e.message);
            } finally {
                btn.disabled = false;
            }
        }

        // ============================================
        // Restart App
        // ============================================

        function restartAppConfirm() {
            document.getElementById('restartModal').classList.add('visible');
        }

        function closeRestartModal() {
            document.getElementById('restartModal').classList.remove('visible');
        }

        async function confirmRestartApp() {
            closeRestartModal();
            showToast('info', 'Restartowanie', 'Aplikacja jest restartowana...');

            try {
                await fetch('/api/restart', { method: 'POST' });
                // Wait and reload
                setTimeout(() => {
                    location.reload();
                }, 3000);
            } catch (e) {
                // Expected - server restarts
                setTimeout(() => {
                    location.reload();
                }, 3000);
            }
        }

        // ============================================
        // Add Profile Modal
        // ============================================

        function openAddProfileModal() {
            document.getElementById('newProfileName').value = '';
            document.getElementById('addProfileModal').classList.add('visible');
        }

        function closeAddProfileModal() {
            document.getElementById('addProfileModal').classList.remove('visible');
        }

        async function confirmAddProfile() {
            const name = document.getElementById('newProfileName').value.trim();
            if (!name) {
                showToast('error', 'Błąd', 'Podaj nazwę profilu');
                return;
            }

            try {
                const response = await fetch('/api/profiles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                if (response.ok) {
                    showToast('success', 'Dodano', `Profil ${name} został utworzony`);
                    closeAddProfileModal();
                    location.reload();
                } else {
                    const data = await response.json();
                    showToast('error', 'Błąd', data.detail || 'Nie można dodać profilu');
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        // ============================================
        // Non-Pro Banner
        // ============================================

        function hideNonProBanner() {
            document.getElementById('nonProBanner').classList.add('hidden');
        }

        function showNonProBanner(count, profiles) {
            if (count > 0) {
                document.getElementById('nonProCount').textContent = count;
                document.getElementById('nonProProfiles').textContent = profiles.join(', ');
                document.getElementById('nonProBanner').classList.remove('hidden');
            }
        }

        // ============================================
        // Sort Profiles
        // ============================================

        function sortJobProfiles(direction) {
            const container = document.getElementById('jobProfilesList');
            const labels = Array.from(container.querySelectorAll('label'));
            labels.sort((a, b) => {
                const nameA = a.querySelector('input').value.toLowerCase();
                const nameB = b.querySelector('input').value.toLowerCase();
                return direction === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
            });
            labels.forEach(label => container.appendChild(label));
        }

        // ============================================
        // Select OK Limit Profiles
        // ============================================

        async function selectOkLimitJobProfiles() {
            try {
                const response = await fetch('/api/limits/status');
                const data = await response.json();
                const okProfiles = new Set();

                // Get profiles with OK status from last check
                if (data.status?.results) {
                    data.status.results.forEach(r => {
                        if (r.status === 'OK') {
                            okProfiles.add(r.profile);
                        }
                    });
                }

                // Also check last_any for profiles without limit
                if (data.last_any) {
                    Object.entries(data.last_any).forEach(([profile, info]) => {
                        if (info.status === 'OK') {
                            okProfiles.add(profile);
                        }
                    });
                }

                document.querySelectorAll('#jobProfilesList input[type="checkbox"]').forEach(cb => {
                    cb.checked = okProfiles.has(cb.value);
                });

                showToast('info', 'Wybrano', `Zaznaczono ${okProfiles.size} profili z OK`);
            } catch (e) {
                showToast('error', 'Błąd', 'Nie można pobrać statusu limitów');
            }
        }

        // Add to DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize language
            currentLang = localStorage.getItem('ocr-dashboard-lang') || 'pl';
            document.documentElement.lang = currentLang;
            applyTranslations();
            updateLanguageButtons();

            loadAutoRestartState();
            loadX11Display();

            // Load preview when switching to preview tab
            document.querySelector('[data-tab="preview"]')?.addEventListener('click', () => {
                setTimeout(refreshLivePreviewAll, 100);
            });
        });

        // Add spin animation for refresh icon
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>